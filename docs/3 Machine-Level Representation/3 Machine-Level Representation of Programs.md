# 3 Machine-Level Representation of Programs

## ç›®å½•

-   [è‹±è¯­](#è‹±è¯­)
-   [3.1 A Historical Perspective](#31-A-Historical-Perspective)
-   [3.2 Program Encodings](#32-Program-Encodings)
    -   [3.2.1 Machine-Level Code](#321-Machine-Level-Code)
    -   [3.2.2 Code Examples](#322-Code-Examples)
        -   [åæ±‡ç¼–å™¨ disassembler](#åæ±‡ç¼–å™¨-disassembler)
        -   [é“¾æ¥mainæ–‡ä»¶](#é“¾æ¥mainæ–‡ä»¶)
        -   [é“¾æ¥ååæ±‡ç¼–ä¸ç¼–è¯‘ååæ±‡ç¼–çš„å¯¹æ¯”](#é“¾æ¥ååæ±‡ç¼–ä¸ç¼–è¯‘ååæ±‡ç¼–çš„å¯¹æ¯”)
    -   [3.2.3 Notes on Formatting](#323-Notes-on-Formatting)
-   [3.3 Data Formats](#33-Data-Formats)
-   [3.4 Accessing Information](#34-Accessing-Information)
    -   [3.4.1 Operand Specifiers](#341-Operand-Specifiers)
    -   [3.4.2 Data Movement Instructions](#342-Data-Movement-Instructions)
        -   [MOVç±»](#MOVç±»)
        -   [MOVZã€MOVS](#MOVZMOVS)
    -   [3.4.3 Data Movement Example](#343-Data-Movement-Example)
    -   [3.4.4 Pushing and Popping Stack Data %rsp](#344-Pushing-and-Popping-Stack-Data-rsp)
-   [3.5 Arithmetic and Logical Operations](#35-Arithmetic-and-Logical-Operations)
    -   [3.5.1 Load Effective Address](#351-Load-Effective-Address)
    -   [3.5.2 Unary and Binary Operations](#352-Unary-and-Binary-Operations)
        -   [3.5.2.1 Unary Operations](#3521-Unary-Operations)
        -   [3.5.2.2 Binary Operations](#3522-Binary-Operations)
    -   [3.5.3 Shift Operations](#353-Shift-Operations)
    -   [3.5.4 Special Arithmetic Operations](#354-Special-Arithmetic-Operations)
        -   [MUL](#MUL)
        -   [DIV](#DIV)
-   [3.6 Control](#36-Control)
    -   [3.6.1 Conditions Codes](#361-Conditions-Codes)
    -   [3.6.2 Accessing the Condition Codes](#362-Accessing-the-Condition-Codes)
    -   [3.6.3 Jump Instructions](#363-Jump-Instructions)
    -   [3.6.4 Jump Instruction Encodings](#364-Jump-Instruction-Encodings)
    -   [3.6.5 Implementing Conditional Branches with Conditional Control](#365-Implementing-Conditional-Branches-with-Conditional-Control)
    -   [3.6.6 Implementing Conditional Branches with Conditional Moves](#366-Implementing-Conditional-Branches-with-Conditional-Moves)
        -   [ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ¡ä»¶ä¼ é€](#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ¡ä»¶ä¼ é€)
        -   [æ¡ä»¶ä¼ é€æŒ‡ä»¤cmovç±»](#æ¡ä»¶ä¼ é€æŒ‡ä»¤cmovç±»)
        -   [æ¡ä»¶ä¼ é€ç†è§£](#æ¡ä»¶ä¼ é€ç†è§£)
            -   [æ¡ä»¶ä¼ é€çš„ç¼ºç‚¹](#æ¡ä»¶ä¼ é€çš„ç¼ºç‚¹)
    -   [3.6.7 Loops](#367-Loops)
        -   [Do-While Loops](#Do-While-Loops)
        -   [While Loops](#While-Loops)
        -   [For Loops](#For-Loops)
    -   [3.6.8 Switch Statements](#368-Switch-Statements)
-   [3.7 Procedures](#37-Procedures)
    -   [3.7.1 The Run-Time Stack](#371-The-Run-Time-Stack)
        -   [æ ˆåŸºç¡€](#æ ˆåŸºç¡€)
        -   [æ ˆç»“æ„](#æ ˆç»“æ„)
    -   [3.7.2 Control Transfer](#372-Control-Transfer)
    -   [3.7.3 Data Transfer](#373-Data-Transfer)
    -   [3.7.4 Local Storage on the Stack](#374-Local-Storage-on-the-Stack)
    -   [3.7.5 Local Storage in Registers](#375-Local-Storage-in-Registers)
    -   [3.7.6 Recursive Procedures](#376-Recursive-Procedures)
-   [3.8 Array Allocation and Access](#38-Array-Allocation-and-Access)
    -   [3.8.1 Basic Principles](#381-Basic-Principles)
    -   [3.8.2 Pointer Arithmetic](#382-Pointer-Arithmetic)
    -   [3.8.3 Nested Arrays](#383-Nested-Arrays)
    -   [3.8.4 Fixed-Size Arrays](#384-Fixed-Size-Arrays)
    -   [3.8.5 Variable-Size Arrays](#385-Variable-Size-Arrays)
-   [3.9 Heterogeneous Data Structures](#39-Heterogeneous-Data-Structures)
    -   [3.9.1 Structures](#391-Structures)
    -   [3.9.2 Unions](#392-Unions)
        -   [è”åˆçš„åº”ç”¨](#è”åˆçš„åº”ç”¨)
    -   [3.9.3 Data Alignment](#393-Data-Alignment)
-   [3.10 Combining Control and Data in Machine-Level Programs](#310-Combining-Control-and-Data-in-Machine-Level-Programs)
    -   [3.10.1 Understanding Pointers](#3101-Understanding-Pointers)
    -   [3.10.2 Out-of-Bounds Memory References and Buffer Overflow](#3102-Out-of-Bounds-Memory-References-and-Buffer-Overflow)
    -   [3.10.3 Thwarting Buffer Overflow Attacks](#3103-Thwarting-Buffer-Overflow-Attacks)
        -   [å †æ ˆéšæœºåŒ–](#å †æ ˆéšæœºåŒ–)
        -   [å †æ ˆæŸåæ£€æµ‹](#å †æ ˆæŸåæ£€æµ‹)
        -   [é™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸ](#é™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸ)
    -   [3.10.4 Supporting Variable-Size Stack Frames](#3104-Supporting-Variable-Size-Stack-Frames)
-   [3.11 Floating-Point Code](#311-Floating-Point-Code)
    -   [3.11.1 Floating-Point Movement and Conversion Operations](#3111-Floating-Point-Movement-and-Conversion-Operations)
        -   [æµ®ç‚¹æ•°ä¼ é€æŒ‡ä»¤](#æµ®ç‚¹æ•°ä¼ é€æŒ‡ä»¤)
        -   [æµ®ç‚¹æ•°è½¬æ•´æ•°æŒ‡ä»¤](#æµ®ç‚¹æ•°è½¬æ•´æ•°æŒ‡ä»¤)
        -   [æ•´æ•°è½¬æµ®ç‚¹æ•°æŒ‡ä»¤](#æ•´æ•°è½¬æµ®ç‚¹æ•°æŒ‡ä»¤)
        -   [å•ç²¾åº¦ä¸åŒç²¾åº¦æµ®ç‚¹æ•°ä¹‹é—´çš„è½¬æ¢](#å•ç²¾åº¦ä¸åŒç²¾åº¦æµ®ç‚¹æ•°ä¹‹é—´çš„è½¬æ¢)
    -   [3.11.2 Floating-Point Code in Procedures](#3112-Floating-Point-Code-in-Procedures)
    -   [3.11.3 Floating-Point Arithmetic Operations](#3113-Floating-Point-Arithmetic-Operations)
    -   [3.11.4 Defining and Using Floating-Point Constants](#3114-Defining-and-Using-Floating-Point-Constants)
    -   [3.11.5 Using Bitwise Operations in Floating-Point Code](#3115-Using-Bitwise-Operations-in-Floating-Point-Code)
    -   [3.11.6 Floating-Point Comparison Operations](#3116-Floating-Point-Comparison-Operations)

# è‹±è¯­

1.  shieldå±è”½
2.  referenceå¼•ç”¨
3.  consistentä¸€è‡´çš„
4.  inefficiencyä½æ•ˆç‡
5.  malwareæ¶æ„è½¯ä»¶
6.  involveæ¶‰åŠã€è°ƒç”¨
7.  therebyä»è€Œ
8.  recursiveå¾ªç¯çš„ï¼Œiterativeè¿­ä»£çš„
9.  delude oneselfè‡ªæ¬ºæ¬ºäºº
10. arcaneç¥ç§˜çš„
11. feasibleå¯è¡Œçš„

    economically feasible and technically desirableç»æµå¯è¡Œã€æŠ€æœ¯å¯å®ç°
12. compromiseå¦¥å
13. safeguardsä¿éšœæªæ–½ã€‘
14. elementaryåŸºæœ¬çš„
15. aggregateèšåˆçš„
16. guildelineæŒ‡å¯¼æ–¹é’ˆ
17. strip awayå‰¥å»
18. annotatedå¸¦è§£é‡Šçš„
19. ambiguityæ­§ä¹‰
20. owing toç”±äº
21. imposeæå‡º
22. excerptæ‘˜å½•
23. successiveè¿ç»­çš„
24. conciseç®€æ´çš„
25. invocationè°ƒç”¨
26. assureç¡®ä¿
27. circumventè§„é¿
28. complexitieså¤æ‚æ€§

<!---->

1.  specifyæŒ‡å®š
2.  manipulateæ“ä½œ
3.  underlyingæ½œåœ¨çš„
4.  get a sense ofæ„Ÿè§‰åˆ°
5.  infestä¾µæ‰°
6.  nuanceç»†å¾®å·®åˆ«
7.  eliminateæ¶ˆé™¤
8.  prerequisiteå…ˆå†³æ¡ä»¶
9.  corporationå…¬å¸
10. proceedç»§ç»­å‰è¿›
11. legacyé—äº§
12. colloquiallyé€šä¿—åœ°è®²
13. overallæœ€åˆçš„
14. elaborateå¤æ‚çš„
15. dictatedè¢«â€¦â€¦åˆ¶å®šçš„
16. whereasè™½ç„¶
17. ever-changingä¸æ–­æ”¹å˜çš„
18. indentedç¼©è¿›çš„
19. explanatoryè§£é‡Šæ€§çš„
20. dedicatedä¸“é—¨çš„
21. enthusiastsçˆ±å¥½è€…
22. compactæœ€ç´§å‡‘çš„
23. reminiscentä»¤äººæ€€å¿µçš„
24. outperformä¼˜äº
25. adjacentlé‚»è¿‘çš„
26. overheadå¼€é”€
27. successiveè¿ç»­çš„
28. noviceæ–°æ‰‹
29. pervasiveæ™®éçš„

> ğŸ³*Best of all, a program written in a high-level language can be compiled and executed on a number of different machines, whereas assembly code is highly machine specific.*
>
> *When programming in a hign-level language such as C,and even more so in Java,we are shielded from the detailed machine-level implementation of our program*.*In contrast, when writing programs in assembly code (as was done in the early days of computing) a programmer must specify the low-level instructions the program uses to carry out a computation.*

# 3.1 *A Historical Perspective*

> æ‘©å°”å®šå¾‹
>
> é¢„æµ‹èŠ¯ç‰‡ä¸Šçš„æ™¶ä½“ç®¡æ•°é‡æ¯ä¸€å¹´åŠç¿»ä¸€ç•ª

# 3.2 *Program Encodings*

å‡è®¾æœ‰ä¸¤ä¸ªCè¯­è¨€æ–‡ä»¶ï¼šp1.cå’Œp2.cï¼Œç„¶åä½¿ç”¨gccå‘½ä»¤è¡Œè¿›è¡Œç¼–è¯‘ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶

`gcc -0g -o p p1.c p2.c`

å‘½ä»¤gccè¡¨ç¤ºä½¿ç”¨gccè¿™ç§Cç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘ï¼Œè€Œä¸”å› ä¸ºLinuxä¸Šçš„é»˜è®¤Cç¼–è¯‘å™¨å°±æ˜¯gccæ‰€ä»¥ä¹Ÿå¯ä»¥ç®€å•åœ°ä½¿ç”¨ccè¿›è¡Œè°ƒç”¨

-0gè¡¨ç¤ºä½¿ç”¨ä¸€ç§ä¼˜åŒ–æ–¹å¼ï¼Œäº§ç”Ÿä¸€ç§éµå®ˆæœ€åˆçš„åŸå§‹Cä»£ç çš„æœºå™¨ä»£ç ã€‚

ä¸ºä»€ä¹ˆé€‰æ‹©-0gæ˜¯å› ä¸ºä½¿ç”¨æ›´é«˜çº§åˆ«çš„ä¼˜åŒ–å°†ä¼šç”Ÿæˆç»è¿‡å¤§é‡è½¬æ¢çš„ä»£ç ï¼Œä»¥è‡´äºç”Ÿæˆçš„æœºå™¨ä»£ç å’ŒåŸå§‹æºä»£ç ä¹‹é—´çš„å…³ç³»éš¾ä»¥ç†è§£ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨`  -0g  `ä¼˜åŒ–ä½œä¸ºå­¦ä¹ å·¥å…·ï¼Œç„¶åçœ‹çœ‹å½“æˆ‘ä»¬æé«˜ä¼˜åŒ–çº§åˆ«æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ

ä½†æ˜¯åœ¨å®è·µä¸­ï¼Œä¸€èˆ¬æ˜¯ä½¿ç”¨æ›´é«˜çº§åˆ«çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚-01ï¼Œ-02

å’Œä¹‹å‰æåˆ°çš„ç¼–è¯‘ç³»ç»Ÿä¸€è‡´ï¼Œgccå‘½ä»¤ç»è¿‡â€œ**é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥**â€å››æ­¥æ¥äº§ç”Ÿæœ€ç»ˆçš„å¯æ‰§è¡Œç¨‹åº

é¢„å¤„ç†ï¼šæ‰©å±•æºä»£ç ä¸­çš„`#include`æ‰€å¼•å…¥çš„æ–‡ä»¶å’Œ`#define`æ‰€å®šä¹‰çš„å®ï¼Œ.câ†’.i

ç¼–è¯‘ï¼šå°†ä¿®æ”¹åçš„Cæ–‡ä»¶.iä½¿ç”¨ç¼–è¯‘å™¨ç”Ÿæˆæ±‡ç¼–æ–‡ä»¶p1.så’Œp2.s

æ±‡ç¼–ï¼šä½¿ç”¨æ±‡ç¼–å™¨å°†æ±‡ç¼–æ–‡ä»¶è½¬æ¢ä¸ºäºŒè¿›åˆ¶å¯é‡å®šå‘æ–‡ä»¶

å¯é‡å®šå‘æ–‡ä»¶æ˜¯æœºå™¨ä»£ç çš„ä¸€è‡´å½¢å¼ï¼Œå®ƒåŒ…å«ç€æ‰€æœ‰æŒ‡ä»¤çš„äºŒè¿›åˆ¶å½¢å¼ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å¡«å……å…¨å±€å˜é‡çš„åœ°å€

é“¾æ¥ï¼šå°†å¤šä¸ªå¯é‡å®šå‘æ–‡ä»¶p1.oå’Œp2.oä»¥åŠæ‰€è°ƒç”¨çš„åº“å‡½æ•°åŠŸèƒ½é‡å®šå‘æ–‡ä»¶åˆå¹¶å¹¶ç”Ÿæˆæœ€åçš„å¯æ‰§è¡Œæ–‡ä»¶p(-o p)

å¯æ‰§è¡Œæ–‡ä»¶æ˜¯æœºå™¨ä»£ç çš„ç¬¬äºŒç§å½¢å¼ï¼Œæ˜¯å¤„ç†å™¨æ‰§è¡Œçš„ä»£ç çš„ç¡®åˆ‡å½¢å¼ã€‚

## 3.2.1\* Machine-Level Code\*

å’Œ1.9.3æ‰€æè¿°çš„ç±»ä¼¼ï¼Œè®¡ç®—æœºç³»ç»Ÿé‡‡ç”¨å‡ ç§ä¸åŒå½¢å¼çš„æŠ½è±¡[^æ³¨é‡Š1]ï¼Œé€šè¿‡ä½¿ç”¨æ›´ç®€å•çš„æŠ½è±¡æ¨¡å‹æ¥éšè—å®ç°çš„ç»†èŠ‚

å¯¹äºæœºå™¨çº§ç¼–ç¨‹è€Œè¨€ï¼Œè¿™äº›æŠ½è±¡å±‚æ¬¡ä¸­æœ‰ä¸¤ä¸ªæ˜¯æ¯”è¾ƒé‡è¦çš„

1.  æŒ‡ä»¤é›†ä½“ç³»ç»“æ„ISAï¼šå®šä¹‰äº†å¤„ç†å™¨çš„çŠ¶æ€ï¼ŒæŒ‡ä»¤æ ¼å¼ä»¥åŠæ¯æ¡æŒ‡ä»¤å¯¹çŠ¶æ€çš„å½±å“ã€‚å¤§å¤šæ•°ISAå®šä¹‰äº†ç¨‹åºçš„æŒ‡ä»¤åºåˆ—æ˜¯ä¸²è¡Œæ‰§è¡Œçš„
2.  è™šæ‹Ÿå­˜å‚¨ï¼šæä¾›äº†ä¸€ä¸ªéå¸¸å¤§çš„å­—èŠ‚æ•°ç»„çš„å­˜å‚¨æ¨¡å‹

    å­˜å‚¨å™¨ç³»ç»Ÿçš„å®é™…å®ç°æ˜¯å°†å¤šä¸ªç¡¬ä»¶å­˜å‚¨å™¨å’Œæ“ä½œç³»ç»Ÿè½¯ä»¶ç»„åˆèµ·æ¥

x86-64æœºå™¨ä»£ç å’ŒCè¯­è¨€åŸå§‹ä»£ç å·®åˆ«å¾ˆå¤§ï¼Œä¸€äº›å¯¹äºCç¨‹åºå‘˜æ¥è¯´ä¸å¯è§çš„å¤„ç†å™¨çŠ¶æ€å¯¹äºx86-64æœºå™¨ä»£ç æ¥è¯´æ˜¯å¯è§çš„

1.  PCï¼šç¨‹åºè®¡æ•°å™¨ï¼Œ**åœ¨x86-64ä¸­æ ‡è¯†ä¸º****%rip** **ï¼Œå…¶ä¸­å­˜å‚¨ç€ä¸‹ä¸€æ¡è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€**â€‹
2.  **æ•´æ•°å¯„å­˜å™¨æ–‡ä»¶åŒ…å«ç€å­˜å‚¨ç€64ä½å€¼çš„16ä¸ªå‘½åä½ç½®**[^æ³¨é‡Š2]
3.  **æ¡ä»¶ç å¯„å­˜å™¨ä¿å­˜ç€æœ€è¿‘æ‰§è¡Œçš„ç®—æœ¯æˆ–è€…é€»è¾‘æŒ‡ä»¤çš„çŠ¶æ€ä¿¡æ¯**
4.  ä¸€ç»„å‘é‡å¯„å­˜å™¨å¯ä»¥å­˜æ”¾ä¸€ä¸ªæˆ–å¤šä¸ªæ•´æ•°æˆ–æµ®ç‚¹æ•°å€¼

è™½ç„¶Cè¯­è¨€æä¾›äº†ä¸€ç§æ¨¡å‹ï¼Œå¯ä»¥åœ¨å†…å­˜ä¸­å£°æ˜å’Œåˆ†é…å„ç§æ•°æ®ç±»å‹çš„å¯¹è±¡ï¼Œä½†æ˜¯æœºå™¨ä»£ç åªæ˜¯ç®€å•åœ°å°†å†…å­˜çœ‹æˆä¸€ä¸ªå¾ˆå¤§çš„ã€æŒ‰å­—èŠ‚å¯»å€çš„æ•°ç»„ã€‚Cè¯­è¨€ä¸­çš„èšåˆæ•°æ®ç±»å‹ï¼Œä¾‹å¦‚æ•°ç»„å’Œç»“æ„ï¼Œåœ¨æœºå™¨ä»£ç ä¸­ç”¨ä¸€ç»„è¿ç»­çš„å­—èŠ‚æ¥è¡¨ç¤ºã€‚å³ä½¿æ˜¯å¯¹æ ‡é‡æ•°æ®ç±»å‹ï¼Œæ±‡ç¼–ä»£ç ä¹Ÿä¸åŒºåˆ†æœ‰ç¬¦å·æˆ–æ— ç¬¦å·æ•´æ•°ï¼Œä¸åŒºåˆ†å„ç§ç±»å‹çš„æŒ‡é’ˆï¼Œç”šè‡³äºä¸åŒºåˆ†æŒ‡é’ˆå’Œæ•´æ•°ã€‚

ç¨‹åºçš„å†…å­˜åŒ…æ‹¬ï¼šç¨‹åºçš„å¯æ‰§è¡Œæœºå™¨ä»£ç ã€æ“ä½œç³»ç»Ÿéœ€è¦çš„ä¸€äº›ä¿¡æ¯ã€ç®¡ç†è¿‡ç¨‹è°ƒç”¨å’Œè¿”å›çš„è¿è¡Œæ—¶æ ˆï¼Œä»¥åŠç”¨æˆ·åˆ†é…çš„å†…å­˜å—(ä¸€èˆ¬mallocåˆ†é…)

åœ¨ä»»ä½•æ—¶å€™ï¼Œåªæœ‰æœ‰é™çš„ä¸€éƒ¨åˆ†è™šæ‹Ÿåœ°å€è¢«è®¤ä¸ºæ˜¯åˆæ³•çš„ã€‚ä¾‹å¦‚x86-64è™½ç„¶æ˜¯64ä½çš„è™šæ‹Ÿåœ°å€ï¼Œä½†æ˜¯åœ¨å®è·µä¸­é«˜16ä½å¿…é¡»è®¾ç½®ä¸º0ï¼Œä»è€Œå®é™…èƒ½å¤Ÿè®¿é—®çš„æ˜¯$2^{48}$/256TBèŒƒå›´å†…çš„ä¸€ä¸ªå­—èŠ‚

## 3.2.2 Code Examples

> `gcc -0g -S mstore.c`ä¸­çš„"-S"æ˜¯è¡¨ç¤ºåªæ‰§è¡Œåˆ°ç¼–è¯‘é˜¶æ®µç”Ÿæˆæ±‡ç¼–ä»£ç æ–‡ä»¶

> `gcc -0g -c mstore.c`ä¸­çš„"-c"æ˜¯è¡¨ç¤ºåªæ‰§è¡Œåˆ°æ±‡ç¼–é˜¶æ®µç”Ÿæˆå¯é‡å®šä½çš„ç›®æ ‡æ–‡ä»¶

#### åæ±‡ç¼–å™¨ disassembler

ä¸ºäº†æŸ¥çœ‹è¯¥æœºå™¨ä»£ç æ–‡ä»¶çš„å†…å®¹ï¼Œéœ€è¦ä½¿ç”¨ä¸€ç±»ç§°ä¸ºåæ±‡ç¼–å™¨çš„ç¨‹åº

åæ±‡ç¼–å™¨å°†ä¼šä»æœºå™¨ä»£ç ä¸­ç”Ÿæˆä¸€ç§å’Œæ±‡ç¼–ä»£ç æ ¼å¼ç±»ä¼¼çš„æ–‡ä»¶

åœ¨Linux/Windowsç³»ç»Ÿä¸­ï¼Œä½¿ç”¨å‘½ä»¤objdumpå’Œ-då‘½ä»¤å‚æ•°æ¥å¯¹æœºå™¨ä»£ç æ–‡ä»¶è¿›è¡Œè§£æã€‚ç±»ä¼¼çš„è§£æç»“æœå¦‚ä¸‹ï¼š

`objdump -d mstore.o`

![](image/image_zqKWUcErGz.png)

åœ¨å·¦ä¾§ï¼Œæœ‰ 14 ä¸ªåå…­è¿›åˆ¶å­—èŠ‚å€¼ï¼ŒæŒ‰å‰é¢æ˜¾ç¤ºçš„å­—èŠ‚åºåˆ—åˆ—å‡ºï¼Œåˆ†ä¸º 1 åˆ° 5 ä¸ªå­—èŠ‚çš„ç»„ã€‚è¿™äº›ç»„ä¸­çš„æ¯ä¸€ä¸ªéƒ½æ˜¯ä¸€æ¡æŒ‡ä»¤ï¼Œå…¶æ±‡ç¼–è¯­è¨€ç­‰æ•ˆé¡¹æ˜¾ç¤ºåœ¨å³ä¾§

å¯ä»¥ä»ä¸­æ€»ç»“åˆ°å‡ ä¸ªç‰¹å¾ï¼š

1.  x86-64çš„æŒ‡ä»¤é•¿åº¦ä»1-15å­—èŠ‚ä¸ç­‰ï¼Œé‡‡ç”¨**å“ˆå¤«æ›¼ç¼–ç **ï¼Œä½¿ç”¨é¢‘åº¦é«˜/æ“ä½œæ•°å°‘çš„æŒ‡ä»¤å­—èŠ‚æ•°å°‘ï¼›ä½¿ç”¨é¢‘åº¦ä½/æ“ä½œæ•°å¤šçš„æŒ‡ä»¤å­—èŠ‚é•¿
2.  è®¾è®¡æŒ‡ä»¤æ ¼å¼çš„æ–¹å¼æ˜¯ï¼š**å¯¹äºæŸç§æŒ‡ä»¤éƒ½ç»™ä¸€ä¸ªå­—èŠ‚å”¯ä¸€ç”¨æ¥æ ‡è¯†æ­¤å¤„å¼€å§‹ä¸ºè¯¥æŒ‡ä»¤**ã€‚ä¾‹å¦‚ä¸Šå›¾ä¸­â€œpushä»¥53èµ·å§‹ï¼Œmovä»¥48èµ·å§‹ï¼Œpopä»¥5bèµ·å§‹ï¼Œretqä»¥c3èµ·å§‹ï¼Œcallqä»¥e8èµ·å§‹â€
3.  åæ±‡ç¼–å™¨åªæ˜¯åŸºäºç¨‹åºçš„æœºå™¨ä»£ç æ–‡ä»¶ä¸­çš„å­—èŠ‚åºåˆ—æ¥ç¡®å®šï¼Œä¸éœ€è¦è®¿é—®ç¨‹åºçš„æºæ–‡ä»¶å’Œæ±‡ç¼–æ–‡ä»¶
4.  åæ±‡ç¼–å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç å’Œç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç åœ¨æŒ‡ä»¤çš„å‘½åè§„åˆ™ä¸Šæœ‰ç»†å¾®å·®åˆ«ï¼Œä¾‹å¦‚æŒ‡ä»¤åç¼€åŠ ä¸åŠ â€œqâ€

#### é“¾æ¥mainæ–‡ä»¶

ç”Ÿæˆå®é™…å¯æ‰§è¡Œçš„ä»£ç éœ€è¦å¯¹ä¸€ç»„ç›®æ ‡ä»£ç æ–‡ä»¶[^æ³¨é‡Š3]è¿è¡Œé“¾æ¥å™¨ï¼Œè€Œè¿™ä¸€ç»„ç›®æ ‡ä»£ç æ–‡ä»¶ä¸­å¿…é¡»å«æœ‰ä¸€ä¸ªmainå‡½æ•°

`gcc -0g -o prog main.c mstore.c`å³é¢„å¤„ç†ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥mainå’Œmstoreä¸¤æ–‡ä»¶ï¼Œæœ€åç”Ÿæˆprogå¯æ‰§è¡Œç¨‹åº

#### é“¾æ¥ååæ±‡ç¼–ä¸ç¼–è¯‘ååæ±‡ç¼–çš„å¯¹æ¯”

é“¾æ¥ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶çš„åæ±‡ç¼–å’Œç¼–è¯‘ä¹‹åçš„å¯é‡å®šå‘ç›®æ ‡æ–‡ä»¶çš„åæ±‡ç¼–ç¤ºä¾‹å¦‚ä¸‹ï¼š

![](image/image_mzztjtONZp.png)

ä¸åŒçš„ç‚¹ä¸»è¦æœ‰ï¼š

1.  é“¾æ¥åçš„åæ±‡ç¼–ä»£ç è¿˜åŒ…æ‹¬ç”¨äºå¯åŠ¨å’Œç»ˆæ­¢ç¨‹åºä»¥åŠä¸æ“ä½œç³»ç»Ÿäº¤äº’çš„ä»£ç 
2.  é“¾æ¥åçš„åæ±‡ç¼–ä»£ç å·²ç»ç»™ä»£ç åˆ†é…å¥½äº†å…·ä½“çš„åœ°å€èŒƒå›´ï¼Œå¹¶ç›´æ¥æŒ‡æ˜äº†è¦è·³è½¬åˆ°çš„åœ°å€
3.  æ’å…¥çš„nopåªæ˜¯ä¸ºäº†å°†å‡½æ•°ä»£ç å˜ä¸º16å­—èŠ‚[^æ³¨é‡Š4]ï¼Œå°±å­˜å‚¨å™¨ç³»ç»Ÿæ€§èƒ½è€Œè¨€å¯ä»¥æ›´å¥½åœ°æ”¾ç½®ä¸‹ä¸€ä¸ªä»£ç å—

## 3.2.3 *Notes on Formatting*

ç»GCCç¼–è¯‘å™¨ç”Ÿæˆçš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼Œå¹¶ä¸å®¹æ˜“é˜…è¯»ã€‚æœ‰ä¸¤æ–¹é¢çš„åŸå› ï¼š

1.  è¯¥æ±‡ç¼–ä»£ç ä¸­åŒ…å«ä¸€äº›ç¨‹åºå‘˜ä¸å¤ªéœ€è¦å…³æ³¨çš„ä¿¡æ¯
2.  è¯¥æ±‡ç¼–ä»£ç å¹¶æœªæä¾›ä»»ä½•å…³äºç¨‹åºæˆ–æ˜¯å®ƒæ€ä¹ˆå·¥ä½œçš„æè¿°

![](image/image_8hA3duSC4V.png)

ä¸‹é¢æ˜¯å¸¦æœ‰æ³¨é‡Šçš„ã€çœç•¥æ‰"."æŒ‡ä»¤çš„æ±‡ç¼–ä»£ç 

![](image/image_Utn1oAUv7s.png)

> ğŸ³å¯¹äºä¸€äº›åº”ç”¨ç¨‹åºï¼Œç¨‹åºå‘˜å¿…é¡»ç”¨æ±‡ç¼–ä»£ç æ¥è®¿é—®æœºå™¨çš„ä½çº§ç‰¹æ€§ã€‚
>
> ä¸€ç§æ–¹æ³•æ˜¯ç”¨æ±‡ç¼–ä»£ç ç¼–å†™æ•´ä¸ªå‡½æ•°ï¼Œåœ¨é“¾æ¥é˜¶æ®µæŠŠå®ƒä»¬å’ŒCå‡½æ•°ç»„åˆèµ·æ¥ã€‚
> å¦ä¸€ç§æ–¹æ³•æ˜¯åˆ©ç”¨GCCçš„æ”¯æŒï¼Œåˆ©ç”¨asmä¼ªæŒ‡ä»¤ç›´æ¥åœ¨Cç¨‹åºä¸­åµŒå…¥æ±‡ç¼–ä»£ç ã€‚

# 3.3 *Data Formats*

ç”±äºx86-64èµ·æºä¸º 16 ä½æ¶æ„ï¼Œåæ¥æ‰©å±•åˆ° 32 ä½æ¶æ„ï¼ŒIntel ä½¿ç”¨æœ¯è¯­â€œå­—Wordâ€æ¥æŒ‡ä»£ 16 ä½æ•°æ®ç±»å‹ã€‚åŸºäºæ­¤ï¼Œå°† 32 ä½æ•°æ®é‡ç§°ä¸ºâ€œåŒå­—DWâ€ï¼Œå°† 64 ä½æ•°æ®é‡ç§°ä¸ºâ€œå››å­—QWâ€

ä¸‹å›¾æ˜¯Cè¯­è¨€åŸºæœ¬æ•°æ®ç±»å‹å¯¹åº”çš„x86-64è¡¨ç¤º

![](image/image_DGPs_Xv94Q.png)

intå 4å­—èŠ‚ï¼ŒæŒ‡é’ˆ8å­—èŠ‚ï¼Œlongå 8å­—èŠ‚

**å¤§å¤šæ•°GCCç”Ÿæˆçš„æ±‡ç¼–ä»£ç æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªå­—ç¬¦åç¼€â€œb/w/l/qâ€ï¼Œè¡¨ç¤ºæ“ä½œæ•°çš„å¤§å°**ã€‚ä¾‹å¦‚ï¼Œæ•°æ®ä¼ é€æŒ‡ä»¤æœ‰4ä¸ªå˜ç§ï¼šmovbã€movwã€movlã€movqã€‚æ³¨æ„floatã€doubleåç¼€æ˜¯sã€lã€‚è¿™ä¸ä¼šå¼•èµ·æ­§ä¹‰ï¼Œå› ä¸ºæµ®ç‚¹æ•°ä¸æ•´æ•°ä½¿ç”¨ä¸åŒçš„æŒ‡ä»¤å’Œå¯„å­˜å™¨æ–‡ä»¶

# 3.4\* Accessing Information\*

x86-64 ä¸­å¤®å¤„ç†å•å…ƒ (CPU) åŒ…å«ä¸€ç»„ 16 ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œç”¨äºå­˜å‚¨ 64 ä½å€¼ã€‚è¿™äº›å¯„å­˜å™¨ç”¨äºå­˜å‚¨æ•´æ•°æ•°æ®å’ŒæŒ‡é’ˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![](image/image_V1k_SvZbgp.png)

è¿™16ä¸ªå¯„å­˜å™¨åå‡ä»¥â€œ%râ€èµ·å§‹ï¼Œä½†æ˜¯å¯¹äº32ä½ã€16ä½ã€8ä½çš„å¯„å­˜å™¨æ•°æ®åˆ™æœ‰ä¸åŒçš„å‘½åè§„åˆ™ã€‚è¿™æ˜¯ç”±äºæŒ‡ä»¤é›†çš„å˜é©

1.  åˆšå¼€å§‹8086åªæœ‰8ä¸ª16ä½çš„å¯„å­˜å™¨ï¼Œå³`%ax~%sp`ï¼Œæ ¹æ®å®ƒä»¬çš„å®é™…ä½œç”¨è¿›è¡Œå‘½åâ€”â€”é«˜ä½hä½ä½l
2.  ä¹‹åæ‰©å±•åˆ°IA32ï¼Œå¯„å­˜å™¨å‘½åä¸º`%eax~%esp`è¡¨ç¤ºæ‰©å±•åˆ°32ä½
3.  å†ä¹‹åæ‰©å±•åˆ°IA64ï¼Œå‰8ä¸ªå¯„å­˜å™¨å‘½åä¸º`%rax~%rsp`ã€‚å¹¶æ·»åŠ äº†å‰©ä¸‹8ä¸ªå¯„å­˜å™¨ï¼Œå‘½år8\~r15ï¼Œ32ä½ä¸ºåŒå­—åŠ åç¼€dï¼Œ16ä½ä¸ºå­—åŠ åç¼€wï¼Œ8ä½ä¸ºå­—èŠ‚åŠ åç¼€b

å› ä¸ºæŒ‡ä»¤å…è®¸å¯¹è¿™16ä¸ªå¯„å­˜å™¨çš„ä¸åŒæ•°æ®é‡ä½[^æ³¨é‡Š5]è¿›è¡Œæ“ä½œï¼Œé‚£ä¹ˆå½“å°†è¿™äº›å¯„å­˜å™¨ä½œä¸ºç›®çš„å¯„å­˜å™¨ä¸”æ“ä½œæ•°æ®å¤§å°å°‘äº8å­—èŠ‚ï¼Œå°±ä¼šé‡åˆ°é«˜ä½å­—èŠ‚æ€ä¹ˆåŠçš„æƒ…å†µï¼š

1.  æ“ä½œ1å­—èŠ‚å’Œ2å­—èŠ‚ï¼ˆå­—ï¼‰çš„æŒ‡ä»¤ä¿æŒé«˜ä½å­—èŠ‚æ•°æ®ä¸å˜
2.  æ“ä½œ4å­—èŠ‚ï¼ˆåŒå­—ï¼‰çš„æŒ‡ä»¤ï¼Œèµ‹å€¼é«˜ä½4å­—èŠ‚ä¸º0[^æ³¨é‡Š6]

Figure3.2å³ä¾§çš„æ³¨é‡Šè¡¨ç¤ºä¸å¤ªçš„å¯„å­˜å™¨åœ¨ç¨‹åºä¸­å……å½“çš„ä¸åŒçš„ä½œç”¨

é™¤äº†%rspä¸“ç”¨è¡¨ç¤ºè¿è¡Œæ—¶æ ˆçš„ç»“æŸä½ç½®ï¼Œå¹¶ä¸”æœ‰ä¸“é—¨çš„æŒ‡ä»¤æ¥è¯»å†™è¿™ä¸ªå¯„å­˜å™¨ã€‚å…¶ä»–15ä¸ªå¯„å­˜å™¨çš„ä½¿ç”¨éƒ½è¾ƒä¸ºçµæ´»

## 3.4.1 *Operand Specifiers*

å¤§å¤šæ•°æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ª**æ“ä½œæ•°æŒ‡ç¤ºç¬¦æ¥æŒ‡å‡ºæ‰§è¡Œä¸€ä¸ªæ“ä½œæ‰€éœ€è¦çš„æºæ•°æ®å€¼ä»¥åŠç»“æœè¦å­˜æ”¾çš„ç›®æ ‡ä½ç½®**ã€‚x86-64æ”¯æŒå¦‚ä¸‹å›¾æ‰€ç¤ºçš„æ“ä½œæ•°æ ¼å¼ï¼š

![](image/image_UXKZ65xTlq.png)

å„ç§ä¸åŒæ“ä½œæ•°çš„å¯èƒ½æ€§å¯åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š

1.  ç«‹å³æ•°

    ç«‹å³æ•°è¡¨ç¤ºå¸¸æ•°å€¼ï¼Œä¹¦å†™æ ¼å¼ä¸ºï¼š\$+Cè¯­è¨€æ ‡å‡†æ‰€è¡¨ç¤ºçš„æ•´æ•° $$\$Imm \rightarrow Imm$$

    eg:\$12,\$0x12
2.  å¯„å­˜å™¨æ•°

    å¯„å­˜å™¨æ•°è¡¨ç¤ºçš„æ˜¯æ•°æ®æ¥æºäºx86-64çš„16ä¸ªé€šç”¨å¯„å­˜å™¨ï¼Œä¸”æ•°æ®å¤§å°å¯ä»¥æ˜¯å­—èŠ‚ã€å­—ã€åŒå­—ã€å››å­—ã€‚ä¹¦å†™æ ¼å¼ä¸ºï¼š$r_a$ $r_a\rightarrow R[r_a]$
3.  å­˜å‚¨å™¨æ•°

    æ ¹æ®å­˜å‚¨å™¨åœ°å€çš„è¡¨ç¤ºæ–¹æ³•å¯ä»¥åˆ†ä¸ºï¼šå­˜å‚¨å™¨ç«‹å³å¯»å€ã€å¯„å­˜å™¨é—´æ¥å¯»å€ã€å¯„å­˜å™¨ç›¸å¯¹å¯»å€ï¼Œå˜å€å¯»å€ï¼ˆå¸¦ç«‹å³æ•°å’Œä¸å¸¦ç«‹å³æ•°ï¼‰ï¼Œæ¯”ä¾‹å˜å€å¯»å€(4ç§)

    è®¡ç®—å‡ºçš„å­˜å‚¨å™¨åœ°å€ç§°ä¹‹ä¸ºæœ‰æ•ˆåœ°å€

> ğŸ³åœ¨è¿™äº›å¯»å€æ–¹å¼ä¸­ï¼Œæœ€å¸¸ç”¨çš„å½¢å¼æ˜¯$Imm(r_b,r_i,s)\rightarrow Imm+R[r_b]+R[r_i]\cdot s$å…¶ä¸­**så¿…é¡»æ˜¯1ã€2ã€4ã€8ï¼Œ**$r_bã€r_i$**å¿…é¡»æ˜¯64ä½çš„å¯„å­˜å™¨**ã€‚è¿™ä¸ªå½¢å¼ç»å¸¸ç”¨æ¥å¼•ç”¨æ•°ç»„å…ƒç´ ï¼Œå…¶ä½™å¯»å€å½¢å¼éƒ½å¯ä»¥çœç•¥è¿™ä¸ªå½¢å¼çš„æŸéƒ¨åˆ†æ¥å½¢æˆã€‚

## 3.4.2 *Data Movement Instructions*

å°†è®¸å¤šä¸åŒçš„æŒ‡ä»¤åˆ†ä¸ºæŒ‡ä»¤ç±»ï¼Œå…¶ä¸­ç±»ä¸­çš„æŒ‡ä»¤æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä½†æ“ä½œæ•°å¤§å°ä¸åŒ

#### MOVç±»

![](image/image_B11jIrSPCd.png)

MOVç±»æŒ‡ä»¤å¯ä»¥ä¸éœ€è¦ä»»ä½•è½¬å˜çš„å°†æ•°æ®ä»æºä½ç½®å¤åˆ¶åˆ°ç›®çš„ä½ç½®

MOVç±»åŒ…æ‹¬movbã€movwã€movlã€movqå››ç±»æŒ‡ä»¤ï¼Œå®ƒä»¬æ‰§è¡Œçš„æ•ˆæœæ˜¯ç›¸åŒçš„å”¯ä¸€çš„åŒºåˆ«åœ¨äºæ“ä½œçš„æ•°æ®å¤§å°ä¸åŒï¼š1ã€2ã€4ã€8

> ğŸ³æºä½ç½®å¯ä»¥æ˜¯ä¸€ä¸ªç«‹å³æ•°ã€å¯„å­˜å™¨æ•°æˆ–è€…å­˜å‚¨å™¨æ•°ï¼›ç›®çš„ä½ç½®å¯ä»¥æ˜¯å¯„å­˜å™¨æ•°æˆ–è€…å­˜å‚¨å™¨æ•°ã€‚ä½†æ˜¯ä¸å…è®¸æºä½ç½®ã€ç›®çš„ä½ç½®éƒ½æ˜¯å­˜å‚¨å™¨æ•°
>
> å› æ­¤ä»å­˜å‚¨å™¨æŸä½ç½®å¤åˆ¶æ•°æ®åˆ°å¦ä¸€ä¸ªä½ç½®éœ€è¦ä½¿ç”¨ä¸¤æ¡æŒ‡ä»¤ï¼šå…ˆmovåˆ°æŸå¯„å­˜å™¨ï¼Œå†ç”±è¯¥å¯„å­˜å™¨movåˆ°ä¸»å­˜

movæŒ‡ä»¤ä½¿ç”¨çš„å¯„å­˜å™¨æ“ä½œæ•°å¯ä»¥æ˜¯16ä¸ªé€šç”¨å¯„å­˜å™¨ä¸­çš„ä»»æ„ä¸€ä¸ªï¼Œä½†æ˜¯éœ€è¦ä¿è¯ä½¿ç”¨å¯„å­˜å™¨ç‰‡æ®µçš„å¤§å°å’ŒæŒ‡ä»¤çš„æœ€åä¸€ä¸ªå­—ç¬¦æŒ‡ä»¤çš„å¤§å°ç›¸åŒ(bã€wã€lã€q)ã€‚ä¸”**å¯¹bã€wã€qæŒ‡ä»¤çš„æƒ…å†µï¼ŒmovæŒ‡ä»¤åªä¼šæ›´æ–°ç›®æ ‡æ“ä½œæ•°æŒ‡ç¤ºçš„ç‰¹å®šåŒºåŸŸï¼Œé™¤äº†movlæŒ‡ä»¤**[^æ³¨é‡Š7]**ä¼šä½¿å¾—å¯„å­˜å™¨é«˜4Bä¸º0**

ä¸‹é¢æ˜¯movç±»æŒ‡ä»¤çš„ä¸€äº›ç¤ºä¾‹ï¼š

```nasm
movl $0x4050,%eax    %Immediate--Register,4 bytes
movw %bp,%sp         %Register--Register,2 bytes
movb (%rdi,%rcx),%al %Memory--Register,1 byte
movb $-17,(%esp)     %Immediate--Memory,1 byte
movq %rax,-12(%rbp)  %Register--Memory,8 bytes
```

> Figure3.4ä¸­çš„æœ€åä¸€æ¡æŒ‡ä»¤`movabsq`æ˜¯ç”¨æ¥å¤„ç†64ä½ç«‹å³æ•°çš„[^æ³¨é‡Š8]ã€‚å®ƒå¯ä»¥ç›´æ¥ä½¿ç”¨ä»»æ„çš„**64ä½ç«‹å³æ•°å€¼**ä½œä¸ºæºæ“ä½œæ•°ï¼Œä½†æ˜¯**åªèƒ½ä½¿ç”¨å¯„å­˜å™¨ä½œä¸ºç›®çš„åœ°å€**

#### MOVZã€MOVS

> ğŸ³MOVZå’ŒMOVSæŒ‡ä»¤æ˜¯ç”¨æ¥å°†ä¸€ä¸ªè¾ƒå°çš„æ•°ç§»åŠ¨åˆ°ä¸€ä¸ªè¾ƒå¤§çš„ç›®çš„ä½ç½®ä¸Šã€‚æºä½ç½®å¯ä»¥æ˜¯å¯„å­˜å™¨æˆ–è€…å­˜å‚¨å™¨ï¼Œä½†æ˜¯ç›®çš„ä½ç½®åªèƒ½æ˜¯å¯„å­˜å™¨ã€‚

1.  MOVZæŒ‡ä»¤æ˜¯å°†ç›®çš„ä½ç½®ä¸Šçš„å‰©ä½™å­—èŠ‚å¡«å……0
    MOVSæŒ‡ä»¤æ˜¯å°†ç›®çš„ä½ç½®ä¸Šçš„å‰©ä½™å­—èŠ‚å¡«å……æºæ“ä½œæ•°çš„MSB
2.  å¯¹äºbã€wã€lã€qå››ç±»æ•°æ®å¤§å°ï¼Œæ€»å…±çš„æŒ‡ä»¤ç±»åˆ«æœ‰$C_4 ^2$ç§

    ä½†æ˜¯ç”±äºx86-64æ—¢æœ‰æ ‡å‡†â€”â€”å¯¹äºä»»ä½•äº§ç”Ÿ32ä½ç»“æœçš„æŒ‡ä»¤ï¼Œè‹¥å°†ç»“æœæ”¾ç½®åœ¨64ä½çš„ç›®çš„å¤„ï¼Œåˆ™é«˜ä½éƒ¨åˆ†éœ€è®¾ç½®ä¸º0ã€‚å› æ­¤ä¸å­˜åœ¨movzlq

    ![](image/image_mF_Lh-hcLi.png)

    ![](image/image_7VFD4kzOWA.png)

> cltqæŒ‡ä»¤
>
> cltqæŒ‡ä»¤æ²¡æœ‰æ˜¾å¼æŒ‡å®šæ“ä½œæ•°ï¼Œå®ƒéšå«æºæ“ä½œæ•°%eaxä»¥åŠç›®çš„æ“ä½œæ•°%raxï¼Œæ‰§è¡Œçš„åŠŸèƒ½æ˜¯$SignExtend(\%eax)\rightarrow \%rax$ã€‚ç­‰ä»·äº$movslq \space \%eax \space \%rax$
>
> ä½†æ˜¯ç›¸è¾ƒäºmovslqæŒ‡ä»¤éœ€è¦æŒ‡æ˜æ“ä½œæ•°ï¼Œcltqå¹¶ä¸éœ€è¦å› æ­¤æŒ‡ä»¤å­—é•¿æ›´ç´§å‡‘

> æ ¹æ®æºã€ç›®æ•°æ®ç±»å‹å¡«å……movæŒ‡ä»¤
>
> ![](image/image_POBm4rUKiP.png)
>
> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ**å†…å­˜åœ°å€æ€»æ˜¯ç”¨64ä½çš„**
>
> åˆ¤æ–­ä¾æ®ï¼š**è‹¥ç›®çš„ä½ç½®æ˜¯å¯„å­˜å™¨æ“ä½œæ•°ï¼Œåˆ™éœ€è¦æ ¹æ®å¯„å­˜å™¨æ‰€ä½¿ç”¨çš„å¤§å°å†³å®šmovçš„åç¼€ï¼›ä½†å¦‚æœä½¿ç”¨çš„æ˜¯å­˜å‚¨å™¨æ“ä½œæ•°ï¼Œåˆ™éœ€è¦æ ¹æ®æºä½ç½®æ“ä½œæ•°å¤§å°æ¥å†³å®š**

> é”™è¯¯çš„æŒ‡ä»¤ç¤ºä¾‹ï¼š
>
> ![](image/image_oOUcxvuFTe.png)
>
> 1.  å†…å­˜å¼•ç”¨éœ€è¦ä½¿ç”¨64ä½
> 2.  movlæ˜¯32ä½ï¼Œä½†æ˜¯%raxæ˜¯64ä½
> 3.  movæŒ‡ä»¤ä¸èƒ½ç”¨äºå†…å­˜å’Œå†…å­˜ä¹‹é—´çš„æ•°æ®ç§»åŠ¨
> 4.  æ²¡æœ‰%slè¿™ä¸ªå¯„å­˜å™¨ï¼Œåº”è¯¥æ˜¯%sil
> 5.  ä¸èƒ½å°†ç«‹å³æ•°ä½œä¸ºç›®çš„å¯„å­˜å™¨
> 6.  movlæ˜¯332ä½çš„ï¼Œä½†æ˜¯%rdxä¸º64ä½
> 7.  %siå¯„å­˜å™¨ä¸º16ä½ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯movbæŒ‡ä»¤

## 3.4.3 *Data Movement Example*

ä»¥Figure3.7ä¸­çš„äº¤æ¢å€¼çš„ä»£ç ç¤ºä¾‹ä¸ºä¾‹è¿›è¡Œåˆ†æ

![](image/image_HL7oirC3cX.png)

å‡½æ•°ä¸­çš„å±€éƒ¨å˜é‡æ˜¯è¢«ä¿å­˜åœ¨å¯„å­˜å™¨ä¸­è€Œä¸æ˜¯å†…å­˜ä¸­çš„ã€‚å› ä¸ºè®¿é—®å¯„å­˜å™¨è¿œå¿«äºè®¿é—®ä¸»å­˜

1.  è¿”å›å€¼ä¿å­˜åœ¨%raxä¸­ï¼›å‚æ•°ä¿å­˜åœ¨%rdiã€%rsiä¸­

    %rdiä¸­å­˜å‚¨çš„æ˜¯xpæŒ‡é’ˆçš„å€¼
    %rsiä¸­å­˜å‚¨çš„æ˜¯yçš„å€¼
2.  æŒ‡é’ˆçš„è§£å¼•ç”¨è¿‡ç¨‹å¦‚ä¸‹ï¼š
    1.  é¦–å…ˆå°†å†…å­˜ä¸­æŒ‡é’ˆçš„å€¼èµ‹ç»™æŸä¸ªå¯„å­˜å™¨
    2.  é€šè¿‡å¯„å­˜å™¨é—´æ¥å¯»å€çš„æ–¹å¼å½¢æˆå†…å­˜çš„æœ‰æ•ˆåœ°å€ï¼Œä»è€Œè·å¾—å¯¹åº”çš„å€¼

> ä½¿ç”¨MOVã€MOVZã€MOVSç±»æŒ‡ä»¤å®Œæˆç±»å‹å¼ºåˆ¶è½¬æ¢
>
> $*dp=(dest\_t)*sp$,spå­˜æ”¾åœ¨%rdiä¸­ï¼Œdpå­˜æ”¾åœ¨%rsiä¸­
>
> ä¸­é—´å˜é‡ä½¿ç”¨%raxã€%eaxã€%axã€%al
>
> ![](image/image_wegtqTALsg.png)
>
> 1.  longâ†’longï¼š64ä½åˆ°64ä½
>
>     è¯»æ•°æ®ï¼š`movq (%rdi),%rax`
>
>     å†™æ•°æ®ï¼š`movq %rax,(%rsi)`
> 2.  charâ†’intï¼š8ä½åˆ°32ä½
>
>     è¯»æ•°æ®ï¼š`movsbl (%rdi),%eax `å› ä¸ºå†™æ•°æ®è¦æ±‚ä½¿ç”¨%eaxåˆ™å­˜æ•°æ®ä¹Ÿè¦ä½¿ç”¨%eaxï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œç¬¦å·æ‰©å±•ï¼Œä½¿ç”¨movsblæŒ‡ä»¤&#x20;
>
>     å†™æ•°æ®ï¼š`movl %eax,(%rsi) ` è¿™é‡Œå¿…é¡»è¦ä½¿ç”¨%eaxå› ä¸ºæ•°æ®å¤§å°ç”±æºæ¥å†³å®š
> 3.  charâ†’unsignedï¼š8ä½åˆ°32ä½
>
>     å¯¹äºæ—¢è¦è¿›è¡Œä½æ‰©å±•ä¹Ÿè¦ç¬¦å·è½¬æ¢çš„æƒ…å½¢ï¼š**Cè¯­è¨€è§„å®šå…ˆè¿›è¡Œä½æ‰©å±•å†è¿›è¡Œç¬¦å·è½¬æ¢**
>
>     å› æ­¤å®é™…çš„è°ƒç”¨æŒ‡ä»¤åŒ2
> 4.  unsigned charâ†’longï¼š8ä½åˆ°64ä½
>
>     æ— ç¬¦å·æ•°è¿›è¡Œé›¶æ‰©å±•ä½¿ç”¨movzblæŒ‡ä»¤
>
>     è¯»æ•°æ®ï¼š`movzbl (%rdi),%eax`
>
>     å†™æ•°æ®ï¼š`movq %rax,(%rsi)`
> 5.  intâ†’charï¼š32ä½åˆ°8ä½
>
>     è¯»æ•°æ®ï¼š`movl (%rdi),%eax`
>
>     å†™æ•°æ®ï¼š`movb %al,(%rsi)`
> 6.  unsignedâ†’unsigned charï¼š32ä½åˆ°8ä½
>
>     åŒ5
> 7.  charâ†’shortï¼š8ä½åˆ°16ä½
>
>     è¯»æ•°æ®ï¼š`movsbw (%rdi),%ax `
>
>     å†™æ•°æ®ï¼š`movw %ax,(%rsi) `&#x20;

## 3.4.4\* Pushing and Popping Stack Data\* %rsp

![](image/image_YI12ztHX6m.png)

æ ˆé¡¶é‡‡ç”¨â€œé«˜åˆ°ä½â€**å‘ä¸‹å¢é•¿**çš„å½¢å¼ä¸”**æ ˆé¡¶æœ‰æ•°æ®**

å…¥æ ˆï¼šå…ˆå‡æ ˆé¡¶æŒ‡é’ˆ8ï¼Œç„¶åå…¥æ•°æ®
å‡ºæ ˆï¼šå…ˆå–æ•°æ®ï¼Œå†åŠ æ ˆé¡¶æŒ‡é’ˆ8

![](image/image_Ki_vykAvcS.png)

åœ¨x86-64ä¸­ï¼Œæ ˆå­˜æ”¾åœ¨å†…å­˜ä¸­çš„æŸä¸ªåŒºåŸŸã€‚é‡‡ç”¨**å‘ä¸‹å¢é•¿****çš„åŸåˆ™ä½¿å¾—****æ ˆé¡¶å…ƒç´ çš„åœ°å€æ˜¯æ‰€æœ‰æ ˆä¸­å…ƒç´ åœ°å€æœ€ä½çš„**â€”â€”ä½†æ˜¯æ ¹æ®æƒ¯ä¾‹ï¼Œç”»æ ˆæ—¶æ ˆé¡¶åœ¨æœ€ä¸‹ç«¯ï¼Œé‡‡ç”¨å‘ä¸Šå¢é•¿

**å‡ºæ ˆåï¼Œåªæ˜¯æ ˆé¡¶%rspçš„å€¼å‘ç”Ÿäº†å˜åŒ–ï¼Œä½†æ˜¯åŸæ ˆé¡¶ä½ç½®ä¸Šçš„å…ƒç´ è¿˜åœ¨ç›´åˆ°è¢«é‡æ–°pushè¦†ç›–**

**å› ä¸ºæ ˆä¹Ÿå­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨å¯„å­˜å™¨é—´æ¥å¯»å€çš„æ–¹å¼è®¿é—®æ ˆå…ƒç´ **

æ¯”å¦‚`movq 8(%rsp),rdx`åˆ™æ˜¯å°†æ ˆé¡¶çš„ä¸‹ä¸€ä¸ªå››å­—å…ƒç´ å¤åˆ¶åˆ°%raxä¸­

# 3.5 *Arithmetic and Logical Operations*

ç®—æœ¯é€»è¾‘è¿ç®—æŒ‡ä»¤æ ¹æ®æ“ä½œç±»å‹åˆ†ä¸ºï¼šåŠ è½½æœ‰æ•ˆåœ°å€ã€ä¸€å…ƒæ“ä½œã€äºŒå…ƒæ“ä½œå’Œç§»ä½

![](image/image_JEwg58Cw-9.png)

## 3.5.1 *Load Effective Address*

åŠ è½½æœ‰æ•ˆåœ°å€`leaq`æŒ‡ä»¤å®é™…ä¸Šæ˜¯`movq`çš„å˜å½¢ï¼Œå®ƒé™åˆ¶äº†æºæ“ä½œæ•°å¿…é¡»æ˜¯ä¸ªå†…å­˜å¼•ç”¨ï¼Œç›®çš„æ“ä½œæ•°å¿…é¡»æ˜¯å¯„å­˜å™¨ï¼Œä½†æ˜¯å¹¶ä¸ä»å†…å­˜æŒ‡å®šä½ç½®è¯»å–æ•°æ®ï¼Œè€Œæ˜¯å°†å†…å­˜å¼•ç”¨çš„æœ‰æ•ˆåœ°å€å†™å¯„å­˜å™¨ã€‚leaqæŒ‡ä»¤å¯ä»¥å¾—åˆ°å†…å­˜å¼•ç”¨æŒ‡é’ˆçš„å€¼ä¹Ÿå¯ä»¥è¿›è¡Œä¸€äº›åˆ©ç”¨ç¼©æ”¾å˜å€å¯»å€æ–¹å¼å®ç°ä¸€äº›ç®€å•çš„è®¡ç®—

egï¼šè‹¥%rdxå€¼ä¸ºxï¼Œåˆ™`leaq 7(%rdx,%rdx,4),%rax`å³`%rax=5x+7`

å› æ­¤ç¼–è¯‘å™¨å¯ä»¥ä½¿ç”¨leaqæŒ‡ä»¤æ¥å®Œæˆä¸€äº›ä¼˜åŒ–æ“ä½œï¼Œå¦‚ä¸‹ï¼š

![](image/image_5MaxwkGS6Q.png)

åˆ™è‹¥*x in %rdi,y in %rsi,z in %rdx*ï¼Œé‚£ä¹ˆx+4yiå³`leaq (%rdi,%rsi,4),%rax`
12zå³3z\*4ï¼Œ`leaq (%rdx,%rdx,2)`,`%rdx,leaq(%rax,%rdx,4),%rax`

> ğŸ³ä¸€å®šè¦æ³¨æ„leaqæŒ‡ä»¤èƒ½å¤Ÿæ‰§è¡ŒåŠ æ³•å’Œæœ‰é™å½¢å¼çš„ä¹˜æ³•ï¼Œåœ¨ç¼–è¯‘ä¸€äº›ç®€å•çš„è¡¨è¾¾å¼æ—¶æ˜¯ååˆ†æœ‰ç”¨çš„

## 3.5.2\* Unary and Binary Operations\*

### 3.5.2.1 Unary Operations

ä¸€å…ƒæ“ä½œåªæœ‰ä¸€ä¸ªæ“ä½œæ•°ï¼Œè¿™ä¸ªæ“ä½œæ•°æ—¢æ˜¯æºæ“ä½œæ•°ä¹Ÿæ˜¯ç›®çš„æ“ä½œæ•°ï¼Œ**æ“ä½œæ•°çš„ç±»å‹åªèƒ½æ˜¯å¯„å­˜å™¨æˆ–è€…å­˜å‚¨å™¨**ã€‚ä¾‹å¦‚Cè¯­è¨€ä¸­çš„è‡ªå¢ã€è‡ªå‡è¿ç®—ç¬¦

![](image/image_eHDzIsTl_N.png)

### 3.5.2.2 Binary Operations

äºŒå…ƒæ“ä½œæœ‰ä¸¤ä¸ªæ“ä½œæ•°ï¼Œå…¶ä¸­**ç¬¬äºŒä¸ªæ“ä½œæ•°æ—¢æ˜¯æºæ“ä½œæ•°ä¹Ÿæ˜¯ç›®çš„æ“ä½œæ•°**ã€‚ä¾‹å¦‚`subq %rax,%rdx`æ‰§è¡Œçš„åŠŸèƒ½æ˜¯$R[\%rdx]-R[\%rax]\rightarrow R[\%rdx]$

äºŒå…ƒæ“ä½œçš„ç¬¬ä¸€ä¸ªæºæ“ä½œæ•°å¯ä»¥æ˜¯ç«‹å³æ•°ã€å¯„å­˜å™¨æˆ–å­˜å‚¨å™¨ï¼›ä½†æ˜¯ç¬¬äºŒä¸ªæ“ä½œæ•°åªèƒ½æ˜¯å¯„å­˜å™¨/å­˜å‚¨å™¨[^æ³¨é‡Š9]

![](image/image_9UGtSgEpKV.png)

## 3.5.3 *Shift Operations*

ç§»ä½æ“ä½œæ˜¯äºŒå…ƒæ“ä½œï¼šç¬¬ä¸€ä¸ªæ“ä½œæ•°æ˜¯ç§»ä½é‡ï¼Œç§»ä½é‡çš„è¡¨ç¤ºå¯ä»¥ä½¿ç”¨ç«‹å³æ•°ä¹Ÿå¯ä»¥ä½¿ç”¨%clï¼›ç¬¬äºŒä¸ªæ“ä½œæ•°æ˜¯è¦ç§»ä½çš„å€¼ï¼Œç±»å‹æ˜¯å¯„å­˜å™¨æˆ–è€…å­˜å‚¨å™¨

![](image/image_zGh-5qMydi.png)

> ğŸ³åŸåˆ™ä¸Šè™½ç„¶ä½¿ç”¨%clè¡¨ç¤ºç§»ä½é‡ï¼ŒèŒƒå›´ä¸º0\~255ã€‚ä½†æ˜¯åœ¨x86-64ä¸­ï¼Œå¯¹wä½é•¿çš„æ•°æ®å€¼è¿›è¡Œç§»ä½æ“ä½œæ—¶ï¼Œç§»ä½é‡æ˜¯ç”±%clå¯„å­˜å™¨çš„ä½mä½å†³å®šçš„ï¼Œ$ 2^m=w
>   $**ä¹Ÿå°±æ˜¯ç§»ä½é‡%w**
>
> ä¾‹å¦‚å½“%cl=0xffæ—¶ï¼Œsalbä¼šç§»åŠ¨111bä½ï¼Œsalwä¼šç§»åŠ¨1111bä½ï¼Œsallä¼šç§»åŠ¨11111bä½ï¼Œè€Œsalqä¼šç§»åŠ¨111111bä½

## 3.5.4 *Special Arithmetic Operations*

> **ä½¿ç”¨å¼‚æˆ–æŒ‡ä»¤å®ç°å¯„å­˜å™¨çš„èµ‹0**
>
> ![](image/image_2UfLH04Z5O.png)
>
> A.è¿™æ¡æŒ‡ä»¤å¯ä»¥å°†%rdxç½®ä¸º0
>
> B.`movq $0,%rdx`
>
> C.ä½¿ç”¨XORç¼–ç é•¿åº¦æ›´å°‘

æ­£å¦‚æˆ‘ä»¬åœ¨ 2.3 èŠ‚ä¸­çœ‹åˆ°çš„ï¼Œä¸¤ä¸ª 64 ä½æœ‰ç¬¦å·æˆ–æ— ç¬¦å·æ•´æ•°ç›¸ä¹˜å¯ä»¥äº§ç”Ÿéœ€è¦ 128 ä½æ¥è¡¨ç¤ºçš„ä¹˜ç§¯ã€‚ x86-64 æŒ‡ä»¤é›†å¯¹æ¶‰åŠ 128 ä½ï¼ˆ16 å­—èŠ‚ï¼‰æ•°å­—çš„æ“ä½œæä¾›æœ‰é™çš„æ”¯æŒã€‚ç»§ç»­é‡‡ç”¨å­—ï¼ˆ2 å­—èŠ‚wï¼‰ã€åŒå­—ï¼ˆ4 å­—èŠ‚lï¼‰å’Œå››å­—ï¼ˆ8 å­—èŠ‚qï¼‰çš„å‘½åçº¦å®šï¼Œ**Intel å°† 16 å­—èŠ‚æ•°é‡ç§°ä¸ºå…«è¿›åˆ¶å­—**o

ä¸‹å›¾æè¿°äº†x86-64æŒ‡ä»¤é›†ä¸­æ”¯æŒ128ä½çš„æ•´æ•°ä¹˜æ³•å’Œé™¤æ³•

![](image/image_8yyoBOB2M8.png)

### MUL

imulqæŒ‡ä»¤æœ‰ä¸¤ç§å½¢å¼ï¼š

1.  åŒæ“ä½œæ•°å½¢å¼çš„IMULï¼š`imul S,D`æ˜¯å°†S\*Dâ†’D
2.  å•æ“ä½œæ•°å½¢å¼çš„IMULï¼š`imulq S`éšå«æ“ä½œæ•°%raxä¸ºæºæ“ä½œæ•°ï¼Œæ˜¯å°†S\*R\[%rax]çš„é«˜ä½ç»“æœå†™R\[%dx]ï¼Œä½ä½ç»“æœå†™R\[%rax]â€”â€”**æœ‰ç¬¦å·è®¡ç®—**

å’Œå•æ“ä½œæ•°imulæœ‰ç¬¦å·ä¹˜æ³•ç±»ä¼¼çš„è¿˜æœ‰æ— ç¬¦å·å•æ“ä½œæ•°ä¹˜æ³•mulq

`mulq S`åŒæ ·éšå«æºæ“ä½œæ•°%raxï¼Œä¹ŸåŒæ ·æ˜¯å°†R\[%rax]\*Sçš„é«˜ä½ç»“æœå†™R\[%rdx]ï¼Œä½ä½ç»“æœå†™R\[%rax]

![](image/image_hyCbhknxMj.png)

ä¸Šå›¾æ˜¯ä¸€ä¸ªè®¡ç®—64ä½æ— ç¬¦å·æ•°ä¹˜ä»¥64ä½æ— ç¬¦å·æ•°å¾—åˆ°128ä½ç»“æœçš„å‡½æ•°ï¼Œå…¶å¯¹åº”çš„æ±‡ç¼–ä»£ç å¦‚å³åŠå›¾æ‰€ç¤ºã€‚æ ¹æ®æ±‡ç¼–ä»£ç å¯ä»¥å¾—åˆ°å¦‚æœæƒ³ä¿ç•™è¯¥128ä½çš„ç»“æœï¼Œéœ€è¦ä½¿ç”¨ä¸¤ä¸ªmovqï¼›ä¸”æ ¹æ®æœºå™¨çš„å­—èŠ‚é¡ºåºï¼Œæ¥å†³å®šå…ˆæ”¾é«˜ä½è¿˜æ˜¯å…ˆæ”¾ä½ä½

### DIV

æœ‰ç¬¦å·æ•°é™¤æ³•æŒ‡ä»¤idivqæ˜¯å•æ“ä½œæ•°æŒ‡ä»¤ï¼Œ`idivq S`æ˜¯å°†R\[%rdx]:R\[%rax]ç»„æˆçš„128ä½æœ‰ç¬¦å·æ•°é™¤ä»¥Sè®¡ç®—å¾—åˆ°çš„å•†æ”¾R\[%rax]ï¼Œä½™æ•°æ”¾R\[%rdx]

> cqtoæŒ‡ä»¤â€”â€”è¯»å–R\[%rax]çš„ç¬¦å·ä½ï¼Œå¹¶å¤åˆ¶åˆ°R\[%rdx]æ‰€æœ‰ä½ï¼Œå®ç°128ä½çš„ç¬¦å·æ‰©å±•

> å½“è¢«é™¤æ•°æ˜¯64ä½å€¼æ—¶ï¼Œè¿™ä¸ªå€¼åº”è¯¥å­˜æ”¾åœ¨R\[%rax]ä¸­ï¼ŒR\[%rdx]çš„æ‰€æœ‰ä½åº”è¯¥è®¾ä¸ºå…¨0(æ— ç¬¦å·è¿ç®—)æˆ–è€…æ˜¯R\[%rax]çš„ç¬¦å·ä½(æœ‰ç¬¦å·è¿ç®—)â€”â€”ä½¿ç”¨cqtoæŒ‡ä»¤å®ç°
>
> æ— ç¬¦å·æ•°é™¤æ³•ä½¿ç”¨`divq`æŒ‡ä»¤ï¼Œå¯„å­˜å™¨`%rdx`éœ€è¦äº‹å…ˆæ¸…0

![](image/image_WG5IZE8cal.png)

# 3.6 *Control*

> ğŸ³æœºå™¨ä»£ç æä¾›ä¸¤ç§åŸºæœ¬çš„ä½çº§æœºåˆ¶æ¥å®ç°æœ‰æ¡ä»¶çš„è¡Œä¸ºï¼šæµ‹è¯•æ•°æ®å€¼ï¼Œç„¶åæ ¹æ®æµ‹è¯•çš„ç»“æœæ¥æ”¹å˜æ§åˆ¶æµæˆ–è€…æ•°æ®æµ

## 3.6.1 *Conditions Codes*

é™¤äº†æ•´æ•°å¯„å­˜å™¨ä¹‹å¤–ï¼ŒCPU è¿˜ç»´æŠ¤ä¸€ç»„å•ä¸ªä½çš„æ¡ä»¶ç å¯„å­˜å™¨ï¼Œç”¨äºæè¿°æœ€è¿‘ç®—æœ¯æˆ–é€»è¾‘è¿ç®—çš„å±æ€§ï¼Œé€šè¿‡æ£€æµ‹è¿™äº›æ¡ä»¶ç æ¥è¿›è¡Œæ¡ä»¶åˆ†æ”¯ã€‚å…¶ä¸­æœ€å¸¸ç”¨çš„æ¡ä»¶ç å¦‚ä¸‹ï¼š

1.  CFï¼šè¿›ä½æ ‡å¿—ã€‚æœ€è¿‘çš„æ“ä½œä½¿å¾—æœ€é«˜ä½å‘ç”Ÿäº†è¿›ä½ï¼Œå¯ä»¥ç”¨äºæ£€æµ‹æ— ç¬¦å·æ•°åŠ æ³•çš„æº¢å‡º
2.  ZFï¼šé›¶æ ‡è¯†ã€‚æœ€è¿‘çš„æ“ä½œä½¿å¾—ç»“æœä¸º0
3.  SFï¼šç¬¦å·ä½ã€‚æœ€è¿‘çš„æ“ä½œä½¿å¾—ç»“æœä¸ºè´Ÿ
4.  OFï¼šæº¢å‡ºä½ã€‚æœ€è¿‘çš„æ“ä½œå¯¼è‡´å‡ºç°ä¸€ä¸ªè¡¥ç æº¢å‡ºâ€”â€”å¯èƒ½æ˜¯æ­£æº¢å‡ºä¹Ÿå¯èƒ½æ˜¯è´Ÿæº¢å‡º

ä»¥t=a+bä¸ºä¾‹ï¼Œè¡¨ç¤ºä¸Šè¿°çš„æ¡ä»¶ç å¦‚ä¸‹ï¼š

1.  $CF=(unsigned)t<(unsigned)a$
2.  $ZF=(t==0)$
3.  $SF=(t<0)$
4.  $OF=(a<0\&b<0\&t>0)|(a>0\&b>0\&t<0)$

> ğŸ³è™½ç„¶leaqæŒ‡ä»¤å¯ä»¥ç”¨æ¥åšä¸€äº›ç®€å•çš„åŠ æ³•å’Œä¹˜æ³•ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ”¹å˜æ¡ä»¶ç ã€‚é™¤æ­¤ä¹‹å¤–Figure3.10[ğŸ–¼ï¸ å›¾ç‰‡](image/image_4pqo0v1Q0g.png "ğŸ–¼ï¸ å›¾ç‰‡")ä¸­çš„æ‰€æœ‰æŒ‡ä»¤å‡ä¼šæ”¹å˜æ¡ä»¶ç 
>
> 1.  å¯¹äºé€»è¾‘æŒ‡ä»¤ORã€ANDã€XORï¼Œä¼šè®¾ç½®CFå’ŒOFä¸º0
> 2.  å¯¹äºç§»ä½æŒ‡ä»¤ï¼ŒCFè®¾ç½®ä¸ºæœ€åä¸€ä¸ªè¢«ç§»å‡ºçš„ä½ï¼Œè€ŒOFè®¾ç½®ä¸º0
> 3.  INCã€DECæŒ‡ä»¤ä¼šè®¾ç½®OFå’ŒZFï¼Œä½†æ˜¯ä¸æ”¹å˜CF

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸¤ä¸ªæŒ‡ä»¤ç±»åªæ”¹å˜æ¡ä»¶ç è€Œä¸æ”¹å˜ä»»ä½•å…¶ä»–å¯„å­˜å™¨

1.  CMPæŒ‡ä»¤ç±»

    ![](image/image_3P3wQ_Yo-2.png)

    cmpç±»æŒ‡ä»¤æ‰§è¡Œçš„è¡Œä¸ºåŒsubæŒ‡ä»¤ï¼Œä½†æ˜¯å¹¶ä¸å°†ç»“æœå†™å›ï¼Œè€Œæ˜¯åªæ ¹æ®ç»“æœæ¥è®¾ç½®æ¡ä»¶ç ã€‚ä¸”ä½¿ç”¨çš„æ˜¯ATTæ±‡ç¼–æ ¼å¼ï¼Œæ“ä½œæ•°æ˜¯å€’åºçš„ `cmp S1,S2â†’S2-S1`

    æ ¹æ®æ¡ä»¶ç çš„æƒ…å†µæ¥åˆ¤æ–­S1å’ŒS2çš„å¤§å°å…³ç³»ï¼šS2-S1

    æœ‰ç¬¦å·æ•°å°äºï¼šS2\<S1â†’SF^OF
    æœ‰ç¬¦å·æ•°å°äºç­‰äºï¼šS2â‰¤S1â†’SF^OF|ZF
    æœ‰ç¬¦å·æ•°å¤§äºï¼šS2>S1â†’\~(SF^OF)^\~ZF
    æœ‰ç¬¦å·æ•°å¤§äºç­‰äºï¼šS2â‰¥S1â†’\~(SF^OF)

    æ— ç¬¦å·æ•°å°äºï¼šS2\<S1â†’CF
    æ— ç¬¦å·æ•°å°äºç­‰äºï¼šS2â‰¤S1â†’CF|ZF
    æ— ç¬¦å·æ•°å¤§äºï¼šS2>S1â†’\~CF^\~ZF
    æ— ç¬¦å·æ•°å¤§äºç­‰äºï¼šS2â‰¥S1â†’\~CF
2.  TESTæŒ‡ä»¤ç±»

    ![](image/image_yKHNmll7GV.png)

    testç±»æŒ‡ä»¤æ‰§è¡Œçš„è¡Œä¸ºåŒandæŒ‡ä»¤ï¼Œä½†æ˜¯å¹¶ä¸å°†ç»“æœå†™å›ï¼Œè€Œæ˜¯åªæ ¹æ®ç»“æœè®¾ç½®æ¡ä»¶ç 

    testç±»æŒ‡ä»¤çš„ä½œç”¨ï¼š
    1.  ä¸€èˆ¬ç”¨æ¥åˆ¤æ–­æŸä¸ªå¯„å­˜å™¨å†…çš„å€¼æ˜¯è´Ÿæ•°ã€æ•´æ•°è¿˜æ˜¯0

        `test S1,S1`æ“ä½œæ•°é‡å¤ï¼Œåˆ™æ ¹æ®ç»“æœè®¾ç½®çš„æ¡ä»¶ç ï¼Œè‹¥ZF=1åˆ™S1ä¸º0ï¼›è‹¥SF=1åˆ™ç»“æœä¸ºè´Ÿï¼Œå¦åˆ™ä¸ºæ­£
    2.  æ©ç ä¸

        å°†å…¶ä¸­ä¸€ä¸ªæ“ä½œæ•°è®¾ç½®ä¸ºæ©ç æ¥è¿›è¡Œè®¡ç®—

## 3.6.2 *Accessing the Condition Codes*

é€šå¸¸ä¸èƒ½ç›´æ¥è¯»å–æ¡ä»¶ç ï¼Œè€Œæ˜¯ä½¿ç”¨ä¸‹é¢ä¸‰ç§æ–¹å¼æ¥ä½¿ç”¨æ¡ä»¶ç ï¼š

1.  å¯ä»¥é€šè¿‡æŒ‡ä»¤æ ¹æ®æ¡ä»¶ç çš„æŸç§ç»„åˆæ¥å°†ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º0æˆ–1

    æŒ‡ä»¤çš„åç¼€è¡¨ç¤ºçš„æ˜¯æ‰€è€ƒè™‘çš„ä¸åŒæ¡ä»¶ç çš„ç»„åˆ

    ![](image/image_31OAH4AjUs.png)
    > ğŸ³SETæŒ‡ä»¤åªäº§ç”Ÿ8ä½ç»“æœï¼ŒæŒ‡ä»¤ä¸­çš„Då¯ä»¥æ˜¯å†…å­˜æŸä¸ªå­—èŠ‚ä½ç½®ä¹Ÿå¯ä»¥æ˜¯å¯„å­˜å™¨çš„ä½8ä½ã€‚è‹¥è¦äº§ç”Ÿ16/32/64çš„ç»“æœï¼Œåˆ™éœ€è¦ä½¿ç”¨movzæŒ‡ä»¤å°†é«˜ä½0æ‰©å±•
    >
    > ä¸€èˆ¬æ¯”è¾ƒ64ä½aã€bå¤§å°çš„æŒ‡ä»¤åºåˆ—å¦‚ä¸‹ï¼š
    >
    > ```nasm
    > //int comp(data_t a,data_t b)
    > //a in %rdi,b in %rsi
    > comp:
    >   cmpq %rsi,%rdi //R[%rdi]-R[%rsi]
    >   setl %al
    >   movzbl %al,%eax//ä¸ä»…å¤ä½32ä½çš„å‰3ä¸ªå­—èŠ‚ï¼Œä¹Ÿå¤ä½64ä½çš„å‰4ä¸ªå­—èŠ‚
    >   ret
    > ```
2.  å¯ä»¥æ¡ä»¶è·³è½¬åˆ°ç¨‹åºçš„æŸä¸ªå…¶ä»–éƒ¨åˆ†â€”â€”æ¡ä»¶æ§åˆ¶
3.  å¯ä»¥æœ‰æ¡ä»¶åœ°ä¼ é€æ•°æ®â€”â€”æ¡ä»¶ä¼ é€

## 3.6.3 *Jump Instructions*

> *A jump instruction can cause the execution to switch to a completely new position in the program. These jump destinations are generally indicated in assembly code by a label*

![](image/image_GU0Ts-8QN5.png)

å·¦å›¾ä¸­åˆ—å‡ºäº†x86-64æ‰€æ”¯æŒçš„è·³è½¬æŒ‡ä»¤ã€‚å…¶ä¸­åŒ…æ‹¬æ— æ¡ä»¶è·³è½¬jmpæŒ‡ä»¤ä»¥åŠç»“åˆæ¡ä»¶ç çš„æŸç§ç»„åˆçš„jå‹æ¡ä»¶è·³è½¬æŒ‡ä»¤

jmpæŒ‡ä»¤å¯ä»¥åˆ†ä¸ºç›´æ¥è·³è½¬å’Œé—´æ¥è·³è½¬ä¸¤ç§

ç›´æ¥è·³è½¬ï¼šjmp label
é—´æ¥è·³è½¬ï¼šjmp \*Operand

jæŒ‡ä»¤å‡æ˜¯ç›´æ¥è·³è½¬

> ğŸ³åœ¨ç”Ÿæˆå¯é‡å®šä½çš„ç›®æ ‡ä»£ç æ–‡ä»¶æ—¶ï¼Œæ±‡ç¼–å™¨ä¼šç¡®å®šæ‰€æœ‰å¸¦æ ‡å·æŒ‡ä»¤çš„åœ°å€ï¼Œå¹¶å°†è¯¥åœ°å€ç¼–ç ä¸ºè·³è½¬æŒ‡ä»¤çš„ä¸€éƒ¨åˆ†ã€‚è€Œé‡‡ç”¨é—´æ¥è·³è½¬çš„jmpæŒ‡ä»¤åˆ™éœ€è¦è®¿é—®å¯„å­˜å™¨/å­˜å‚¨å™¨å¾—åˆ°è·³è½¬ç›®æ ‡åœ°å€

## 3.6.4 *Jump Instruction Encodings*

è·³è½¬ç›®æ ‡çš„ç¼–ç æ–¹å¼æœ‰ä¸¤ç§ï¼š

1.  **PCç›¸å¯¹ç¼–ç **[^æ³¨é‡Š10]ï¼šä½¿ç”¨è·³è½¬ç›®æ ‡åœ°å€ä»¥åŠè·³è½¬æŒ‡ä»¤åé¢é‚£æ¡æŒ‡ä»¤çš„åœ°å€ä¹‹é—´çš„å·®ä½œä¸ºç¼–ç 
2.  ç»å¯¹åœ°å€ï¼šç”¨4ä¸ªå­—èŠ‚ç›´æ¥æŒ‡å®šè·³è½¬ç›®æ ‡

ä»¥ä¸‹å›¾çš„æ±‡ç¼–ä»£ç ä¸ºä¾‹ï¼Œä»å·¦è‡³å³ä¾æ¬¡æ˜¯å…¶æºæ±‡ç¼–ä»£ç ã€å¯é‡å®šå‘ç›®æ ‡ä»£ç ä»¥åŠå¯æ‰§è¡Œæ–‡ä»¶

![](image/image_NCrBDPpqxP.png)

åœ¨å·¦å›¾æ±‡ç¼–ä»£ç ä¸­æœ‰ä¸¤æ¡è·³è½¬æŒ‡ä»¤ï¼Œå‡é‡‡ç”¨ç›´æ¥è·³è½¬çš„æ–¹å¼ã€‚é‡‡ç”¨PCç›¸å¯¹ç¼–ç 

ç¬¬ä¸€ä¸ªjmpæŒ‡ä»¤è¦è°ƒåˆ°.L2å³åœ°å€8å¤„ï¼Œè€Œå½“å‰è·³è½¬æŒ‡ä»¤çš„ä¸‹ä¸€æ¡åœ°å€æ˜¯5ï¼Œå› æ­¤è·³è½¬ç›®çš„ç¼–ç ä¸º03ï¼›ç¬¬äºŒä¸ªjgæŒ‡ä»¤è¦è·³è½¬åˆ°åœ°å€5å¤„ï¼Œè·³è½¬æŒ‡ä»¤çš„ä¸‹ä¸€æ¡åœ°å€æ˜¯dï¼Œå› æ­¤è·³è½¬ç›®çš„ç¼–ç ä¸º-8ï¼Œå³11111000b

åœ¨é“¾æ¥åçš„å¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼Œè¯¥ç¨‹åºå·²è¢«è£…é…åˆ°å†…å­˜ä¸­çš„æŸä¸ªä½ç½®å¤„ã€‚ä½†æ˜¯æŒ‡ä»¤æ‰€ç¼–ç çš„ç›®æ ‡åœ°å€å¹¶æ²¡æœ‰æ”¹å˜

## 3.6.5 *Implementing Conditional Branches with Conditional Control*

![](image/image_chcrZKriBF.png)

ä»¥ä¸Šè¿°ä»£ç ä¸ºä¾‹å±•ç¤ºCè¯­è¨€å’Œæ±‡ç¼–è¯­è¨€ä¸­çš„æ§åˆ¶åˆ†æ”¯è½¬æ¢

é€šè¿‡åˆ†æå¯ä»¥å¾—åˆ°Cä¸­çš„`if-else`è¯­å¥å—çš„æ±‡ç¼–è¡¨ç¤ºçš„æ§åˆ¶æµçš„ä¸€èˆ¬å½¢å¼ï¼š

```c
if (test-expr)
  then-statement
else
  else-statement
```

```c
  t =test-expr;
  if (!t)
    goto false;
  then-statement
  goto done;
false:
  else-statement
done:

//è¿™ç§ç»“æ„å¯¹äºæ²¡æœ‰elseçš„æƒ…å†µä¼šæ›´å¥½äº›
```

> &&ä»¥åŠ||çš„æœºå™¨ä»£ç 
>
> ![](image/image_PM0cWKvZsD.png)

## 3.6.6 *Implementing Conditional Branches with Conditional Moves*

> *The conventional way to implement conditional operations is through **a conditional transfer of control**, where the program follows one execution path when a condition holds and another when it does not. This mechanism is simple and general, but it can be very inefficient on modern processors. An alternate strategy is through*-   a conditional transfer of data.\* \*\****This approach computes both outcomes of a conditional operation and then selects one based on whether or not the condition holds***.This strategy makes sense only in restricted cases, but it can then be implemented by a simple conditional move instruction that is better matched to the performance characteristics of modern processors.

ä¸‹å›¾æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¡ä»¶ä¼ é€ç¼–è¯‘çš„ç¤ºä¾‹ä»£ç ï¼š

![](image/image_7StxFPyZi_.png)

è¿™ç§æ•°æ®æµçš„é£æ ¼å’Œæ§åˆ¶æµçš„é£æ ¼ä¸åŒç‚¹åœ¨äºï¼šæ•°æ®æµé£æ ¼åŒæ—¶è®¡ç®—äº†x-yå’Œy-xï¼›ç„¶åæ ¹æ®xå’Œyçš„å¤§å°å…³ç³»ï¼Œé€‰æ‹©æ˜¯å¦æ›´æ”¹å…¶ä¸­%raxæ‰€å­˜å‚¨çš„å€¼

ä¸ºäº†å®ç°è¿™ç§æœºåˆ¶ï¼Œé‡‡ç”¨äº†cmovgeæŒ‡ä»¤ï¼Œå³è‹¥ä¸Šä¸€æ¡cmpæŒ‡ä»¤ç»“æœæ˜¯å¤§äºç­‰äºï¼Œé‚£ä¹ˆå°±è¿›è¡Œèµ‹å€¼

### ä¸ºä»€ä¹ˆè¦ä½¿ç”¨æ¡ä»¶ä¼ é€

è‡³äºåŸºäºæ¡ä»¶æ•°æ®ä¼ è¾“çš„ä»£ç ä¸ºä»€ä¹ˆæ˜¯ä¼˜äºåŸºäºæ¡ä»¶æ§åˆ¶ä¼ è¾“çš„ä»£ç çš„åŸå› ï¼Œå¿…é¡»ç†è§£ç°ä»£å¤„ç†å™¨çš„å·¥ä½œåŸç†â€”â€”ä½¿ç”¨**æµæ°´**æ¥å®ç°é«˜æ€§èƒ½ã€‚å¯¹äºæµæ°´é‡åˆ°æ¡ä»¶åˆ†æ”¯æ—¶é‡‡ç”¨åˆ†æ”¯é¢„æµ‹æŠ€æœ¯ã€‚å½“åˆ†æ”¯é¢„æµ‹æˆåŠŸæ—¶ï¼Œä¼šæé«˜æ€§èƒ½ï¼›ä½†æ˜¯å½“åˆ†æ”¯é¢„æµ‹å¤±è´¥æ—¶ï¼Œæ€§èƒ½ä¼šä¸¥é‡é™ä½ã€‚è€Œå¦‚æœä½¿ç”¨æ¡ä»¶ä¼ é€ç¼–è¯‘ï¼Œé‚£ä¹ˆæ— è®ºæµ‹è¯•çš„æ•°æ®æ˜¯ä»€ä¹ˆï¼Œæ‰€éœ€çš„æ—¶é—´éƒ½çº¦æ˜¯8ä¸ªæ—¶é’Ÿå‘¨æœŸ

![](image/image_znpsI6s_fE.png)

$$
T=p\times T_{ok}+(1-p)\times (T_{ok}+T_{MP})=T_{ok}+(1-p)\times T_{MP}
$$

![](image/image_pM_puQtvej.png)

### æ¡ä»¶ä¼ é€æŒ‡ä»¤cmovç±»

![](image/image_a0ldv17tp4.png)

æ¯ä¸ªæ¡ä»¶ä¼ é€æŒ‡ä»¤éƒ½æœ‰ä¸¤ä¸ªæ“ä½œæ•°ï¼šSå’ŒRã€‚å…¶ä¸­Så¯ä»¥æ˜¯å¯„å­˜å™¨æˆ–è€…å­˜å‚¨å™¨ï¼ŒRåªèƒ½æ˜¯å¯„å­˜å™¨

æºå’Œç›®çš„å€¼å¯ä»¥æ˜¯16ã€32ã€64ä½ï¼Œä½†ä¸èƒ½æ˜¯å•å­—èŠ‚ã€‚å’Œæ— æ¡ä»¶ä¼ é€æ•°æ®å¤§å°ä»¥åç¼€çš„å½¢å¼è¡¨æ˜ä¸åŒï¼Œæ¡ä»¶ä¼ é€çš„æ•°æ®å¤§å°å–å†³äºç›®çš„å¯„å­˜å™¨ã€‚**åŒæ¡ä»¶è·³è½¬ä¸åŒï¼Œå¤„ç†å™¨æ— éœ€é¢„æµ‹æµ‹è¯•çš„ç»“æœå°±å¯ä»¥æ‰§è¡Œæ¡ä»¶ä¼ é€ï¼›å¤„ç†å™¨åªæ˜¯è¯»æºå€¼ï¼ˆå¯èƒ½æ˜¯ä»å†…å­˜ä¸­ï¼‰ï¼Œæ£€æŸ¥æ¡ä»¶ç ï¼Œç„¶åè¦ä¹ˆæ›´æ–°ç›®çš„å¯„å­˜å™¨ï¼Œè¦ä¹ˆä¿æŒä¸å˜**

### æ¡ä»¶ä¼ é€ç†è§£

ä»¥æ¡ä»¶è¡¨è¾¾å¼`v=test-expr?then-expr:else-expr;`ä¸ºä¾‹ï¼š

1.  è½¬å˜ä¸ºæ¡ä»¶æ§åˆ¶å½¢å¼
    ```c
      t=test-expr;
      if(!t)
        goto false;
      v=then-expr;
      goto done
    false:
      v=else-expr;
    done:
      
    ```
2.  è½¬å˜ä¸ºæ¡ä»¶ä¼ é€å½¢å¼
    ```c
    v=then-expr;
    vn=else-expr;
    t=test-expr;
    if (!t) v=vn;
    ```

#### æ¡ä»¶ä¼ é€çš„ç¼ºç‚¹

ä¸æ˜¯æ‰€æœ‰çš„éƒ½å¯ä»¥è½¬æ¢ä¸ºæ¡ä»¶ä¼ é€çš„å½¢å¼ã€‚æ¯”å¦‚ï¼Œå‰é¢æ±‚å€¼çš„è¡¨è¾¾å¼å‡ºç°é”™è¯¯æ¡ä»¶æˆ–è€…éæ³•å¼•ç”¨çš„æƒ…å†µï¼Œä»è€Œå¯¼è‡´éæ³•è¡Œä¸ºã€‚

![](image/image_3j3B8M6mr4.png)

å¦‚ä¸Šå›¾ï¼Œå½“rdiä¸ºç©ºæ—¶ï¼Œåœ¨ç¬¬2è¡Œå·²å‡ºç°å¯¹ç©ºçš„è§£å¼•ç”¨ï¼Œæ˜¯éæ³•è¡Œä¸º

è€Œä¸”æ¡ä»¶ä¼ é€å¹¶ä¸æ˜¯æ€»ä¼šæé«˜ä»£ç æ•ˆç‡ã€‚æ¯”å¦‚å¦‚æœè®¡ç®—then-exprå’Œelse-exprå¤ªè¿‡å¤æ‚ï¼Œé‚£ä¹ˆç¼–è¯‘å™¨å°±å¿…é¡»è€ƒè™‘æµªè´¹çš„è®¡ç®—å’Œç”±äºåˆ†æ”¯é¢„æµ‹é”™è¯¯æ‰€é€ æˆçš„æ€§èƒ½å¤„ç½šä¹‹é—´çš„ç›¸å¯¹æ€§èƒ½ã€‚

ä¸€èˆ¬æ ¹æ®ç»éªŒï¼Œ**åªæœ‰then-exprå’Œelse-expréƒ½å¾ˆå®¹æ˜“è®¡ç®—æ—¶æ‰é‡‡ç”¨æ¡ä»¶ä¼ é€ï¼›å³ä½¿åœ¨åˆ†æ”¯é”™è¯¯é¢„æµ‹çš„æˆæœ¬è¶…è¿‡æ›´å¤æ‚çš„è®¡ç®—çš„è®¸å¤šæƒ…å†µä¸‹ï¼Œgcc ä¹Ÿä½¿ç”¨æ¡ä»¶æ§åˆ¶ä¼ è¾“ã€‚**

## 3.6.7 Loops

> *C provides several looping constructsâ€”namely, do-while, while, and for.No corresponding instructions exist in machine code. **Instead, combinations of conditional tests and jumps are used to implement the effect of loops.** Gcc and other compilers generate loop code based on*-   the two basic loop patterns\*â€‹

### Do-While Loops

Do-whileæ ¼å¼å¾ªç¯çš„ä¸€èˆ¬æ ¼å¼å¦‚ä¸‹ï¼Œå®ƒä¼šé‡å¤æ‰§è¡Œbody-statementç›´åˆ°test-exprä¸ºfalseã€‚å› æ­¤Do-Whileå¾ªç¯è‡³å°‘æ‰§è¡Œä¸€æ¬¡

```c
do
   body-statement 
while (test-expr);
```

å°†Do-Whileçš„Cæ ¼å¼ç¿»è¯‘ä¸ºç±»æ±‡ç¼–è¯­è¨€çš„æ ¼å¼å¦‚ä¸‹ï¼š

```nasm
loop:
  body-statement
test:
  t=test-expr;
  if(t)
     goto loop

```

### While Loops

whileå¾ªç¯çš„ä¸€èˆ¬æ ¼å¼å¦‚ä¸‹ï¼Œä¸do-whileä¸åŒçš„æ˜¯å®ƒé¦–å…ˆæ£€æµ‹test-expræ˜¯å¦æˆç«‹ã€‚GCCä¸€èˆ¬é‡‡ç”¨ä¸¤ç§æ–¹å¼[^æ³¨é‡Š11]æ¥å°†Whileå¾ªç¯è½¬æ¢ä¸ºæœºå™¨ä»£ç 

```c
while(test-expr)
  body-statement

```

1.  è·³è½¬åˆ°ä¸­é—´[^æ³¨é‡Š12]

    è·³è½¬åˆ°ä¸­é—´çš„æ–¹æ³•æ˜¯é€šè¿‡æ‰§è¡Œæ— æ¡ä»¶è·³è½¬åˆ°å¾ªç¯æœ«å°¾çš„æµ‹è¯•[^æ³¨é‡Š13]æ¥æ‰§è¡Œåˆå§‹æµ‹è¯•ã€‚å…¶ä¸€èˆ¬ç»“æ„å¦‚ä¸‹ï¼š
    ```nasm
      goto test
    loop:
      body-statement
    test:  
      t=test-expr;
      if(t)
         goto loop
    ```
2.  å—ä¿æŠ¤çš„do[^æ³¨é‡Š14]

    å—ä¿æŠ¤çš„doçš„æ–¹æ³•æ˜¯é€šè¿‡åœ¨do-whileå‰åŠ ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯æ¥å…ˆåˆ¤æ–­æ˜¯å¦æ»¡è¶³å¾ªç¯æ¡ä»¶ï¼Œç„¶åå†do-whileã€‚å…¶ä¸€èˆ¬ç»“æ„å¦‚ä¸‹ï¼š
    ```nasm
      t=test-expr;
      if(!t)
        goto done;
    loop:
       body-statement
    test:  
      t=test-expr;
      if(t)
         goto loop;
    done:

    ```

> âœ¨-0gä¼˜åŒ–ä½¿ç”¨è·³è½¬åˆ°ä¸­é—´çš„æ–¹æ³•ï¼Œ-1gé‡‡ç”¨å—ä¿æŠ¤çš„doæ–¹æ³•

### For Loops

forå¾ªç¯çš„é€šè¿‡Cè¯­è¨€æ ¼å¼å¦‚ä¸‹ï¼Œä¸”Cè¯­è¨€æ ‡å‡†è§„å®šforå¾ªç¯å¯ä»¥ç­‰ä»·ä¸ºå…¶ä¸‹çš„whileå¾ªç¯(æœ‰ä¸€ä¸ªä¾‹å¤–)

```c
for(init-expr;test-expr;update-expr){
  body-statement;
}

init-expr;
while(test-expr){
  body-statement;
  update-expr;
}
```

GCCç¼–è¯‘forå¾ªç¯æ ¹æ®æ‰€é‡‡ç”¨çš„ä¼˜åŒ–è§„åˆ™éµå¾ªWhileå¾ªç¯çš„â€œè·³è½¬åˆ°ä¸­é—´â€/â€œå—ä¿æŠ¤çš„doâ€çš„æ–¹æ³•ä¹‹ä¸€ï¼Œå…¶å¯¹åº”çš„gotoä»£ç å¦‚ä¸‹ï¼š

```nasm
//è·³è½¬åˆ°ä¸­é—´
  init-expr
  goto test
loop:
  body-statement
test:  
  t=test-expr;
  if(t)
     goto loop
     
//å—ä¿æŠ¤çš„do
  init-expr
  t=test-expr;
  if(!t)
    goto done;
loop:
   body-statement
test:  
  t=test-expr;
  if(t)
     goto loop;
done:
```

## 3.6.8 Switch Statements

switchè¯­å¥å¯ä»¥æ ¹æ®ä¸€ä¸ªæ•´æ•°ç´¢å¼•å€¼è¿›è¡Œå¤šé‡åˆ†æ”¯ã€‚åŒæ—¶å¯ä»¥ä½¿ç”¨è·³è½¬è¡¨è¿™ç§æ•°æ®ç»“æœä½¿å¾—switchæ›´åŠ é«˜æ•ˆã€‚

å’Œä½¿ç”¨ä¸€ç»„å¾ˆé•¿çš„if-elseè¯­å¥ç›¸æ¯”ï¼Œä½¿ç”¨è·³è½¬è¡¨çš„ä¼˜ç‚¹æ˜¯æ‰§è¡Œå¼€å…³è¯­å¥çš„æ—¶é—´ä¸å¼€å…³æƒ…å†µçš„æ•°é‡æ— å…³[^æ³¨é‡Š15]ã€‚GCCæ ¹æ®å¼€å…³æƒ…å†µçš„æ•°é‡å’Œå¼€å…³æƒ…å†µå€¼çš„ç¨€ç–ç¨‹åº¦æ¥ç¿»è¯‘å¼€å…³è¯­å¥ã€‚å½“å¼€å…³æƒ…å†µæ•°é‡æ¯”è¾ƒå¤šï¼ˆä¾‹å¦‚4ä¸ªä»¥ä¸Šï¼‰ï¼Œå¹¶ä¸”å€¼çš„èŒƒå›´è·¨åº¦æ¯”è¾ƒå°æ—¶ï¼Œå°±ä¼šä½¿ç”¨è·³è½¬è¡¨[^æ³¨é‡Š16]ã€‚

![](image/image_yuQmTMJ6La.png)

ä¸‹å›¾ä¸ºswitchçš„Cè¯­è¨€ç¤ºä¾‹ï¼Œä»¥åŠå…¶å¯¹åº”çš„æ±‡ç¼–ç¨‹åº(-0gä¼˜åŒ–)

![](image/image_T1s9YuKDdM.png)

å¯ä»¥çœ‹åˆ°ï¼Œæ— è®ºæœ‰å¤šå°‘ä¸ªåˆ†æ”¯ã€‚éƒ½æ˜¯æ ¹æ®`goto *jt[index]`æ¥ç›´æ¥è·³è½¬ã€‚è€Œä¸éœ€è¦ç»è¿‡å¤šæ¬¡åˆ†æ”¯ã€‚å› æ­¤â€œä½¿ç”¨è·³è½¬è¡¨çš„ä¼˜ç‚¹æ˜¯æ‰§è¡Œå¼€å…³è¯­å¥çš„æ—¶é—´ä¸å¼€å…³æƒ…å†µçš„æ•°é‡æ— å…³[^æ³¨é‡Š15]ã€‚â€

è€Œæ±‡ç¼–ä¸­goto \*jt\[index]çš„å®ç°æ˜¯ä½¿ç”¨jmpæŒ‡ä»¤ `jmp *.L4(,%rsi,8)`å³è·³è½¬è¡¨åŸºå€æ˜¯.L4æ ‡å·ä½ç½®ï¼Œæ¯ä¸€ä¸ªè¡¨é¡¹8B,%rsiä¸ºè¡¨ç´¢å¼•

> ä¹ é¢˜
>
> ![](image/image_lPlKIQTbd1.png)
>
> +1ä»¥ååœ¨0\~8ï¼Œé‚£ä¹ˆå‡1å°±åœ¨-1\~7
>
> å’Œ8æ¯”è¾ƒåï¼Œå¤§äº8çš„è·³è½¬åˆ°.L2é»˜è®¤ä½ç½®ï¼Œè€Œ3å’Œ6ä¹Ÿè·³è½¬åˆ°-2ï¼Œè¯´æ˜æ²¡æœ‰å¯¹åº”é¡¹
>
> åˆ™switchå†…çš„æ ‡å·æœ‰â€œ-1ã€0ã€1ã€2ã€4ã€5ã€7â€

# 3.7 Procedures

> *Procedures are a key abstraction in software. They provide a way to package code that implements some functionality with a designated set of arguments and an optional return value.*

å½“ä¸ºè¿‡ç¨‹æä¾›æœºå™¨çº§åˆ«çš„æ”¯æŒæ—¶ï¼Œéœ€è¦å¤„ç†å¾ˆå¤šä¸åŒçš„å±æ€§

å‡è®¾è¿‡ç¨‹Pè°ƒç”¨è¿‡ç¨‹Qï¼Œè¿‡ç¨‹Qæ‰§è¡Œå®Œåè¿”å›è¿‡ç¨‹Pçš„æ‰§è¡Œï¼Œé‚£ä¹ˆä¼šæ¶‰åŠåˆ°ä¸‹åˆ—çš„ä¸€ä¸ªæˆ–å¤šä¸ªæœºåˆ¶ï¼š

1.  æ§åˆ¶ä¼ é€’ï¼šç¨‹åºè®¡æ•°å™¨å¿…é¡»è¿›å…¥Qç¨‹åºæ—¶æ—¶è®¾ç½®ä¸º Q ä»£ç çš„èµ·å§‹åœ°å€ï¼Œç„¶ååœ¨Qç¨‹åºè¿”å›æ—¶è®¾ç½®ä¸ºè°ƒç”¨ Q åçš„ P ä¸­çš„æŒ‡ä»¤
2.  æ•°æ®ä¼ é€’ï¼šP å¿…é¡»èƒ½å¤Ÿå‘ Q æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œå¹¶ä¸” Q å¿…é¡»èƒ½å¤Ÿå°†ä¸€ä¸ªå€¼è¿”å›ç»™ P
3.  å†…å­˜çš„åˆ†é…å’Œå›æ”¶ï¼šQ å¯èƒ½éœ€è¦åœ¨å¼€å§‹æ—¶ä¸ºå±€éƒ¨å˜é‡åˆ†é…ç©ºé—´ï¼Œç„¶ååœ¨è¿”å›ä¹‹å‰é‡Šæ”¾è¯¥å­˜å‚¨ç©ºé—´

> *Great effort has been made to minimize the overhead involved in invoking a procedure. As a consequence, it follows what can be seen as a minimalist strategy, implementing only as much of the above set of mechanisms as is required for each particular procedure*

P å¿…é¡»èƒ½å¤Ÿå‘ Q æä¾›ä¸€ä¸ªæˆ–å¤šä¸ªå‚æ•°ï¼Œå¹¶ä¸” Q å¿…é¡»èƒ½å¤Ÿå°†ä¸€ä¸ªå€¼è¿”å›ç»™ Pã€‚

## 3.7.1\* The Run-Time Stack\*

### æ ˆåŸºç¡€

ç¨‹åºå¯ä»¥ä½¿ç”¨å †æ ˆæ¥ç®¡ç†å…¶ç¨‹åºæ‰€éœ€çš„å­˜å‚¨ï¼Œå…¶ä¸­å †æ ˆå’Œç¨‹åºå¯„å­˜å™¨å­˜å‚¨ä¼ é€’æ§åˆ¶å’Œæ•°æ®ä»¥åŠåˆ†é…å†…å­˜æ‰€éœ€çš„ä¿¡æ¯ã€‚éšç€Pè°ƒç”¨Qï¼Œæ§åˆ¶å’Œæ•°æ®ä¿¡æ¯è¢«æ·»åŠ åˆ°æ ˆçš„æœ«å°¾ã€‚å½“Pè¿”å›æ—¶ï¼Œè¿™äº›ä¿¡æ¯å¾—åˆ°äº†é‡æ–°åˆ†é…

åœ¨x86-64ä¸­ï¼Œæ ˆå­˜æ”¾åœ¨å†…å­˜ä¸­çš„æŸä¸ªåŒºåŸŸã€‚é‡‡ç”¨**å‘ä¸‹å¢é•¿****çš„åŸåˆ™ä½¿å¾—****æ ˆé¡¶å…ƒç´ çš„åœ°å€æ˜¯æ‰€æœ‰æ ˆä¸­å…ƒç´ åœ°å€æœ€ä½çš„**â€”â€”ä½†æ˜¯æ ¹æ®æƒ¯ä¾‹ï¼Œç”»æ ˆæ—¶æ ˆé¡¶åœ¨æœ€ä¸‹ç«¯ï¼Œé‡‡ç”¨å‘ä¸Šå¢é•¿

å¦‚3.4.4èŠ‚æ‰€è¿°ï¼Œx86-64çš„æ ˆæ˜¯å‘ä½åœ°å€å¤„å¢é•¿ï¼Œæ ˆæŒ‡é’ˆ%rspæŒ‡å‘æ ˆé¡¶ç«¯â€”â€”æ‰€æœ‰å…ƒç´ ä¸­åœ°å€æœ€ä½ã€‚é€šè¿‡pushqå’Œpopqæ¥å­˜å‚¨æ•°æ®å’Œä»æ ˆä¸­å–å‡ºâ€”â€”å‡æ ˆæŒ‡é’ˆå­˜å‚¨ï¼ŒåŠ æ ˆæŒ‡é’ˆé‡Šæ”¾

### æ ˆç»“æ„

å½“x86 - 64ç¨‹åºéœ€è¦çš„å­˜å‚¨è¶…å‡ºå¯„å­˜å™¨æ‰€èƒ½å®¹çº³çš„èŒƒå›´æ—¶ï¼Œå®ƒä¼šåœ¨å †æ ˆä¸Šåˆ†é…ç©ºé—´ã€‚è¿™ä¸ªåŒºåŸŸè¢«ç§°ä¸ºè¯¥è¿‡ç¨‹çš„æ ˆå¸§

ä¸‹å›¾å³ä¸ºè¿‡ç¨‹Pè°ƒç”¨è¿‡ç¨‹Qæ—¶ï¼Œä¸ºè¿‡ç¨‹På’Œè¿‡ç¨‹Qåˆ†é…çš„æ ˆå¸§

![](image/image_2q9X90jwDI.png)

æœ€æ–°è¿‡ç¨‹çš„æ ˆå¸§æ€»æ˜¯ä½äºæ ˆé¡¶

å½“è¿‡ç¨‹Pè°ƒç”¨è¿‡ç¨‹Qæ—¶ï¼Œéœ€è¦å‹æ ˆpushqä¿å­˜è¿”å›åœ°å€ã€‚æˆ‘ä»¬è€ƒè™‘å°†è¿”å›åœ°å€ä½œä¸ºPæ ˆå¸§çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºè¿”å›åœ°å€ä¸Pç›¸å…³ã€‚

ä¹‹åæ“ä½œç³»ç»Ÿé€šè¿‡å‡å°æ ˆæŒ‡é’ˆä¸ºè¿‡ç¨‹Qåˆ†é…å›ºå®šå¤§å°çš„æ ˆå¸§ã€‚è¿™éƒ¨åˆ†ç©ºé—´å¯ä»¥ç”¨æ¥å­˜å‚¨è¿‡ç¨‹Qçš„å—ä¿æŠ¤æ€§çš„å¯„å­˜å™¨ã€å±€éƒ¨å˜é‡å’ŒPä¼ æ¥çš„æœ€å¤š6ä¸ªå‚æ•°

å¦‚æœå‚æ•°å¤§äº6ä¸ªï¼Œé‚£ä¹ˆå¤šä½™çš„å‚æ•°å­˜å‚¨åœ¨Pæ ˆå¸§ä¸­â€”â€”å€’å…¥æ ˆ

ä½†æ˜¯å‡ºäºæ—¶é—´å’Œç©ºé—´æ•ˆç‡çš„è€ƒè™‘ï¼Œx86-64ä¸ºè¿‡ç¨‹åªåˆ†é…å…¶éœ€è¦çš„æ ˆå¸§çš„æŸéƒ¨åˆ†ã€‚ä¾‹å¦‚å½“å‚æ•°å°‘äº6ä¸ªæ—¶ï¼Œè°ƒç”¨è€…æ ˆå¸§å°±ä¸å†éœ€è¦ä¿å­˜å¤šä½™çš„å‚æ•°ï¼›å½“æ‰€æœ‰çš„å‚æ•°ã€å±€éƒ¨å˜é‡éƒ½å¯ä»¥ç”¨å¯„å­˜å™¨è¡¨ç¤ºæ—¶ï¼Œè¢«è°ƒç”¨æ ˆå¸§ä¹Ÿä¸éœ€è¦ä¿å­˜å±€éƒ¨å˜é‡äº†

<https://www.cnblogs.com/czw52460183/p/10320393.html>

## 3.7.2 *Control Transfer*

è¿‡ç¨‹På’Œè¿‡ç¨‹Qä¹‹é—´æ§åˆ¶çš„è½¬ç§»ä¸»è¦æ˜¯â€œè®¾ç½®PCï¼Œä¿å­˜è¿”å›åœ°å€â€ä»¥åŠâ€œå¼¹å‡ºè¿”å›åœ°å€å¹¶è®¾ç½®PCâ€ï¼Œåˆ†åˆ«é€šè¿‡`call`æŒ‡ä»¤å’Œ`ret`æŒ‡ä»¤æ¥å®ç°

callæŒ‡ä»¤å’ŒretæŒ‡ä»¤çš„é€šç”¨å½¢å¼å¦‚ä¸‹ï¼š

![](image/image_Ah5MoB1yYm.png)

> âœ¨callæŒ‡ä»¤ä¼šå°†Labelæ‰€è¡¨ç¤ºçš„PCç›¸å¯¹å¯»å€ä»¥åŠæ“ä½œæ•°è¡¨ç¤ºçš„å€¼é€PCï¼Œå¹¶ä¿å­˜PC+8å…¥æ ˆï¼›
> retæŒ‡ä»¤ä¼šå¼¹å‡ºcallæ‰€ä¿å­˜çš„PC+8ï¼Œå¹¶å°†è¯¥å€¼é€PC

## 3.7.3 *Data Transfer*

> In addition to passing control to a procedure when called, and then back again when the procedure returns, procedure calls may involve passing data as arguments, and returning from a procedure may also involve returning a value.

1.  åœ¨x86-64ä¸­è¿‡ç¨‹è°ƒç”¨æ—¶çš„æ•°æ®ä¼ é€’å¤§å¤šéƒ½æ˜¯é€šè¿‡å¯„å­˜å™¨è¿›è¡Œçš„

    ä½†æ˜¯åœ¨x86-64ä¸­æœ€å¤šåªèƒ½æœ‰6ä¸ªæ•´æ•°/æŒ‡é’ˆå‚æ•°ï¼ˆæ•°æ®å¤§å°å¯ä»¥æ˜¯64ã€32ã€16ã€8ä½ï¼‰å¯ä»¥é€šè¿‡å¯„å­˜å™¨ä¼ é€’ï¼Œä¸”è¿™6ä¸ªå¯„å­˜å™¨çš„ä½¿ç”¨é¡»éµå¾ªä¸€ä¸ªç‰¹å®šçš„é¡ºåºï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

    ![](image/image_nkx61XqLVD.png)
2.  å½“ä¼ é€’çš„å‚æ•°å¤§äº6ä¸ªæ—¶ï¼Œå¤šä½™çš„å‚æ•°å¿…é¡»ä½¿ç”¨æ ˆæ¥ä¼ é€’

    å‡è®¾è¿‡ç¨‹Pè°ƒç”¨è¿‡ç¨‹Qå¹¶ä¸”éœ€è¦ä¼ é€’nä¸ªå‚æ•°(n>6)ï¼Œé‚£ä¹ˆPè¿‡ç¨‹å¿…é¡»åœ¨å®ƒçš„æ ˆå¸§ä¸Šåˆ†é…ä¸€ä¸ªè¶³å¤Ÿå®¹çº³å‚æ•°7\~nçš„ç©ºé—´ï¼ˆå‚æ•°æ„å»ºåŒºåŸŸï¼‰ï¼Œä¸”å‚æ•°7ä½äºæ ˆé¡¶ã€‚å› ä¸ºæ‰€æœ‰å‚æ•°çš„å¤§å°æ˜¯ä»¥8Bå¯¹é½çš„ï¼Œæ‰€ä»¥å¯ä»¥è®¡ç®—æ ˆå¸§ä¸­å­˜å‚¨å‚æ•°çš„å¤§å°ä¸º$(n-7+1)\times8 B$

## 3.7.4 *Local Storage on the Stack*

ä¹‹å‰æ‰€æœ‰çš„å‡½æ•°å®ä¾‹å¹¶æ²¡æœ‰è¦æ±‚ä»»ä½•è¶…å‡ºå¯„å­˜å™¨å¤–çš„æœ¬åœ°å­˜å‚¨å†…å­˜ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸‹é¢è¿™äº›æƒ…å†µå‘ç”Ÿæ—¶å±€éƒ¨å˜é‡å¿…é¡»å­˜å‚¨åœ¨å†…å­˜ä¸­å³[ğŸ–¼ï¸ å›¾ç‰‡](image/image_wsWvVjURXe.png "ğŸ–¼ï¸ å›¾ç‰‡")ä¸­çš„â€œLocal Variablesâ€ï¼š

1.  æ²¡æœ‰è¶³å¤Ÿçš„å¯„å­˜å™¨æ¥ä¿å­˜å…¨éƒ¨çš„å±€éƒ¨å˜é‡
2.  è¦ä½¿ç”¨åœ°å€è¿œç®—ç¬¦â€œ&â€çš„å±€éƒ¨å˜é‡
3.  ä¸€äº›æ˜¯æ•°ç»„/ç»“æ„ä½“çš„å±€éƒ¨å˜é‡å¿…é¡»ç”¨æ•°ç»„ã€ç»“æ„ä½“å¼•ç”¨æ¥è®¿é—®

## 3.7.5\* Local Storage in Registers\*

> *The set of program registers acts as a single resource shared by all of the procedures. Although only one procedure can be active at a given time, we must make sure that when one procedure (the caller) calls another (the callee), the callee does not overwrite some register value that the caller planned to use later.*

åŸºäºä»¥ä¸Šçš„åŸå› ï¼Œx86-64é‡‡ç”¨äº†ä¸€å¥—ç»Ÿä¸€çš„å¯„å­˜å™¨ä½¿ç”¨çº¦å®šï¼Œæ‰€æœ‰ç¨‹åºï¼ˆåŒ…æ‹¬ç¨‹åºåº“ä¸­çš„ç¨‹åºï¼‰éƒ½å¿…é¡»éµå®ˆè¿™äº›çº¦å®šã€‚

1.  è¢«è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨

    æŒ‰ç…§çº¦å®šï¼Œå¯„å­˜å™¨` %rbx`ã€`%rbp` å’Œ `%r12~%r15` è¢«åˆ†ç±»ä¸ºè¢«è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨

    è¢«è°ƒç”¨è€…å¯¹äºè¿™äº›å¯„å­˜å™¨ï¼Œè¦ä¹ˆæ ¹æœ¬ä¸æ›´æ”¹å¯„å­˜å™¨å€¼ï¼›è¦ä¹ˆå°†åŸå§‹å€¼å‹å…¥å †æ ˆï¼Œæ›´æ”¹å®ƒï¼Œç„¶ååœ¨è¿”å›ä¹‹å‰ä»å †æ ˆä¸­å¼¹å‡ºæ—§å€¼æ¥ä¿ç•™å¯„å­˜å™¨å€¼â€”â€”ä¼šåœ¨æ ˆå¸§ä¸­åˆ›å»ºâ€œSaved Registersâ€åŒºåŸŸ[ğŸ–¼ï¸ å›¾ç‰‡](image/image_3bB4gRHu_W.png "ğŸ–¼ï¸ å›¾ç‰‡")
    > *With this convention, the code for P can safely store a value in a callee-saved register (**after saving the previous value on the stack, of course*[^æ³¨é‡Š17]*), call Q, and then use the value in the register without risk of it having been corrupted.*
2.  è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨

    é™¤äº†è¢«è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨[^æ³¨é‡Š18]ä»¥åŠ%rspï¼Œå…¶ä»–å¯„å­˜å™¨éƒ½ç§°ä¸ºâ€œè°ƒç”¨è€…ä¿æŠ¤å¯„å­˜å™¨â€

    è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨æ˜¯æŒ‡ä¿æŠ¤è¿™äº›å†…å®¹çš„è´£ä»»å–å†³äºè°ƒç”¨è€…â€”â€”åœ¨callæŒ‡ä»¤ä¹‹å‰å°±éœ€è¦å…¥æ ˆä¿å­˜è¿™äº›å¯„å­˜å™¨ä¸­çš„æ•°æ®ï¼›è€Œè¢«è°ƒç”¨è€…å¯ä»¥è‡ªç”±åœ°ä½¿ç”¨è¿™äº›å¯„å­˜å™¨ï¼Œ

## 3.7.6 *Recursive Procedures*

ä½¿ç”¨â€œè¢«è°ƒç”¨è€…ä¿å­˜çš„â€çš„å¯„å­˜å™¨ä¿å­˜é€’å½’æ§åˆ¶ä¿¡æ¯

![](image/image_Q6ZrgtdGRi.png)

# 3.8 *Array Allocation and Access*

> *Arrays in C are one means of aggregating scalar data into larger data types. C uses a particularly simple implementation of arrays, and hence the translation into machine code is fairly straightforward. One unusual feature of C is that we can generate pointers to elements within arrays and perform arithmetic with these pointers. These are translated into address computations in machine code. Optimizing compilers are particularly good at simplifying the address computations used by array indexing. This can make the correspondence between the C code and its translation into machine code somewhat difficult to decipher.*

## 3.8.1 *Basic Principles*

å¯¹äºæ•°æ®ç±»å‹Tå’Œæ•´æ•°å¸¸é‡Nï¼Œå½¢å¦‚$T \space A[N]$ä¼šæœ‰ä¸¤ä¸ªä½œç”¨ï¼š

1.  è¯¥å£°æ˜ä½¿å¾—åœ¨å†…å­˜ä¸­åˆ†é…äº†ä¸€å—å¤§å°ä¸º$L\times N$å­—èŠ‚çš„åŒºåŸŸï¼Œå…¶ä¸­Lä¸ºç±»å‹Tçš„å¤§å°
2.  è¯¥å£°æ˜è¡¨ç¤ºäº†ä¸€ä¸ªå¯ä»¥è¢«ç”¨ä½œæŒ‡æ˜æ•°ç»„å¼€å§‹ä½ç½®çš„æŒ‡é’ˆçš„æ ‡è¯†ç¬¦Aï¼Œå…¶å€¼ç­‰äºæ•°ç»„åœ¨å†…å­˜ä¸­çš„èµ·å§‹åœ°å€$x_A$ã€‚ä»è€Œä½¿å¾—æ•°ç»„å…ƒç´ å­˜å‚¨åœ¨$x_A+L\times i,(0\leq i \leq N-1)$ä½ç½®ä¸Šï¼Œä¹Ÿå¯ä»¥é€šè¿‡$A[i]$æ¥è®¿é—®

ä½¿ç”¨ç¼©æ”¾å˜å€ç´¢å¼•æ¥è®¿é—®æ•°ç»„å…ƒç´ ï¼š

å‡è®¾æ•°æ®ç±»å‹é•¿åº¦ä¸ºLï¼Œèµ·å§‹ä½ç½®ä¸º$x_A$å­˜å‚¨åœ¨%rdxä¸­ï¼Œç´¢å¼•iå­˜æ”¾åœ¨%rcxä¸­ï¼Œåˆ™å¯ä»¥å¾—åˆ°

`movb/w/l/q (%rdx,%rcx,L),%al/%ax/%eax%rax`

## 3.8.2 *Pointer Arithmetic*

C å…è®¸å¯¹æŒ‡é’ˆè¿›è¡Œç®—æœ¯ï¼Œå…¶ä¸­è®¡ç®—å€¼æ ¹æ®æŒ‡é’ˆå¼•ç”¨çš„æ•°æ®ç±»å‹çš„å¤§å°è¿›è¡Œç¼©æ”¾ï¼Œå³

å‡è®¾pæ˜¯æŒ‡å‘æ•°æ®ç±»å‹Tçš„ä¸€ä¸ªæŒ‡é’ˆï¼Œå…¶å€¼æ˜¯$x_p$ï¼Œåˆ™è¡¨è¾¾å¼`p+i`å€¼ä¸º$x_p+L\times i$ï¼ŒLä¸ºTç±»å‹çš„é•¿åº¦

ä¸€å…ƒè¿ç®—ç¬¦`&`å’Œ`*`å¯ä»¥å®ç°æŒ‡é’ˆçš„ç”Ÿæˆå’Œè§£å¼•ç”¨

å³å¯¹äºè¡¨ç¤ºæŸä¸ªå¯¹è±¡çš„è¡¨è¾¾å¼Exprï¼Œ`&Expr`æ˜¯äº§ç”Ÿä¸€ä¸ªæŒ‡å‘è¯¥Exprçš„æŒ‡é’ˆï¼Œå…¶å€¼ä¸º`AExpr`â€”â€”Exprçš„åœ°å€ï¼Œè€Œ`*AExpr`ç»™å‡ºè¿™ä¸ªåœ°å€ä¸Šçš„å€¼ã€‚å› æ­¤`Expr==*&Expr`

æ•°ç»„ä¸‹æ ‡æ“ä½œæ—¢å¯ä»¥ç”¨äºæ•°ç»„ï¼Œä¹Ÿå¯ä»¥ç”¨äºæŒ‡é’ˆ

`A[i]â†â†’*(A+i)`

å‡è®¾æ•°ç»„Eï¼Œå’Œæ•´æ•°ç´¢å¼•iåˆ†åˆ«å­˜å‚¨åœ¨%rdxã€%rcxä¸­ï¼›ç»“æœå­˜æ”¾åœ¨%eax(data)å’Œ%rax(pointer)ï¼Œå¯ä»¥å¾—åˆ°ï¼š

![](image/image_9YYgIw968g.png)

ä»æœ€åä¸€ä¸ªä¾‹å­ä¸­å¯ä»¥å¾—åˆ°ï¼šæŒ‡å‘åŒä¸€ä¸ªæ•°æ®å¯¹è±¡çš„ä¸¤ä¸ªæŒ‡é’ˆä½œå·®ï¼Œå…¶å€¼æ˜¯ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘çš„åœ°å€å·®å€¼é™¤ä»¥æ•°æ®ç±»å‹å¤§å°

## 3.8.3 *Nested Arrays*

åµŒå¥—æ•°ç»„çš„å£°æ˜ä¹Ÿé€‚ç”¨äºä¹‹å‰æåˆ°çš„æ•°ç»„çš„åˆ†é…å’Œå¼•ç”¨è§„åˆ™

ä¾‹å¦‚ï¼š`int A[5][3];`ç­‰ä»·äº`typedef int row3_t[3];row3_t A[5];`

Aå®šä¹‰äº†5ä¸ªé•¿åº¦ä¸º3çš„æ•°ç»„ï¼Œæ€»å¤§å°ä¸º15\*4=60B

å£°æ˜çš„Aä¹Ÿè¢«è§†ä¸º5è¡Œ3åˆ—çš„äºŒç»´æ•°ç»„ï¼Œä»A\[0]\[0]\~A\[4]\[2]

![](image/image_hrfW7xt5KL.png)

åµŒå¥—æ•°ç»„çš„æ•°ç»„å…ƒç´ åœ¨å†…å­˜ä¸­æ˜¯æŒ‰è¡Œä¸»åºå­˜å‚¨çš„ï¼Œå³æ‰€æœ‰0è¡Œçš„å…ƒç´ å¯ä»¥å†™ä½œA\[0]ï¼Œä¹‹åæ˜¯æ‰€æœ‰1è¡Œå…ƒç´ A\[1]ï¼Œå¦‚å·¦å›¾æ‰€ç¤º

è®¿é—®å¤šç»´æ•°ç»„å…ƒç´ åŒè®¿é—®ä¸€ç»´æ•°ç»„å…ƒç´ çš„æœºåˆ¶ç±»ä¼¼ï¼šé‡‡ç”¨ç¼©æ”¾å˜å€å¯»å€è¡¨ç¤ºæ•°ç»„å…ƒç´ çš„åœ°å€ï¼Œç„¶åä½¿ç”¨movç±»æŒ‡ä»¤è¿›è¡Œè®¿é—®

ä¾‹å¦‚å¯¹äºäºŒç»´æ•°ç»„`T D[R][C];`ä»»ä½•æ•°ç»„å…ƒç´ D\[i]\[j]å…¶åœ°å€ä¸º$\&D[i][j]=x_D+L(i*C+j)$

## 3.8.4 *Fixed-Size Arrays*

1.  ç”¨å¸¸æ•°è®¾ç½®æ•°ç»„é•¿åº¦æ—¶çš„è‰¯å¥½ä¹ æƒ¯

    ä½¿ç”¨`#define`å®šä¹‰æ•°ç»„é•¿åº¦
    ```c
    #define N 16
    typedef int fix_matrix [N][N];
    ```
2.  ä¼˜åŒ–ç­‰çº§ä¸º-01æ—¶çš„ä¼˜åŒ–

    ![](image/image_rAM1LP3Y3Y.png)

    å»æ‰äº†é—´æ¥ç´¢å¼•jï¼Œä½¿ç”¨æŒ‡é’ˆè¿ç®—åˆ¤æ–­æ˜¯å¦åˆ°äº†è¾¹ç•Œ

    ![](image/image_O0HHs1SNhu.png)

## 3.8.5 *Variable-Size Arrays*

> âœ¨è‡ªISO C99ä¹‹åï¼Œå…è®¸æ•°ç»„çš„ç»´åº¦æ˜¯è¡¨è¾¾å¼ï¼Œåœ¨æ•°ç»„è¢«åˆ†é…æ—¶æ‰è®¡ç®—å‡ºæ¥

GCCä»é‡‡ç”¨ç±»ä¼¼äºå®šé•¿æ•°ç»„è®¡ç®—ç´¢å¼•çš„æ–¹æ³•è¿›è¡Œè®¡ç®—ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ç”±äºå­˜åœ¨å˜é•¿nï¼Œéœ€è¦ä½¿ç”¨ä¹˜æ³•æ¥è¿›è¡Œè®¡ç®—[^æ³¨é‡Š19]ï¼Œè€Œä¸èƒ½ä½¿ç”¨leaqæŒ‡ä»¤ï¼ˆleaqçš„ä¹˜æ³•ï¼Œéœ€ä¿è¯1ï¼Œ2ï¼Œ4ï¼Œ8ï¼‰

![](image/image_IG4TJ5BI2n.png)

GCCé€šå¸¸ä½¿ç”¨è®¿é—®æ¨¡å¼çš„è§„å¾‹æ€§æ¥ä¼˜åŒ–ç´¢å¼•çš„è®¡ç®—

![](image/image_X-estU8zXx.png)

# 3.9 *Heterogeneous Data Structures*

> *C provides two mechanisms for creating data types by combining objects of different types:*-   structures, declared using the keyword struct, aggregate multiple objects into a single unit; unions, declared using the keyword union, allow an object to be referenced using several different types.\*â€‹

## 3.9.1 *Structures*

C ç»“æ„ä½“å£°æ˜åˆ›å»ºä¸€ç§æ•°æ®ç±»å‹structï¼Œå°†å¯èƒ½ä¸åŒç±»å‹çš„å¯¹è±¡ç»„åˆæˆä¸ºå•ä¸ªå¯¹è±¡ã€‚ç»“æ„ä½“ä¸­ä¸åŒçš„ç»„æˆéƒ¨åˆ†å¯ä»¥é€šè¿‡åç§°å¼•ç”¨ã€‚å®ƒçš„å®ç°æ˜¯ç±»ä¼¼äºæ•°ç»„çš„â€”â€”ç»“æ„ä½“çš„æ‰€æœ‰ç»„æˆå•å…ƒå æ®ä¸€å—è¿ç»­çš„å­˜å‚¨åŒºåŸŸï¼Œå¹¶ä¸”ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘è¿™å—åŒºåŸŸçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚

ä¾‹å¦‚ä¸‹é¢çš„ç»“æ„ä½“ï¼š

```c
struct rec{
 int i; 
 int j; 
 int a[2]; 
 int *p; 
};
```

å…¶å æ®çš„å†…å­˜ç©ºé—´å¤§å°ä¸º24Bï¼Œå¦‚ä¸‹å›¾ï¼š

![](image/image_fg5qFb2mbI.png)

è®¿é—®ç»“æ„ä½“çš„æˆå‘˜æ—¢å¯ä»¥é€šè¿‡â€œ`.`â€ç‚¹è¿ç®—ç¬¦ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆâ†’

```c
//.è¿ç®—ç¬¦
//å‡è®¾å£°æ˜recç±»å‹å˜é‡Aï¼ŒrecæŒ‡é’ˆpæŒ‡å‘A
rec.i==p->i==*p
rec.j==p->j==*(p+4)
rec.a[0]==p->a[0]==*(p+8+4*0)==8(p,0,4)
rec.a[1]==p->a[1]==*(p+8+4*1)==8(p,1,4)
rec.p==p->p==*(p+16)

```

## 3.9.2\* Unions\*

> *Unions provide a way to **circumvent the type system of C**, allowing a single object to be referenced according to multiple types. The syntax of a union declaration is identical to that for structures, but its semantics are very different. Rather than having the different fields reference different blocks of memory, they all reference the same block.*

> âœ¨Structæ˜¯ä¸€å—è¿ç»­çš„å­˜å‚¨åŒºåŸŸå†…æœ‰å¤šä¸ªå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨ç»“æ„ä½“.åŸŸåæ¥å¼•ç”¨è¿™äº›å¯¹è±¡ï¼›
> Unionæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥ä½¿ç”¨Unionå†…çš„å„ç§æ•°æ®ç±»å‹æ¥è®¿é—®è¿™ä¸ªå¯¹è±¡

ä¾‹å¦‚ï¼š

```c
struct S3{
 char c;
 int i[2];
 double v; 
};
union U3{
 char c; 
 int i[2]; 
 double v; 
};

```

è‹¥ä¸è€ƒè™‘å¯¹é½ï¼Œé‚£ä¹ˆS3å ç”¨ï¼ˆ1+8+8ï¼‰=17ä¸ªå­—èŠ‚ã€‚è€ŒUnionåªå ç”¨æœ€å¤§çš„æ•°æ®ç±»å‹å¤§å°doubleâ€”â€”8ä¸ªå­—èŠ‚

å¯¹äºS3ç±»å‹çš„æŒ‡é’ˆpæ¥è¯´ï¼Œpâ†’c,pâ†’i\[0],pâ†’vå‡ä»ä¸åŒçš„å†…å­˜åœ°å€å¼€å§‹è®¿é—®ï¼›ä½†æ˜¯å¯¹äºU3ç±»å‹çš„æŒ‡é’ˆqæ¥è¯´ï¼Œqâ†’cã€qâ†’i\[0]ã€qâ†’vå‡æ˜¯ä»è¿™å—å†…å­˜çš„èµ·å§‹åŒºåŸŸè®¿é—®[^æ³¨é‡Š20]

#### è”åˆçš„åº”ç”¨

1.  äº‹å…ˆçŸ¥é“å¯¹ä¸€ä¸ªæ•°æ®ç»“æ„ä¸­çš„ä¸¤ä¸ªä¸åŒå­—æ®µçš„ä½¿ç”¨æ˜¯äº’æ–¥çš„ï¼Œå°†å…¶å£°æ˜ä¸ºè”åˆå¯ä»¥å‡å°‘åˆ†é…çš„ç©ºé—´æ€»é‡

    ä¾‹å¦‚å¯¹äºäºŒå‰æ ‘ï¼Œæ¯ä¸ªå¶å­èŠ‚ç‚¹éƒ½æœ‰ä¸¤ä¸ªdoubleå€¼ï¼Œæ¯ä¸ªå†…éƒ¨èŠ‚ç‚¹éƒ½æœ‰å·¦å³å­æ ‘æŒ‡é’ˆã€‚å› æ­¤ä¸€ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯ä¸¤ä¸ªæŒ‡é’ˆè¦ä¹ˆæ˜¯ä¸¤ä¸ªå€¼
    ```c
    struct node_S{
      struct node_S *left;
      struct node_S *right;
      double value[2];
    };//å…±32B

    union node_U{
      struct{
        union node_U *left;
        union node_U *right;
      }internal;
      double value[2]; 
    };//å…±16B
    ```
    ä¸ºäº†çŸ¥æ™“æŸä¸ªèŠ‚ç‚¹æ˜¯å¶å­èŠ‚ç‚¹è¿˜æ˜¯å†…éƒ¨èŠ‚ç‚¹ï¼Œå¯ä»¥åŠ å…¥ä¸€ä¸ªæšä¸¾ç±»å‹è¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„ç±»å‹
    ```c
    typedef enum {N_LEAF,N_INTERNAL} nodetype_t;
    struct node_t{
      nodetype_t type;
      union{
        struct{
           struct node_t *left;
           struct node_t *right;
        }internal;
        double data[2];
      }info;
    };//4+4+16 unionå¯¹é½å‰ç©º4B
    ```
2.  è®¿é—®ä¸åŒæ•°æ®ç±»å‹çš„ä½æ¨¡å¼
    > âœ¨å¼ºåˆ¶è½¬æ¢ä¼šè½¬æ¢ä¸ºå¯¹åº”å€¼çš„å¯¹åº”ç±»å‹ï¼Œæ”¹å˜ä½æ¨¡å¼ï¼›
    >
    > è€Œè”åˆæ˜¯ä½æ¨¡å¼ä¸å˜ï¼Œæ›´æ¢ä½æ¨¡å¼çš„è§£é‡Šæ–¹å¼

## 3.9.3 *Data Alignment*

è®¸å¤šè®¡ç®—æœºç³»ç»Ÿå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„åˆæ³•åœ°å€åšå‡ºäº†ä¸€äº›é™åˆ¶â€”â€”è¦æ±‚æŸç§ç±»å‹çš„å¯¹è±¡åœ°å€å¿…é¡»æ˜¯æŸä¸ªå€¼K(1,2,4,8)çš„å€æ•°ï¼Œä»è€Œç®€åŒ–å¤„ç†å™¨å’Œå†…å­˜ç³»ç»Ÿä¹‹é—´çš„æ¥å£çš„ç¡¬ä»¶è®¾è®¡

> âœ¨æ— è®ºæ•°æ®æ˜¯å¦å¯¹é½ï¼Œx86-64ç¡¬ä»¶éƒ½èƒ½æ­£ç¡®å·¥ä½œã€‚ä¸è¿‡ï¼ŒIntelè¿˜æ˜¯å»ºè®®è¦å¯¹é½æ•°æ®ä»¥
> æé«˜å†…å­˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚å¯¹é½åŸåˆ™æ˜¯ä»»ä½•Kå­—èŠ‚çš„åŸºæœ¬å¯¹è±¡çš„åœ°å€å¿…é¡»æ˜¯Kçš„å€æ•°
>
> ![](image/image_8Mza2eioT0.png)
>
> ä¸”å¯¹äºç»“æ„å’Œè”åˆï¼Œå› ä¸ºå¯èƒ½ä¼šå­˜åœ¨ç»“æ„æ•°ç»„ã€è”åˆæ•°ç»„è¿™ç§è¿ç»­åˆ†é…å†…å­˜åœ°å€çš„æƒ…å†µï¼Œæ­¤æ—¶ä¹Ÿéœ€è¦å¯¹æ•´ä¸ªç»“æ„ã€è”åˆè¿›è¡Œå¯¹é½ï¼Œä»¥ä¿è¯å†…éƒ¨çš„å¯¹è±¡çš„å­—èŠ‚æ˜¯å¯¹é½çš„ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œ**ç»“æ„æ•´ä½“å¯¹é½è¦çœ‹ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä»€ä¹ˆï¼›è”åˆæ˜¯4Bå¯¹é½**

å¯ä»¥å…¨å±€å¯¹é½â€œ`.align 8`â€å¯¹é½å‘½ä»¤ï¼ŒæŒ‡å®šä»»ä½•æ•°æ®ç±»å‹çš„å¯¹é½å­—èŠ‚æ•°

> ä¾‹é¢˜ï¼š
>
> ![](image/image_vpwFulw1uf.png)
>
> 1.  i:0\~3,c:4,j:8\~11,char:12  ä¸‹ä¸€ä¸ªæ˜¯int 4 16
> 2.  i:0\~3.c:4,d:5,j:8\~15  ä¸‹ä¸€ä¸ªæ˜¯int 4 16
> 3.  w:0\~1,2\~3,4\~5 cæ˜¯6,7,8 ä¸‹ä¸€ä¸ªæ˜¯short 2 10
> 4.  w:0\~9, c:16\~24\~32 ä¸‹ä¸€ä¸ªæ˜¯short 2 40
> 5.  P3æ˜¯10Bï¼Œ P2è¦æ˜¯4å€æ•°ï¼Œå› æ­¤æ˜¯40

> ç»“æ„å†…å…ƒç´ æ•´åˆæ’åˆ—
>
> ![](image/image_IewPa24H_u.png)
>
> å½“æ‰€æœ‰å¯¹è±¡çš„å¤§å°æ˜¯2çš„å¹‚æ—¶ï¼Œä¸€ç§è¡Œä¹‹æœ‰æ•ˆçš„æ–¹æ³•æ˜¯é™åºæ’

> âœ¨å¼ºåˆ¶å¯¹é½çš„æƒ…å†µï¼š
>
> å› ä¸ºsetç±»æŒ‡ä»¤æœ€å°çš„æ“ä½œå•å…ƒæ˜¯å­—â€”â€”16ä½ï¼Œå› æ­¤å¿…é¡»æ»¡è¶³16åç§»é‡å¯¹é½
>
> ![](image/image_busta9GZY5.png)

# 3.10 *Combining Control and Data in Machine-Level Programs*

## 3.10.1 *Understanding Pointers*

æŒ‡é’ˆä¸ºç”Ÿæˆä¸åŒæ•°æ®ç±»å‹çš„å…ƒç´ çš„å¼•ç”¨æä¾›äº†ä¸€ä¸ªç»Ÿä¸€çš„æ–¹æ³•ã€‚ä¸‹é¢ä»‹ç»ä¸€äº›æŒ‡é’ˆçš„å…³é”®åŸåˆ™ä»¥åŠåˆ°æœºå™¨ä»£ç çš„æ˜ å°„ï¼š

1.  æ¯ä¸€ä¸ªæŒ‡é’ˆéƒ½æœ‰å…¶ç›¸å…³çš„ç±»å‹ã€‚è¿™ä¸ªç±»å‹æ˜¯åæ˜ äº†æŒ‡é’ˆæ‰€æŒ‡å‘åœ°å€ä¸Šå­˜å‚¨çš„æ•°æ®ç±»å‹ï¼Œä¸æŒ‡é’ˆçš„å¤§å°æ— å…³ï¼Œä½†ä¸æŒ‡é’ˆçš„è§£å¼•ç”¨ä»¥åŠæŒ‡é’ˆçš„è¿ç®—æœ‰å…³

    `void *`æŒ‡é’ˆæŒ‡çš„æ˜¯â€œé€šç”¨æŒ‡é’ˆâ€ï¼Œå®ƒå¯ä»¥é€šè¿‡å¼ºåˆ¶ç±»å‹è½¬æ¢ä»¥åŠéšå¼çš„èµ‹å€¼æ¥è½¬æ¢ä¸ºæŸç§ç‰¹å®šç±»å‹çš„æŒ‡é’ˆ

    æœºå™¨ä»£ç å¹¶ä¸æ˜ å°„æŒ‡é’ˆçš„ç±»å‹
2.  æ¯ä¸€ä¸ªæŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå€¼

    æ¯ä¸€ä¸ªå¯ä»¥è§£å¼•ç”¨çš„æŒ‡é’ˆéƒ½æœ‰ä¸€ä¸ªå€¼ï¼Œè¿™ä¸ªå€¼åœ¨å†…å­˜åœ°å€çš„èŒƒå›´å†…ï¼Œæ˜¯å®ƒæ‰€æŒ‡å‘çš„å†…å­˜å¯¹è±¡çš„åœ°å€

    å€¼ä¸º`NULL(0)`è¡¨ç¤ºæŒ‡é’ˆå¹¶ä¸æŒ‡å‘ä»»ä½•åœ°æ–¹
3.  ä½¿ç”¨`â€œ&â€`å–åœ°å€æ“ä½œç¬¦åˆ›å»ºæŒ‡é’ˆ

    å–åœ°å€æ“ä½œç¬¦å¯ä»¥åº”ç”¨äºä»»ä½•Cä¸­å¯è¢«èµ‹å€¼çš„å·¦è¡¨è¾¾å¼*lvalue*ï¼Œå³åŒ…æ‹¬ç»“æ„ä½“å…ƒç´ ã€è”åˆã€æ•°ç»„ç­‰

    å–åœ°å€&ç¬¦å·åœ¨æœºå™¨ä»£ç ä¸­æ˜ å°„ä¸ºleaqæŒ‡ä»¤
4.  ä½¿ç”¨`â€œ*â€`è§£å¼•ç”¨æŒ‡é’ˆ

    è§£å¼•ç”¨æŒ‡é’ˆç­‰ä»·äºä½¿ç”¨movç±»æŒ‡ä»¤çš„ç¼©æ”¾ç›¸å¯¹å˜å€$i(a,b,c)\rightarrow b\times c+a+i$å¯»å€æ–¹å¼æ¥è®¿å­˜æ•°æ®
5.  æ•°ç»„å’ŒæŒ‡é’ˆæ˜¯ç´§å¯†ç›¸å…³çš„

    æ•°ç»„åå³å¯å½“ä½œä¸€ä¸ªæŒ‡é’ˆ

    æ•°ç»„çš„ç´¢å¼•å³ç›¸å½“äºæŒ‡é’ˆçš„è§£å¼•ç”¨

    $*(p+i)=p[i]=mem[p+i\times L],Læ˜¯æ•°æ®ç±»å‹çš„å¤§å°$
6.  æŒ‡é’ˆä¹‹é—´çš„å¼ºåˆ¶è½¬æ¢åªæ”¹å˜æŒ‡é’ˆçš„ç±»å‹ï¼Œä½†æ˜¯ä¸æ”¹å˜æŒ‡é’ˆçš„å€¼

    æ”¹å˜æŒ‡é’ˆçš„ç±»å‹åªä¼šå½±å“è§£å¼•ç”¨æŒ‡é’ˆæ—¶è®¿é—®å¯¹åº”åœ°å€å¤šå°‘å­—èŠ‚ä»¥åŠæŒ‡é’ˆè¿ç®—
7.  ä¹Ÿå¯ä»¥å£°æ˜å¯¹å‡½æ•°çš„æŒ‡é’ˆå¼•ç”¨
    ```c
    //å‡½æ•°å£°æ˜
    int fun(int x,int *p);

    //å¯¹åº”å‡½æ•°çš„æŒ‡é’ˆå£°æ˜ï¼Œéœ€è¦ä¿è¯å‚åˆ—ç±»å‹ä¸€è‡´ï¼Œè¿”å›å€¼ä¸€è‡´
    int (*f)(int ,int *);
    f=fun;//èµ‹å€¼

    //ä½¿ç”¨
    int y=1;
    int res=f(2,&y);

    ```
    å‡½æ•°æŒ‡é’ˆæŒ‡å‘çš„æ˜¯å‡½æ•°çš„æœºå™¨ä»£ç çš„ç¬¬ä¸€æ¡æŒ‡ä»¤

## 3.10.2\* Out-of-Bounds Memory References and Buffer Overflow\*

> *We have seen that*-   C does not perform any bounds checking for array references\* *, and that*\* local variables are stored on the stack along with state information such as saved register values and return addresses.\* \* ï¼ˆ**è°ƒç”¨è€…è¿›ç¨‹çš„è¿”å›åœ°å€+å—ä¿æŠ¤çš„å¯„å­˜å™¨+å±€éƒ¨å˜é‡+è¢«è°ƒç”¨è¿›ç¨‹çš„å‚æ•°ç©ºé—´**ï¼‰This combination can lead to serious program errors, where the state stored on the stack gets corrupted by a write to an out-of-bounds array element. When the program then tries to reload the register or execute a ret instruction with this corrupted state, things can go seriously wrong.\*

ä¸€ç§ç‰¹åˆ«å¸¸è§çš„çŠ¶æ€ç ´åç§°ä¸ºâ€œç¼“å†²åŒºæº¢å‡ºâ€ï¼Œé€šå¸¸åœ¨æ ˆä¸­çš„å±€éƒ¨å˜é‡åŒºåŸŸä¼šåˆ†é…æŸä¸ªå­—ç¬¦æ•°ç»„æ¥ä¿å­˜ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯å½“å­—ç¬¦ä¸²çš„é•¿åº¦è¶…å‡ºäº†åˆ†é…çš„æ•°ç»„çš„ç©ºé—´åˆ™ä¼šå‘ä¸Šä¿®æ”¹å—ä¿æŠ¤çš„å¯„å­˜å™¨åŒºåŸŸå’Œè°ƒç”¨è€…è¿›ç¨‹çš„è¿”å›åœ°å€åŒºåŸŸï¼Œé€ æˆå¾ˆä¸¥é‡çš„é”™è¯¯

![](image/image_VhpjPFQd1F.png)

å¦‚ä¸Šå‡½æ•°ä»¥åŠå…¶æ±‡ç¼–ä»£ç å®ç°ï¼Œè°ƒç”¨ååœ¨å †æ ˆä¸­è…¾å‡º24Bç”¨æ¥å­˜å‚¨å­—ç¬¦ä¸²ã€‚ä½†å‡½æ•°åªåˆ†é…äº†8ä¸ªï¼Œå…¶å¯¹åº”çš„å †æ ˆä½¿ç”¨æƒ…å†µå¦‚ä¸‹æ‰€ç¤ºï¼š

![](image/image_sHdBPaP9o8.png)

åˆ™å½“è¾“å…¥å­—ç¬¦åˆ°è¾¾ä¸€å®šèŒƒå›´æ—¶çš„ç ´åæƒ…å†µå¦‚ä¸‹ï¼š

![](image/image_-_zYRKuOYu.png)

ç¼“å†²åŒºæº¢å‡ºçš„ä¸€ä¸ªæ›´æœ‰å®³çš„ç”¨é€”æ˜¯è®©ç¨‹åºæ‰§è¡ŒåŸæœ¬ä¸æ„¿æ„æ‰§è¡Œçš„åŠŸèƒ½ã€‚è¿™æ˜¯é€šè¿‡è®¡ç®—æœºç½‘ç»œæ”»å‡»ç³»ç»Ÿå®‰å…¨çš„æœ€å¸¸è§æ–¹æ³•ä¹‹ä¸€ã€‚é€šå¸¸ï¼Œç¨‹åºä¼šæ”¶åˆ°ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…å«ä¸€äº›å¯æ‰§è¡Œä»£ç ï¼ˆç§°ä¸ºæ¼æ´åˆ©ç”¨ä»£ç ï¼‰çš„å­—èŠ‚ç¼–ç ï¼Œä»¥åŠä¸€äº›ç”¨æŒ‡å‘æ¼æ´åˆ©ç”¨ä»£ç çš„æŒ‡é’ˆè¦†ç›–è¿”å›åœ°å€çš„é¢å¤–å­—èŠ‚ã€‚æ‰§è¡ŒretæŒ‡ä»¤çš„ä½œç”¨å°±æ˜¯è·³è½¬åˆ°æ¼æ´åˆ©ç”¨ä»£ç ã€‚æœ‰ä¸¤ç§æ”»å‡»å½¢å¼ï¼š

1.  æ¼æ´åˆ©ç”¨ä»£ç ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨å¯åŠ¨shellç¨‹åºï¼Œä¸ºæ”»å‡»è€…æä¾›ä¸€ç³»åˆ—çš„æ“ä½œç³»ç»ŸåŠŸèƒ½
2.  æ¼æ´åˆ©ç”¨ä»£ç æ‰§è¡Œä¸€äº›æœªæˆæƒä»»åŠ¡ï¼Œä¿®å¤å †æ ˆæŸåï¼Œç„¶åå†æ¬¡æ‰§è¡Œretï¼Œè¡¨é¢ä¸Šçœ‹èµ·æ¥æ­£ç¡®åœ°è¿”å›ç»™è°ƒç”¨è€…

> è •è™«å’Œç—…æ¯’
>
> è •è™«å’Œç—…æ¯’éƒ½è¯•å›¾åœ¨è®¡ç®—æœºä¸­ä¼ æ’­å®ƒä»¬è‡ªå·±çš„ä»£ç æ®µ
>
> ä½†æ˜¯è •è™«å¯ä»¥è‡ªå·±è¿è¡Œï¼Œå°†è‡ªå·±çš„ç­‰æ•ˆå‰¯æœ¬ä¼ æ’­åˆ°å…¶ä»–æœºå™¨ï¼›è€Œç—…æ¯’èƒ½å°†è‡ªå·±æ·»åŠ åˆ°åŒ…æ‹¬æ“ä½œç³»ç»Ÿåœ¨å†…çš„å…¶ä»–ç¨‹åºä¸­ï¼Œä½†ä¸èƒ½ç‹¬ç«‹è¿è¡Œ

## 3.10.3 *Thwarting Buffer Overflow Attacks*

### å †æ ˆéšæœºåŒ–

æ”»å‡»è€…ä¸ºäº†åœ¨ç³»ç»Ÿä¸­æ’å…¥æ”»å‡»ä»£ç å¹¶èƒ½å¤Ÿæ‰§è¡Œè¯¥ä»£ç ï¼Œå°±éœ€è¦äº†è§£è¯¥æ”»å‡»å­—ç¬¦ä¸²åœ¨æ ˆä¸­çš„å­˜æ”¾ä½ç½®â€”â€”ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨æŒ‡é’ˆè·³è½¬åˆ°è¯¥æ”»å‡»å­—ç¬¦ä¸²å¹¶æ‰§è¡Œã€‚

åœ¨è¿‡å»ï¼Œå­˜åœ¨â€œå®‰å…¨å•ä¸€åŒ–â€ç°è±¡ï¼Œå³è®¸å¤šç³»ç»Ÿéƒ½å®¹æ˜“å—åˆ°åŒä¸€ç§ç—…æ¯’çš„æ”»å‡»ã€‚è¿™æ˜¯å› ä¸ºå¯¹äºæ‰€æœ‰è¿è¡ŒåŒæ ·ç¨‹åºå’Œæ“ä½œç³»ç»Ÿç‰ˆæœ¬çš„ç³»ç»Ÿæ¥è¯´ï¼Œåœ¨ä¸åŒæœºå™¨é—´æ ˆçš„ä½ç½®æ˜¯ç›¸å½“å›ºå®šçš„ï¼Œè€Œä¸”éå¸¸å®¹æ˜“é¢„æµ‹

æ ˆéšæœºåŒ–çš„æ€æƒ³æ˜¯æŒ‡â€œæ ˆçš„ä½ç½®åœ¨ç¨‹åºæ¯æ¬¡è¿è¡Œæ—¶éƒ½æœ‰å˜åŒ–â€ã€‚å®ç°çš„æ–¹å¼æ˜¯ï¼šç¨‹åºå¼€å§‹æ—¶ï¼Œåœ¨æ ˆä¸­åˆ†é…ä¸€æ®µ0\~nå­—èŠ‚çš„éšæœºå¤§å°çš„ç©ºé—´ï¼Œç¨‹åºå¹¶ä¸é€‚ç”¨è¿™æ®µç©ºé—´ï¼Œä½†æ˜¯å®ƒä¼šå¯¼è‡´ç¨‹åºæ¯æ¬¡æ‰§è¡Œæ—¶åç»­çš„æ ˆä½ç½®å‘ç”Ÿäº†å˜åŒ–ã€‚ä¸”éœ€è¦ä¿è¯nè¶³å¤Ÿå¤§ï¼Œæ‰èƒ½å¤Ÿè·å¾—è¶³å¤Ÿå¤šçš„æ ˆåœ°å€å˜åŒ–ï¼›ä½†åˆéœ€è¦è¶³å¤Ÿå°ï¼Œä¸è‡³äºæµªè´¹ç¨‹åºå¤ªå¤šçš„ç©ºé—´

åœ¨Linuxç³»ç»Ÿä¸­ï¼Œæ ˆéšæœºåŒ–å·²æˆä¸ºæ ‡å‡†è¡Œä¸ºï¼Œå®ƒæ˜¯æ›´å¤§çš„ä¸€ç±»æŠ€æœ¯â€”â€”**ASLRåœ°å€ç©ºé—´å¸ƒå±€éšæœºåŒ–**ä¸­çš„ä¸€ç§ã€‚**ASLRçš„é‡‡ç”¨ä¼šä½¿å¾—æ¯æ¬¡è¿è¡Œæ—¶ç¨‹åºçš„ä¸åŒéƒ¨åˆ†ã€åŒ…æ‹¬ç¨‹åºä»£ç ã€åº“ä»£ç ã€æ ˆã€å…¨å±€å˜é‡å’Œå †æ•°æ®éƒ½ä¼šè¢«åŠ è½½åˆ°å†…å­˜ä¸­çš„ä¸åŒåŒºåŸŸ**

ç„¶è€Œæ ˆéšæœºåŒ–ä¹Ÿå¯ä»¥ä½¿ç”¨è›®åŠ›å…‹æœï¼Œå¯ä»¥åå¤åœ°ç”¨ä¸åŒçš„åœ°å€è¿›è¡Œæ”»å‡»

**ä¸€ç§æ–¹æ³•æ˜¯â€œ****ç©ºæ“ä½œé›ªæ©‡nop sled****â€ï¼Œå³åœ¨æ”»å‡»ä»£ç ä¸­æ’å…¥ä¸€é•¿ä¸²nopæŒ‡ä»¤ï¼Œåªè¦æ”»å‡»è€…èƒ½å¤ŸçŒœä¸­è¿™æ®µnopæŒ‡ä»¤åºåˆ—ä¸­çš„æŸä¸ªnopçš„åœ°å€ï¼Œåˆ™ç¨‹åºå°±ä¼šç»è¿‡è¿™ä¸ªåºåˆ—åˆ°è¾¾æ”»å‡»ä»£ç **

![](image/image_zncka6qmiV.png)

é‡‡ç”¨â€œnop sledâ€æ–¹æ³•ï¼Œè‹¥nop sledæœ‰256ä¸ªå­—èŠ‚ï¼Œåˆ™ç ´è§£$n=2^{23}$çš„éšæœºåŒ–ï¼Œéœ€è¦æšä¸¾$2^{23-8}=2^{15}$æ¬¡

### å †æ ˆæŸåæ£€æµ‹

> è™½ç„¶åœ¨ C è¯­è¨€ä¸­ï¼Œæ²¡æœ‰å¯é çš„æ–¹æ³•æ¥é˜²æ­¢å¯¹æ•°ç»„çš„è¶Šç•Œå†™ã€‚ä½†æ˜¯å¯ä»¥åœ¨å‘ç”Ÿäº†è¶Šç•Œå†™åä¸”é€ æˆä»»ä½•æœ‰å®³ç»“æœä¹‹å‰ï¼Œå°è¯•è¿›è¡Œæ£€æµ‹

GCCä¸­åŠ å…¥äº†â€œ**æ ˆä¿æŠ¤æœºåˆ¶**â€ã€‚å…¶æ€æƒ³æ˜¯ï¼šåœ¨æ ˆå¸§ä¸­ä»»ä½•å±€éƒ¨ç¼“å†²åŒºä¸æ ˆçŠ¶æ€ä¹‹é—´å­˜å‚¨ä¸€ä¸ªç‰¹æ®Šçš„**åªè¯»çš„**é‡‘ä¸é›€å€¼/å“¨å…µå€¼â€”â€”æ¯æ¬¡è¿è¡Œæ—¶éšæœºäº§ç”Ÿã€‚åœ¨æ¢å¤å¯„å­˜å™¨çŠ¶æ€å’Œä»å‡½æ•°è¿”å›ä¹‹å‰ï¼Œç¨‹åºæ£€æŸ¥è¿™ä¸ªé‡‘ä¸é›€å€¼æ˜¯å¦è¢«è¯¥å‡½æ•°çš„æŸä¸ªæ“ä½œæˆ–è€…è¯¥å‡½æ•°è°ƒç”¨çš„æŸä¸ªå‡½æ•°çš„æŸä¸ªæ“ä½œæ”¹å˜äº†ã€‚å¦‚æœæ˜¯çš„ï¼Œé‚£ä¹ˆç¨‹åºå¼‚å¸¸ä¸­æ­¢ã€‚

> âœ¨é»˜è®¤gccç¼–è¯‘æ˜¯ä½¿ç”¨æ ˆä¿æŠ¤æ£€æµ‹çš„ï¼Œå½“ä½¿ç”¨å‚æ•°â€œ*-fno-stack-protector*â€æ—¶ä¼šé˜»æ­¢æ ˆæ£€æµ‹

> é‡‡ç”¨å †æ ˆæŸåæ£€æµ‹æœºåˆ¶çš„ä¾‹é¢˜
>
> ![](image/image_dSHh2ExXn2.png)
>
> 1.  bufåœ¨æ ˆé¡¶åå·®0ï¼Œvåœ¨æ ˆé¡¶åå·®24ï¼›bufåœ¨æ ˆçš„åå·®16ï¼Œvåœ¨åå·®8ï¼Œé‡‘ä¸é›€åœ¨40
> 2.  væ¯”bufæ›´é è¿‘æ ˆé¡¶ï¼Œå³ä½¿bufæº¢å‡ºä¹Ÿä¸ä¼šä¿®æ”¹v

### é™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸ

> âœ¨é™åˆ¶å¯æ‰§è¡Œä»£ç åŒºåŸŸå¯ä»¥æ¶ˆé™¤æ”»å‡»è€…å‘ç³»ç»Ÿä¸­æ’å…¥å¯æ‰§è¡Œä»£ç çš„èƒ½åŠ›

è®¸å¤šç³»ç»Ÿæ”¯æŒæ§åˆ¶ä¸‰ç§è®¿é—®å½¢å¼ï¼šè¯»ï¼ˆä»å†…å­˜ä¸­è¯»æ•°æ®ï¼‰ã€å†™ï¼ˆå­˜å‚¨æ•°æ®åˆ°å†…å­˜ä¸­ï¼‰å’Œæ‰§è¡Œï¼ˆå°†å†…å­˜çš„å†…å­˜çœ‹ä½œæœºå™¨çº§ä»£ç ï¼‰ã€‚åœ¨å…¸å‹çš„ç¨‹åºä¸­ï¼Œåªæœ‰ä¿å­˜ç¼–è¯‘å™¨äº§ç”Ÿçš„é‚£éƒ¨åˆ†å†…å­˜æ‰éœ€è¦æ˜¯å¯æ‰§è¡Œçš„ï¼Œå…¶ä»–éƒ¨åˆ†å¯ä»¥è¢«é™åˆ¶ä¸ºåªå…è®¸è¯»/äº›ã€‚

ä»¥å‰ï¼Œx86ä½“ç³»ç»“æ„å°†è¯»å’Œæ‰§è¡Œè®¿é—®æ§åˆ¶åˆå¹¶æˆä¸€ä¸ª1ä½çš„æ ‡å¿—â€”â€”å¯¼è‡´æ ‡è®°ä¸ºå¯è¯»çš„å†…å®¹ä¹Ÿå¯ä»¥æ‰§è¡Œã€‚è€Œæ ˆæ˜¯æ—¢å¯è¯»åˆå¯å†™çš„ï¼Œå› æ­¤æ ˆä¹Ÿå¯æ‰§è¡Œ

è€Œä¸ºäº†é™åˆ¶æ ˆä¸å¯æ‰§è¡Œï¼ŒAMDä¸ºå®ƒçš„64ä½å¤„ç†å™¨çš„å†…å­˜ä¿æŠ¤å¼•å…¥äº† **â€œNXâ€ä¸æ‰§è¡Œä½**ï¼Œå°†è¯»å’Œæ‰§è¡Œçš„è®¿é—®æ§åˆ¶åˆ†å¼€ã€‚Intelä¹Ÿè·Ÿè¿›äº†è¿™ä¸€ç‰¹æ€§ï¼Œä»è€Œä½¿å¾—æ ˆä¸å¯æ‰§è¡Œ

## 3.10.4\* Supporting Variable-Size Stack Frames\*

> âœ¨allocå’Œmalloc
>
> allocåˆ†é…çš„æ˜¯æ ˆåŒºå†…å­˜ï¼Œmallocåˆ†é…çš„æ˜¯å †åŒº

ä¸ºäº†ç®¡ç†å˜é•¿æ ˆå¸§ï¼Œx86-64ä½¿ç”¨å¯„å­˜å™¨`%rbp`ä½œä¸ºå¸§æŒ‡é’ˆ/åŸºæŒ‡é’ˆã€‚å› ä¸º%rbpå±äºè¢«è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨ï¼Œæ‰€ä»¥è¿‡ç¨‹åœ¨ä½¿ç”¨å‰éœ€è¦ä¿å­˜%rbp

> âœ¨`%rsp` å’Œ `%rbp` æ˜¯ x86 æ¶æ„ä¸‹çš„ä¸¤ä¸ªå¯„å­˜å™¨ã€‚å®ƒä»¬çš„ä½œç”¨å¦‚ä¸‹ï¼š
>
> -   `%rsp`ï¼šæ ˆæŒ‡é’ˆå¯„å­˜å™¨ï¼Œç”¨äºå­˜æ”¾æ ˆé¡¶çš„æŒ‡é’ˆï¼Œæ¯æ¬¡è¿›æ ˆï¼ˆpushï¼‰æˆ–å‡ºæ ˆï¼ˆpopï¼‰æ“ä½œéƒ½ä¼šæ›´æ–° `%rsp` çš„å€¼ï¼Œä½¿å…¶æŒ‡å‘å½“å‰æ ˆé¡¶ï¼›
> -   `%rbp`ï¼šåŸºå€æŒ‡é’ˆå¯„å­˜å™¨ï¼Œç”¨äºå­˜æ”¾å½“å‰å‡½æ•°æ ˆå¸§çš„åŸºåœ°å€ï¼Œå‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ä¼šä½¿ç”¨æ ˆå¸§æ¥ä¿å­˜å‡½æ•°å±€éƒ¨å˜é‡ã€å‚æ•°ç­‰ä¿¡æ¯ï¼Œ`%rbp` çš„å€¼æŒ‡å‘å½“å‰æ ˆå¸§çš„åŸºåœ°å€ã€‚
>
> å› æ­¤ï¼Œ`%rsp` å’Œ `%rbp` çš„åŒºåˆ«åœ¨äºå®ƒä»¬åˆ†åˆ«æŒ‡å‘æ ˆçš„ä½ç½®å’Œå½“å‰å‡½æ•°çš„æ ˆå¸§ä½ç½®ã€‚`%rsp` ç»å¸¸ç”¨äºæ ˆæ“ä½œï¼Œ`%rbp` ç»å¸¸ç”¨äºè®¿é—®å‡½æ•°å±€éƒ¨å˜é‡å’Œå‚æ•°ã€‚

> è¯´æ˜
>
> ![](image/image_EBZiXIMyfp.png)
>
> 2è¡Œä»£ç ä¿å­˜%rbp
>
> 3è¡Œä»£ç å°†å½“å‰è¿”å›åœ°å€ã€%rbpå…¥æ ˆä»¥åçš„æ ˆé¡¶åœ°å€%rspèµ‹ç»™%rbpï¼Œè¡¨ç¤ºä»è¯¥å¤„å¼€å§‹å¡«æ”¾æ•°æ®
>
> 4è¡Œä»£ç è®¾ç½®16ä¸ªå­—èŠ‚çš„æ ˆï¼Œå…¶ä¸­å‰8ä¸ªå­—èŠ‚å­˜æ”¾iï¼Œå8ä¸ªå­—èŠ‚ä¸ç”¨
>
> å› ä¸º**æ•°ç»„çš„ç©ºé—´éœ€è¦å¯¹é½**ï¼Œæ‰€ä»¥
>
> 5\~7è¡Œä»£ç è®¾ç½®ç”¨æ¥å­˜å‚¨å˜é•¿æŒ‡é’ˆæ•°ç»„çš„ç©ºé—´ï¼Œ8n+22å’Œ-16ç›¸ä¸ä»è€Œå¾—åˆ°**å‘ä¸‹èˆå…¥**æœ€æ¥è¿‘16å€æ•°çš„æ•°å­—[^æ³¨é‡Š21]ï¼Œç„¶åä»%rspå‡å»è¯¥å€¼ï¼Œå¾—åˆ°å˜é•¿æŒ‡é’ˆæ•°ç»„çš„æ ˆç©ºé—´
>
> 8\~9è¡Œä»£ç è®¾ç½®å°†%rspå¤„çš„åœ°å€ä¿®æ­£ä¸º**å‘ä¸Šèˆå…¥**æœ€æ¥è¿‘8çš„å€æ•°**e2**ï¼Œç„¶åä»è¿™ä¸ªå€æ•°+8nå³ä¸ºæ•°ç»„çš„èµ·å§‹åœ°å€**e1**
>
> ![](image/image_XTVsNKmtT0.png)
>
> **leaveæŒ‡ä»¤å¯ä»¥æ¢å¤%rspï¼Œå¹¶å¼¹å‡º%rbp**
>
> ```nasm
> movq %rbp,%rsp
> popq %rbp
> ```

> 8n+22ä¸-16å¾—åˆ°(8n+22)å‘ä¸‹è¾“å…¥æœ€æ¥è¿‘16å€æ•°çš„æ•°
>
> +7å†ç®—æœ¯å³ç§»3ä½å¾—åˆ°å‘ä¸Šèˆå…¥æœ€æ¥è¿‘8å€æ•°çš„æ•°
>
> ![](image/image_RtXj1OIDbc.png)

# 3.11\* Floating-Point Code\*

å¤„ç†å™¨çš„æµ®ç‚¹æ¶æ„ç”±ä¸åŒæ–¹é¢ç»„æˆï¼Œè¿™äº›æ–¹é¢å½±å“å¯¹æµ®ç‚¹æ•°æ®è¿›è¡Œæ“ä½œçš„ç¨‹åºå¦‚ä½•æ˜ å°„åˆ°æœºå™¨ä¸Šï¼ŒåŒ…æ‹¬ï¼šæ€ä¹ˆå­˜å‚¨ã€æ€ä¹ˆæ“ä½œã€å‡½æ•°æ€ä¹ˆä¼ é€’è¿”å›ã€è¢«è°ƒç”¨è€…ä¿å­˜è¿˜æ˜¯è°ƒç”¨è€…ä¿å­˜

1.  æµ®ç‚¹æ•°æ˜¯æ€ä¹ˆè¢«å­˜å‚¨å’Œè®¿é—®çš„â€”â€”ä¸€èˆ¬æ˜¯é€šè¿‡æµ®ç‚¹å¯„å­˜å™¨
2.  æ“ä½œæµ®ç‚¹æ•°æ®çš„æŒ‡ä»¤
3.  ä¼ é€’æµ®ç‚¹æ•°ä½œä¸ºå‡½æ•°å‚æ•°å’Œè¿”å›å€¼çš„è§„åˆ™
4.  åœ¨å‡½æ•°è°ƒç”¨è¿‡ç¨‹ä¸­ï¼Œå¯„å­˜å™¨æ˜¯æ€ä¹ˆä¿å­˜çš„â€”â€”ä¾‹å¦‚ï¼Œä¸€äº›å¯„å­˜å™¨è¢«è®¾è®¡ä¸ºè°ƒç”¨è€…ä¿å­˜å‹ï¼Œå¦ä¸€äº›è¢«è®¾è®¡ä¸ºè¢«è°ƒç”¨è€…ä¿å­˜å‹

æœ¬èŠ‚çš„ä»‹ç»æ˜¯åŸºäºAVX2[^æ³¨é‡Š22]çš„ï¼Œå½“gccç¼–è¯‘ä½¿ç”¨`-mavx2`å‚æ•°æ—¶å°†ç”ŸæˆAVX2ä»£ç 

![](image/image_PhvUauGwVv.png)

å¦‚å·¦å›¾æ‰€ç¤ºï¼ŒAVX2æ”¯æŒ16ä¸ªYMMå¯„å­˜å™¨ï¼Œå‘½åä¸º`%ymm0~%ymm15`ã€‚æ¯ä¸€ä¸ªymmå¯„å­˜å™¨éƒ½æ˜¯256ä½çš„ã€‚å½“å¯¹æ ‡é‡æ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œè¿™äº›å¯„å­˜å™¨ä»…ä¿å­˜æµ®ç‚¹æ•°æ®ï¼Œå¹¶ä¸”ä»…ä½¿ç”¨ä½ä½ 32 ä½ï¼ˆå¯¹äºæµ®ç‚¹å‹ï¼‰æˆ– 64 ä½ï¼ˆå¯¹äºåŒç²¾åº¦å‹ï¼‰ã€‚æ±‡ç¼–ä»£ç ç”¨å¯„å­˜å™¨çš„SSE XMMå¯„å­˜å™¨`%xmm0~%xmm15`æ¥å¼•ç”¨å®ƒä»¬ï¼Œæ¯ä¸ªXMMå¯„å­˜å™¨éƒ½æ˜¯å¯¹åº”çš„YMMå¯„å­˜å™¨çš„ä½128ä½(16å­—èŠ‚)â€”â€”%xmm0å­˜å‚¨å‡½æ•°è¿”å›çš„æµ®ç‚¹æ•°

## 3.11.1 *Floating-Point Movement and Conversion Operations*

### æµ®ç‚¹æ•°ä¼ é€æŒ‡ä»¤

![](image/image_BAXo_IWRh8.png)

ä¸Šå›¾çš„æŒ‡ä»¤å®ç°çš„æ˜¯â€œå†…å­˜å’Œxmmå¯„å­˜å™¨ä¹‹é—´â€ä»¥åŠâ€œä»ä¸€ä¸ªxmmå¯„å­˜å™¨åˆ°å¦ä¸€ä¸ªä¸åšä»»ä½•è½¬æ¢çš„ä¼ é€â€çš„æµ®ç‚¹æ•°æŒ‡ä»¤

### æµ®ç‚¹æ•°è½¬æ•´æ•°æŒ‡ä»¤

![](image/image_jyBspj_1S0.png)

å°†æµ®ç‚¹æ•°è½¬ä¸ºæ•´æ•°æ—¶ï¼Œä¼šå‘ç”Ÿæˆªæ–­ï¼Œ**æŠŠå€¼å‘0èˆå…¥**

### æ•´æ•°è½¬æµ®ç‚¹æ•°æŒ‡ä»¤

![](image/image_glcoj93cg8.png)

è¿™ç±»æŒ‡ä»¤æ˜¯3æ“ä½œæ•°æ ¼å¼ï¼Œç¬¬ä¸€ä¸ªæ“ä½œæ•°æŒ‡æ˜è¦è½¬æ¢çš„æ•´æ•°æºï¼Œç¬¬äºŒä¸ªæ“ä½œæ•°ä¸€èˆ¬å¯ä»¥å¿½ç•¥ï¼Œå› ä¸ºå®ƒçš„å€¼åªå½±å“ç»“æœçš„é«˜ä½å­—èŠ‚ï¼Œè€Œxmmçš„é«˜64ä½å¹¶ä¸ç”¨åœ¨æ„ã€‚å› æ­¤åœ¨æœ€å¸¸è§çš„ä½¿ç”¨åœºæ™¯ä¸­ï¼Œ**ç¬¬äºŒä¸ªæºæ“ä½œæ•°å’Œç›®çš„æ“ä½œæ•°æ˜¯ä¸€æ ·çš„**

### å•ç²¾åº¦ä¸åŒç²¾åº¦æµ®ç‚¹æ•°ä¹‹é—´çš„è½¬æ¢

1.  å•ç²¾åº¦â†’åŒç²¾åº¦  vcvtss2sd&#x20;
    ```nasm
    vunpcklps %xmm0,%xmm0,%xmm0
    vcvtps2pd %xmm0,%xmm0

    ```
    vunpcklpsæŒ‡ä»¤é€šå¸¸ç”¨æ¥äº¤å‰å­˜æ”¾ä¸¤ä¸ªxmmå¯„å­˜å™¨çš„å€¼ï¼Œå°†å®ƒä»¬å­˜å‚¨åˆ°ç¬¬ä¸‰ä¸ªå¯„å­˜å™¨ä¸­

    ä¾‹å¦‚ç¬¬ä¸€ä¸ªå¯„å­˜å™¨æ˜¯\[s3,s2,s1,s0]ï¼Œç¬¬äºŒä¸ªæ˜¯\[d3,d2,d1,d0]åˆ™ç»“æœæ˜¯\[s1,d1,s0,d0]

    vcvtps2pdæŒ‡ä»¤æŠŠæºxmmå¯„å­˜å™¨ä¸­çš„ä¸¤ä¸ªä½ä½å•ç²¾åº¦æ‰©å±•æˆç›®çš„xmmå¯„å­˜å™¨ä¸­çš„ä¸¤ä¸ªåŒç²¾åº¦å€¼ï¼Œå¾—åˆ°\[dx0,dx0]
2.  åŒç²¾åº¦â†’å•ç²¾åº¦ vcvtsd2ss
    ```nasm
    vmovddup %xmm0,%xmm0
    vcvtpd2psx %xmm0,%xmm0

    ```
    vmovddupæŒ‡ä»¤å°†%xmm0ä¸­çš„\[x1,x0]å˜æˆ\[x0,x0]ï¼Œç‡ƒå°½ä½¿ç”¨vcvtpd2psxå°†è¿™ä¸¤ä¸ªx0è½¬æ¢æˆå•ç²¾åº¦ï¼Œå†å­˜æ”¾åˆ°è¯¥å¯„å­˜å™¨çš„ä½64ä½çš„ä¸€åŠä¸­\[0.0,0.0,x0,x0]

## 3.11.2 *Floating-Point Code in Procedures*

å¯¹äº x86-64ï¼ŒXMM å¯„å­˜å™¨ç”¨äºå°†æµ®ç‚¹å‚æ•°ä¼ é€’ç»™å‡½æ•°å¹¶ä»å‡½æ•°è¿”å›æµ®ç‚¹å€¼ã€‚å¦‚Figure3.45[ğŸ–¼ï¸ å›¾ç‰‡](image/image_x0EQ5ZBW5G.png "ğŸ–¼ï¸ å›¾ç‰‡") æ‰€ç¤ºï¼Œéµå¾ªä»¥ä¸‹çº¦å®šï¼š

1.  å‡½æ•°æœ€å¤šå¯ä»¥ä½¿ç”¨XMMå¯„å­˜å™¨%xmm0\~%xmm7æ¥ä¼ é€’8ä¸ªå‚æ•°ï¼Œä½¿ç”¨é¡ºåºå³ä»0\~7ï¼›å¤šä½™8ä¸ªçš„å‚æ•°å¯ä»¥ä½¿ç”¨stackä¼ é€’
2.  å‡½æ•°è¿”å›å€¼æ˜¯è¢«å­˜å‚¨åœ¨%xmm0ä¸­
3.  æ‰€æœ‰çš„XMMå¯„å­˜å™¨éƒ½æ˜¯â€œ**è°ƒç”¨è€…ä¿å­˜**â€ç±»å‹ï¼Œè¢«è°ƒç”¨çš„ç¨‹åºå¯ä»¥ä¸éœ€è¦å…ˆå…¥æ ˆè¿™äº›å¯„å­˜å™¨è€Œç›´æ¥ä½¿ç”¨å®ƒä»¬

å½“å‡½æ•°åŒ…å«æŒ‡é’ˆã€æ•´æ•°å’Œæµ®ç‚¹å‚æ•°çš„ç»„åˆæ—¶ï¼ŒæŒ‡é’ˆå’Œæ•´æ•°å°†åœ¨é€šç”¨å¯„å­˜å™¨ä¸­ä¼ é€’ï¼Œè€Œæµ®ç‚¹å€¼å°†åœ¨ XMM å¯„å­˜å™¨ä¸­ä¼ é€’ã€‚è¿™æ„å‘³ç€å‚æ•°åˆ°å¯„å­˜å™¨çš„æ˜ å°„å–å†³äºå®ƒä»¬çš„ç±»å‹å’Œé¡ºåº

![](image/image_pC0eyrrxNc.png)

## 3.11.3 *Floating-Point Arithmetic Operations*

![](image/image_VtCjyoDSLm.png)

ä¸Šå›¾æè¿°äº†ä¸€ç»„æ‰§è¡Œæµ®ç‚¹è¿ç®—çš„AVX2æµ®ç‚¹æŒ‡ä»¤

æ¯æ¡æŒ‡ä»¤éƒ½æœ‰ä¸€ä¸ª(S1)æˆ–ä¸¤ä¸ª(S1,S2)æºæ“ä½œæ•°ï¼Œä¸€ä¸ªç›®çš„æ“ä½œæ•°Dã€‚å…¶ä¸­S1å¯ä»¥æ˜¯xmmå¯„å­˜å™¨æˆ–è€…å†…å­˜æ“ä½œæ•°ï¼Œä½†S2å’ŒDå¿…é¡»éƒ½æ˜¯xmmå¯„å­˜å™¨

è€ƒè™‘ä¸‹é¢çš„æµ®ç‚¹å‡½æ•°

![](image/image_Vp6R_QxVPR.png)

å®ƒå¯¹åº”çš„æ±‡ç¼–ä»£ç æ˜¯ï¼šå…ˆè½¬xä¸ºdoubleç„¶åè®¡ç®—ä¹˜æ³•ï¼Œå†è½¬iä¸ºdoubleè®¡ç®—é™¤æ³•ï¼Œæœ€åä½œå·®

![](image/image_tz11kktK7i.png)

## 3.11.4 *Defining and Using Floating-Point Constants*

> âœ¨ä¸æ•´æ•°ç®—æœ¯è¿ç®—ä¸åŒï¼ŒAVX æµ®ç‚¹è¿ç®—ä¸èƒ½å°†ç«‹å³å€¼ä½œä¸ºæ“ä½œæ•°ã€‚å› æ­¤**ç¼–è¯‘å™¨å¿…é¡»ä¸ºä»»ä½•å¸¸é‡å€¼åˆ†é…å’Œåˆå§‹åŒ–å­˜å‚¨ï¼Œç„¶åä»£ç ä»å†…å­˜ä¸­è¯»å–å€¼**
>
> å­˜å‚¨æ—¶è¦å­˜å‚¨doubleå‹çš„å¸¸é‡ï¼Œä½¿ç”¨IEEE754çš„è¡¨ç¤ºæ ‡å‡†å­˜å‚¨äºŒè¿›åˆ¶ï¼Œç„¶åæŒ‰ç…§å¤§å°ç«¯çš„åŸåˆ™ï¼Œå†³å®šå…ˆå­˜å‚¨ä½ä½è¿˜æ˜¯å…ˆå­˜å‚¨é«˜ä½

![](image/image_vQ8obMFFd5.png)

## 3.11.5 *Using Bitwise Operations in Floating-Point Code*

![](image/image_IDRAeHnd_T.png)

å·¦å›¾æ˜¯æµ®ç‚¹æ•°æ®çš„å¼‚æˆ–å’Œä¸è¿ç®—æŒ‡ä»¤

è¿™äº›æŒ‡ä»¤çš„æ“ä½œæ•°æ˜¯æ•´ä¸ªå¯„å­˜å™¨

![](image/image_YldBRwzovz.png)

## 3.11.6 *Floating-Point Comparison Operations*

AVX2æä¾›äº†ä¸¤æ¡ç”¨äºæ¯”è¾ƒæµ®ç‚¹æ•°å€¼çš„æŒ‡ä»¤ï¼Œå‚æ•°S2å¿…é¡»æ˜¯xmmå¯„å­˜å™¨æ•°ï¼Œè€ŒS1å¯ä»¥æ˜¯xmmå¯„å­˜å™¨æ•°ä¹Ÿå¯ä»¥æ˜¯å†…å­˜æ“ä½œæ•°

![](image/image_Piz4KxH61P.png)

æµ®ç‚¹æ¯”è¾ƒæŒ‡ä»¤ä¼šè®¾ç½®ä¸‰ä¸ªæ¡ä»¶ç ï¼šé›¶æ ‡å¿—ZFã€è¿›ä½æ ‡å¿—ä½CFå’Œå¥‡å¶æ ‡å¿—ä½PF

PFä½å¯¹äºæ•´æ•°å’Œæµ®ç‚¹æ•°çš„è®¡ç®—ä¸­çš„è¡¨ç¤ºæ„ä¹‰ä¸åŒ

æ•´æ•°ï¼šè‹¥æœ€è¿‘çš„ä¸€æ¬¡è®¡ç®—ç»“æœçš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸­æœ‰å¶æ•°ä¸ª1åˆ™è®¾ç½®è¯¥ä½ä¸º1

æµ®ç‚¹æ•°ï¼šæµ®ç‚¹æ¯”è¾ƒæ—¶è‹¥ä¸¤ä¸ªæ“ä½œæ•°ä¸­æœ‰ä¸€ä¸ªæ˜¯NaNåˆ™è®¾ç½®è¯¥ä½ï¼Œä½¿ç”¨JPè·³è½¬å¤„ç†è¿™ç§æƒ…å†µ

å¯¹æ¡ä»¶ç çš„è®¾ç½®å€¼å¦‚ä¸‹ï¼š

![](image/image_jhFc74wD5X.png)

ä¸‹é¢æ˜¯ä¸€ä¸ªç¤ºä¾‹â€”â€”æ¯”è¾ƒ0.0å’Œx

![](image/image_g9RRHz9y6u.png)

[^æ³¨é‡Š1]: è™šæ‹Ÿæœºã€è¿›ç¨‹(ISA+è™šæ‹Ÿå†…å­˜)ã€è™šæ‹Ÿå†…å­˜ã€æ–‡ä»¶

[^æ³¨é‡Š2]: x86-64åªæœ‰16ä¸ªæ•´æ•°é€šç”¨å¯„å­˜å™¨

[^æ³¨é‡Š3]: mainæ–‡ä»¶ã€åº“å‡½æ•°æ–‡ä»¶

[^æ³¨é‡Š4]: 2çš„næ¬¡å¹‚

[^æ³¨é‡Š5]: Bã€Wã€DWã€QW

[^æ³¨é‡Š6]: x86-64çš„æƒ¯ä¾‹ï¼šä»»ä½•ä¸ºå¯„å­˜å™¨ç”Ÿæˆ 32 ä½å€¼çš„æŒ‡ä»¤ä¹Ÿä¼šå°†è¯¥å¯„å­˜å™¨çš„é«˜ä½éƒ¨åˆ†è®¾ç½®ä¸º 0

[^æ³¨é‡Š7]: x86-64è§„å®šä»»ä½•äº§ç”Ÿ32ä½ç»“æœçš„æŒ‡ä»¤ï¼Œè‹¥è¦å°†ç»“æœæ”¾ç½®åœ¨64ä½å¯„å­˜å™¨ä¸­ï¼Œå‡éœ€è¦å°†å¯„å­˜å™¨çš„é«˜ä½è®¾ç½®ä¸º0

[^æ³¨é‡Š8]: å› ä¸ºmovqåªèƒ½å¤„ç†32ä½ç«‹å³æ•°ï¼Œè¿™ä¸ªç«‹å³æ•°ç„¶åä¼šè¢«ç¬¦å·æ‰©å±•ä¸º64ä½

[^æ³¨é‡Š9]: å› ä¸ºç¬¬äºŒä¸ªæ“ä½œæ•°ä¹Ÿè¦åšç›®çš„æ“ä½œæ•°

[^æ³¨é‡Š10]: è¿™äº›ä¾‹å­è¯´æ˜ï¼Œå½“æ‰§è¡ŒPâ„ƒCç›¸å¯¹å¯»å€æ—¶ï¼Œç¨‹åºè®¡æ•°å™¨çš„å€¼æ˜¯è·³è½¬æŒ‡ä»¤åé¢çš„é‚£æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œè€Œä¸æ˜¯è·³è½¬æŒ‡ä»¤æœ¬èº«çš„åœ°å€ã€‚è¿™ç§æƒ¯ä¾‹å¯ä»¥è¿½æº¯åˆ°æ—©æœŸçš„å®ç°ï¼Œå½“æ—¶çš„å¤„ç†å™¨ä¼šå°†æ›´æ–°ç¨‹åºè®¡æ•°å™¨ä½œä¸ºæ‰§è¡Œä¸€æ¡æŒ‡ä»¤çš„ç¬¬ä¸€æ­¥ã€‚

[^æ³¨é‡Š11]: ä¸¤ç§æ–¹å¼éƒ½ä½¿ç”¨ä¸ do-while å¾ªç¯ç›¸åŒçš„å¾ªç¯ç»“æ„ï¼Œä½†åœ¨å¦‚ä½•å®ç°åˆå§‹æµ‹è¯•æ–¹é¢æœ‰æ‰€ä¸åŒ

[^æ³¨é‡Š12]: GCCä½¿ç”¨-0gæ—¶ä½¿ç”¨è¿™ç§ç­–ç•¥

[^æ³¨é‡Š13]: æ„æ€æ˜¯dowhileçš„å˜ä½“ï¼Œdowhileçš„æµ‹è¯•åœ¨å¾ªç¯çš„æœ«å°¾

[^æ³¨é‡Š14]: Gcc åœ¨ä½¿ç”¨æ›´é«˜çº§åˆ«çš„ä¼˜åŒ–è¿›è¡Œç¼–è¯‘æ—¶éµå¾ªæ­¤ç­–ç•¥ï¼Œä¾‹å¦‚ä½¿ç”¨å‘½ä»¤è¡Œé€‰é¡¹ -01

[^æ³¨é‡Š15]: å…¶ä¸­caseä¸åŒä¸”å¯¹åº”ä»£ç æ‰§è¡Œä¸åŒçš„ï¼Œä½¿ç”¨ä¸åŒçš„ç¼–å·ï¼›caseä¸åŒä½†å¯¹åº”ä»£ç æ‰§è¡Œç›¸åŒçš„ï¼Œä½¿ç”¨ç›¸åŒçš„ç¼–å·ï¼›caseç¼ºå¤±çš„ä½¿ç”¨åŒä¸€ç§ç¼–å·

[^æ³¨é‡Š16]: å½“åˆ†æ”¯è¾ƒå°‘æˆ–è€…åˆ†æ”¯å¾ˆå¤šä½†å€¼è·¨åº¦è¾ƒå¤§ï¼Œæ±‡ç¼–æˆif-else

[^æ³¨é‡Š17]: På¯èƒ½ä¹Ÿæ˜¯è¢«è°ƒç”¨çš„

[^æ³¨é‡Š18]: %rbxã€%rbpå’Œ%r12\~%r15

[^æ³¨é‡Š19]: ä¼šæ‹›è‡´ä¸¥é‡çš„æ€§èƒ½å¤„ç½š

[^æ³¨é‡Š20]: q->i\[1]æ˜¯ä»ç›¸å¯¹ä½ç½®4å¼€å§‹è®¿é—®

[^æ³¨é‡Š21]: å¶æ•°â€”â€”8n+16
    å¥‡æ•°â€”â€”8n+8

[^æ³¨é‡Š22]: ä»MMXåˆ°SSEåˆ°AVXï¼Œä½¿ç”¨çš„å¯„å­˜å™¨çš„ç§°å‘¼ä»â€œMMâ€åˆ°â€œXMMâ€åˆ°â€œYMMâ€ï¼Œ64åˆ°128åˆ°256
