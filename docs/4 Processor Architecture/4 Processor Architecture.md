# 4 Processor Architecture

## ç›®å½•

-   [è‹±è¯­](#è‹±è¯­)
-   [4.1 The Y86-64 Instruction Set Architecture](#41-The-Y86-64-Instruction-Set-Architecture)
    -   [4.1.1 Programmer-Visible State](#411-Programmer-Visible-State)
    -   [4.1.2 Y86-64 Instructions](#412-Y86-64-Instructions)
    -   [4.1.3 Instruction Encoding](#413-Instruction-Encoding)
        -   [Instruction specifier](#Instruction-specifier)
        -   [Register specifier](#Register-specifier)
        -   [8B Constant](#8B-Constant)
        -   [ç¤ºä¾‹](#ç¤ºä¾‹)
        -   [RISC and CISC](#RISC-and-CISC)
    -   [4.1.4 Y86-64 Exception](#414-Y86-64-Exception)
    -   [4.1.5 Y86-64 Procedure](#415-Y86-64-Procedure)
    -   [4.1.5 Some Y86-64 Instruction Details](#415-Some-Y86-64-Instruction-Details)
-   [4.2 Logic Design and the Hardware Control Language HCL](#42-Logic-Design-and-the-Hardware-Control-Language-HCL)
    -   [4.2.1 Logic Gates](#421-Logic-Gates)
    -   [4.2.2 Combinational Circuits and HCL Boolean Expressions](#422-Combinational-Circuits-and-HCL-Boolean-Expressions)
    -   [4.2.3 Word-Level Combinational Circuits and HCL Integer Expressions](#423-Word-Level-Combinational-Circuits-and-HCL-Integer-Expressions)
    -   [4.2.4 Set Membership](#424-Set-Membership)
    -   [4.2.5 Memory and Clocking](#425-Memory-and-Clocking)
        -   [ç¡¬ä»¶å¯„å­˜å™¨](#ç¡¬ä»¶å¯„å­˜å™¨)
        -   [ç¨‹åºå¯„å­˜å™¨](#ç¨‹åºå¯„å­˜å™¨)
        -   [æ•°æ®å­˜å‚¨å™¨](#æ•°æ®å­˜å‚¨å™¨)
        -   [æŒ‡ä»¤å­˜å‚¨å™¨](#æŒ‡ä»¤å­˜å‚¨å™¨)
-   [4.3 Sequential Y86-64 Implementations](#43-Sequential-Y86-64-Implementations)
    -   [4.3.1 Organizing Processing into Stages](#431-Organizing-Processing-into-Stages)
        -   [æŒ‡ä»¤æ‰§è¡Œé˜¶æ®µåºåˆ—](#æŒ‡ä»¤æ‰§è¡Œé˜¶æ®µåºåˆ—)
        -   [è®¾è®¡åŸåˆ™](#è®¾è®¡åŸåˆ™)
        -   [Y86-64æŒ‡ä»¤é›†é€šç”¨æ¡†æ¶](#Y86-64æŒ‡ä»¤é›†é€šç”¨æ¡†æ¶)
            -   [OPq rA,rB](#OPq-rArB)
            -   [rrmovq rA,rB](#rrmovq-rArB)
            -   [irmovq V,rB](#irmovq-VrB)
            -   [rmmovq rA,D(rB)](#rmmovq-rADrB)
            -   [mrmovq D(rB),rA](#mrmovq-DrBrA)
            -   [pushq rA](#pushq-rA)
            -   [popq rA](#popq-rA)
            -   [jXX Dest](#jXX-Dest)
            -   [call Dest](#call-Dest)
            -   [ret](#ret)
            -   [cmovq](#cmovq)
    -   [4.3.2 SEQ Hardware Structure](#432-SEQ-Hardware-Structure)
        -   [å„é˜¶æ®µå¯¹åº”çš„ç¡¬ä»¶å•å…ƒ](#å„é˜¶æ®µå¯¹åº”çš„ç¡¬ä»¶å•å…ƒ)
        -   [ç¡¬ä»¶å›¾çš„ç”»å›¾æƒ¯ä¾‹](#ç¡¬ä»¶å›¾çš„ç”»å›¾æƒ¯ä¾‹)
        -   [SEQè¯¦ç»†ç¡¬ä»¶å›¾](#SEQè¯¦ç»†ç¡¬ä»¶å›¾)
    -   [4.3.3 SEQ Timing](#433-SEQ-Timing)
    -   [4.3.4 SEQ Stage Implementations](#434-SEQ-Stage-Implementations)
        -   [å–æŒ‡é˜¶æ®µ](#å–æŒ‡é˜¶æ®µ)
        -   [è¯‘ç ã€å†™å›é˜¶æ®µ](#è¯‘ç å†™å›é˜¶æ®µ)
        -   [æ‰§è¡Œé˜¶æ®µ](#æ‰§è¡Œé˜¶æ®µ)
        -   [è®¿å­˜é˜¶æ®µ](#è®¿å­˜é˜¶æ®µ)
        -   [æ›´æ–°PCé˜¶æ®µ](#æ›´æ–°PCé˜¶æ®µ)
-   [4.4 General Principles of Pipelining](#44-General-Principles-of-Pipelining)
    -   [4.4.1 Computational Pipelines](#441-Computational-Pipelines)
    -   [4.4.2 A Detailed Look at Pipeline Operation](#442-A-Detailed-Look-at-Pipeline-Operation)
    -   [4.4.3 Limitations of Pipelining](#443-Limitations-of-Pipelining)
        -   [Nonuniform Partitioning](#Nonuniform-Partitioning)
        -   [Diminishing Returns of Deep Pipelining](#Diminishing-Returns-of-Deep-Pipelining)
    -   [4.4.4 Pipelining a System with Feedback](#444-Pipelining-a-System-with-Feedback)
-   [4.5 Pipelined Y86-64 Implementations](#45-Pipelined-Y86-64-Implementations)
    -   [4.5.1 SEQ+: Rearranging the Computation Stages](#451-SEQ-Rearranging-the-Computation-Stages)
    -   [4.5.2 Inserting Pipeline Registers](#452-Inserting-Pipeline-Registers)
        -   [PIPE-ç¡¬ä»¶ç»“æ„](#PIPE-ç¡¬ä»¶ç»“æ„)
        -   [ä»£ç åˆ†æç¤ºä¾‹](#ä»£ç åˆ†æç¤ºä¾‹)
    -   [4.5.3 Rearranging and Relabeling Signals](#453-Rearranging-and-Relabeling-Signals)
    -   [4.5.4 Next PC Prediction](#454-Next-PC-Prediction)
    -   [4.5.5 Pipeline Hazards](#455-Pipeline-Hazards)
        -   [Avoiding Data Hazards by Stalling](#Avoiding-Data-Hazards-by-Stalling)
        -   [Avoiding Data Hazards by Forwarding](#Avoiding-Data-Hazards-by-Forwarding)
        -   [Load/Use Data Hazards](#LoadUse-Data-Hazards)
        -   [Avoiding Control Hazards](#Avoiding-Control-Hazards)
    -   [4.5.6 Exception Hanlling](#456-Exception-Hanlling)
        -   [Brief Introduction](#Brief-Introduction)
        -   [Exception in Y86-64](#Exception-in-Y86-64)
        -   [Exception handling in pipelined system](#Exception-handling-in-pipelined-system)
    -   [4.5.7 PIPE Stage Implementations](#457-PIPE-Stage-Implementations)
        -   [PC Selection and Fetch Stage](#PC-Selection-and-Fetch-Stage)
        -   [Decode and Write-Back Stages](#Decode-and-Write-Back-Stages)
        -   [Execute Stage](#Execute-Stage)
        -   [Memory Stage](#Memory-Stage)
        -   [Pipeline Control Logic](#Pipeline-Control-Logic)
            -   [Desired Handling for each of Special Control Cases](#Desired-Handling-for-each-of-Special-Control-Cases)
            -   [Detecting Special Control Conditions](#Detecting-Special-Control-Conditions)
        -   [Pipeline Control Mechanisms](#Pipeline-Control-Mechanisms)
        -   [Combinations of Control Conditions](#Combinations-of-Control-Conditions)
        -   [Control Logic Implementation](#Control-Logic-Implementation)
    -   [4.5.9 Performance Analysis](#459-Performance-Analysis)
    -   [4.5.10 Unfinished Business](#4510-Unfinished-Business)
        -   [å¤šå‘¨æœŸæŒ‡ä»¤](#å¤šå‘¨æœŸæŒ‡ä»¤)
        -   [ä¸å­˜å‚¨ç³»ç»Ÿçš„æ¥å£](#ä¸å­˜å‚¨ç³»ç»Ÿçš„æ¥å£)

# è‹±è¯­

1.  dwarfä½¿â€¦â€¦ç›¸å½¢è§ç»Œ
2.  manufactureråˆ¶é€ å•†
3.  retrievalæ£€ç´¢
4.  embodyä½“ç°
5.  conciseç®€æ´çš„
6.  assembleè£…é…
7.  mutuallyç›¸äº’åœ°
8.  criteriaæ ‡å‡†
9.  precedeå‰é¢çš„
10. indefinitelyæ— é™æœŸåœ°
11. redundantå¤šä½™çš„
12. precedingå…ˆå‰çš„
13. diminishå‡å°‘
14. progressionè¿›å±•
15. erroneousé”™è¯¯çš„
16. pendingæ‚¬è€Œæœªå†³çš„ï¼›å¾…å¤„ç†çš„ï¼›ç›´åˆ°â€¦â€¦ä¸ºæ­¢
17. subtleå¾®å¦™çš„
18. deferæ¨è¿Ÿ
19. penaltyä¹˜æ³•
20. envisionè®¾æƒ³
21. whileåŒæ—¶
22. intrinsicå›ºæœ‰çš„
23. monolithicæ•´ä½“å¼çš„
24. contemporaryå½“ä»£çš„
25. acyclicæ— ç¯çš„
26. exclusiveä¸“æœ‰çš„
27. periodicå‘¨æœŸæ€§çš„
28. diagrammå›¾è§£
29. idiosyncrasyç‰¹è´¨
30. sprayå–·æ¶‚
31. reciprocalå€’æ•°ã€äº’æƒ çš„
32. appreciateæ¬£èµã€æ„Ÿæ¿€ã€äº†è§£
33. justifyè¯æ˜
34. concern oneself withå…³æ³¨
35. hold backæ§åˆ¶
36. glimpseç¥
37. mutuallyç›¸äº’
38. fall short of the goal ofè¾¾ä¸åˆ°â€¦â€¦ç›®æ ‡

> \*The instructions supported by a particular processor and their byte-level encodings are known as its \*\*instruction set architecture \**(ISA)*
>
> *Each manufacturer produces processors of ever-growing performance and complexity, but*-   the different models remain compatible at the ISA level.\*â€‹
>
> -   The ISA provides a conceptual layer of abstraction between compiler writers, who need only know what instructions are permitted and how they are encoded, and processor designers, who must build machines that execute those instructions.\*
>
> æŒ‡ä»¤é›†æ¶æ„åœ¨ç¼–è¯‘å™¨ç¼–å†™è€…å’Œå¤„ç†å™¨è®¾è®¡è€…ä¹‹é—´æä¾›ä¸€å±‚æŠ½è±¡æ¦‚å¿µå±‚
>
> ç¼–è¯‘å™¨ç¼–å†™è€…åªéœ€è¦çŸ¥é“æ¶æ„å†…å­˜åœ¨å“ªäº›æŒ‡ä»¤ä»¥åŠè¿™äº›æŒ‡ä»¤æ˜¯æ€ä¹ˆè¢«ç¼–ç çš„
>
> å¤„ç†å™¨è®¾è®¡è€…åˆ™å¿…é¡»è¦è®¾è®¡æ‰§è¡Œè¿™äº›æŒ‡ä»¤çš„æœºå™¨

# 4.1 *The Y86-64 Instruction Set Architecture*

> å¯ä»¥å°†Y86-64è§†ä¸ºX86-64çš„ç²¾ç®€ç‰ˆï¼ŒåŒ…æ‹¬çŠ¶æ€çš„ä¸åŒç»„æˆéƒ¨åˆ†ï¼ŒæŒ‡ä»¤é›†ä»¥åŠæŒ‡ä»¤é›†çš„ç¼–ç æ ¼å¼ã€ç¼–ç¨‹æƒ¯ä¾‹å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶

## 4.1.1 *Programmer-Visible State*

![](image/image_0nRl5pH8NG.png)

Y86-64ä¸­çš„æ¯æ¡æŒ‡ä»¤éƒ½å¯ä»¥è¯»æˆ–è€…ä¿®æ”¹å¤„ç†å™¨çš„ä¸€äº›çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€ç§°ä¸ºâ€œç¨‹åºå‘˜[^æ³¨é‡Š1]å¯è§çŠ¶æ€â€

Y86-64çš„å¤„ç†å™¨çŠ¶æ€åŒ…æ‹¬ï¼š15ä¸ª64ä½çš„å¯„å­˜å™¨ã€ZFã€SFã€OFä¸‰ä¸ªçŠ¶æ€ç ã€PCã€Statã€ä¸»å­˜

15ä¸ªå¯„å­˜å™¨åŒ…æ‹¬%raxã€%rcxã€%rdxã€%rbxã€%rspã€%rbpã€%rsiã€%rdiã€%r8\~%r14

ZFã€OFã€SFä¸‰ä¸ªç”¨äºæ•´æ•°ç®—æœ¯ã€é€»è¾‘è¿ç®—æ•ˆæœçš„æŒ‡ä»¤

PCå­˜å‚¨ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€

StatçŠ¶æ€ç è¡¨ç¤ºç¨‹åºæ‰§è¡Œçš„æ•´ä½“çŠ¶æ€ï¼Œå¯ä»¥è¡¨ç¤ºå½“å‰ç¨‹åºæ˜¯åœ¨æ­£å¸¸æ“ä½œæ‰§è¡Œè¿˜æ˜¯å‘ç”ŸæŸç§å¼‚å¸¸

ä¸»å­˜åœ¨æ¦‚å¿µä¸Šæ˜¯å­˜å‚¨ç¨‹åºå’Œæ•°æ®çš„å¤§çš„å­—èŠ‚æ•°ç»„ï¼ŒY86-64ä½¿ç”¨è™šæ‹Ÿå­˜å‚¨ï¼Œç”±æ“ä½œç³»ç»Ÿå’Œç¡¬ä»¶åˆä½œå°†è™šæ‹Ÿåœ°å€ç¿»è¯‘ä¸ºç‰©ç†åœ°å€

## 4.1.2 *Y86-64 Instructions*

![](image/image_hbiqxGOhNP.png)

Y86-64æ‰€æ”¯æŒçš„æŒ‡ä»¤é›†å¦‚ä¸Šå›¾æ‰€ç¤ºï¼ŒæŒ‡ä»¤æ‰€æ“ä½œçš„å¯¹è±¡æ˜¯8å­—èŠ‚æ•´æ•°

1.  å°†movqæŒ‡ä»¤æŒ‰ç…§æºå’Œç›®çš„æ“ä½œæ•°çš„å½¢å¼åˆ’åˆ†ä¸º`irmovq`ã€`rmmovq`ã€`mrmovq`ã€`rrmovq`

    å…¶ä¸­æºæ“ä½œæ•°å¯ä»¥æ˜¯iç«‹å³æ•°ã€rå¯„å­˜å™¨ã€må­˜å‚¨å™¨(æŒ‡ä»¤åŠ©è®°ç¬¦çš„ç¬¬ä¸€ä¸ªå­—ç¬¦)ï¼Œç›®çš„æ“ä½œæ•°å¯ä»¥æ˜¯rå¯„å­˜å™¨ã€må­˜å‚¨å™¨(æŒ‡ä»¤åŠ©è®°ç¬¦çš„ç¬¬äºŒä¸ªå­—ç¬¦)

    å­˜å‚¨å™¨æ“ä½œæ•°çš„å†…å­˜å¼•ç”¨æ–¹å¼æ˜¯ç®€å•çš„åŸºå€å’Œåç§»é‡å½¢å¼ï¼Œä¸æ”¯æŒå˜å€å’Œç¼©æ”¾çš„å†…å­˜å¼•ç”¨å½¢å¼

    åŒx86-64ï¼Œä¸æ”¯æŒå†…å­˜å’Œå†…å­˜ä¹‹é—´çš„æ•°æ®ç›´æ¥ä¼ é€’ï¼Œä¹Ÿä¸æ”¯æŒå°†ç«‹å³æ•°ç›´æ¥ä¼ é€åˆ°å†…å­˜
2.  OPqæŒ‡ä»¤è¡¨ç¤ºåŸºäºæ•´æ•°çš„å››ç§è¿ç®—æŒ‡ä»¤ï¼š`addq`ã€`subq`ã€`andq`ã€`xorq`

    ä¸åƒx86-64å…è®¸æ•´æ•°è¿ç®—æŒ‡ä»¤ç›´æ¥æ“ä½œå­˜å‚¨å™¨æ•°æ®ï¼ŒOPqæŒ‡ä»¤ä»…ä»…åœ¨å¯„å­˜å™¨æ•°æ®ä¸Šæ“ä½œ

    OPqæŒ‡ä»¤å¯ä»¥è®¾ç½®SFã€ZFã€OFæ¡ä»¶ç ä½
3.  jXXæŒ‡ä»¤è¡¨ç¤º7ç§è·³è½¬æŒ‡ä»¤ï¼š`jmp`ã€`jle`ã€`jl`ã€`je`ã€`jne`ã€`jge`ã€`jg`

    è·³è½¬æŒ‡ä»¤æ‰§è¡Œè·³è½¬çš„æ¡ä»¶åŒx86-64
4.  cmovXXè¡¨ç¤º6ç§æ¡ä»¶ä¼ é€æŒ‡ä»¤ï¼š`cmovle`ã€`cmovl`ã€`cmove`ã€`cmovne`ã€`cmovge`ã€`cmovg`

    cmovXXæŒ‡ä»¤çš„æ ¼å¼åŒrrmovqï¼Œæ˜¯å¯„å­˜å™¨å’Œå¯„å­˜å™¨ä¹‹é—´çš„æ•°æ®ä¼ é€
5.  callå’Œret

    callæŒ‡ä»¤å°†è¿”å›åœ°å€å…¥æ ˆï¼Œå¹¶å°†ç›®çš„åœ°å€é€PC

    retæŒ‡ä»¤åˆ™å–è¿”å›åœ°å€é€PC
6.  pushqå’Œpopq

    åŒx86-64çš„pushqã€popq

    pushqå…ˆå°†%rspå‡8ç„¶åå…¥æ ˆæ•°æ®ï¼Œpopqå…ˆå–%rspå†…å­˜å¼•ç”¨ä¸Šçš„æ•°æ®ï¼Œç„¶ååŠ %rsp 8
7.  haltæŒ‡ä»¤æš‚åœæŒ‡ä»¤çš„æ‰§è¡Œ

    x86-64ä¸­æœ‰ç±»ä¼¼çš„æŒ‡ä»¤hltï¼Œä½†æ˜¯å¹¶ä¸å…è®¸åº”ç”¨ç¨‹åºæ‰§è¡Œè¯¥æ¡æŒ‡ä»¤ï¼Œå› ä¸ºå®ƒä¼šæš‚åœæ•´ä¸ªç³»ç»Ÿçš„æ“ä½œ

    åœ¨Y86-64ä¸­ï¼ŒhaltæŒ‡ä»¤çš„æ‰§è¡Œä¼šä½¿å¾—å¤„ç†å™¨åœæ­¢ï¼Œè®¾ç½®çŠ¶æ€ç ä¸ºHLT

## 4.1.3 *Instruction Encoding*

[ğŸ–¼ï¸ å›¾ç‰‡](image/image_Fk_7K5nsTC.png "ğŸ–¼ï¸ å›¾ç‰‡")Figure4.2ä¹Ÿå±•ç¤ºå‡ºäº†Y86-64æŒ‡ä»¤é›†çš„ä½çº§ç¼–ç ï¼š

1.  æŒ‡ä»¤ç¼–ç é•¿åº¦èŒƒå›´åœ¨1å­—èŠ‚åˆ°10å­—èŠ‚ä¹‹é—´
2.  æ¯æ¡æŒ‡ä»¤éƒ½ä»¥1å­—èŠ‚çš„æŒ‡ä»¤æŒ‡ç¤ºç¬¦å¼€å§‹ï¼Œå¯èƒ½ä¼šæœ‰1å­—èŠ‚çš„å¯„å­˜å™¨æŒ‡ç¤ºç¬¦ã€8å­—èŠ‚çš„å¸¸é‡
3.  fnå­—æ®µåŸŸè¡¨ç¤ºäº†ä¸€ä¸ªç‰¹å®šçš„æ•´æ•°è¿ç®—æˆ–è€…æ˜¯æ¡ä»¶ä¼ é€æˆ–è€…æ˜¯åˆ†æ”¯æŒ‡ä»¤

### *Instruction specifier*

æ¯æ¡æŒ‡ä»¤éƒ½æœ‰ä¸€å­—èŠ‚çš„æŒ‡ä»¤æŒ‡ç¤ºç¬¦æ¥è¡¨ç¤ºå½“å‰æŒ‡ä»¤ç±»å‹ã€‚è¿™ä¸€å­—èŠ‚è¢«åˆ†ä¸ºä¸¤ä¸ª4ä½éƒ¨åˆ†ï¼šé«˜4ä½è¡¨ç¤ºä»£ç ï¼Œä½4ä½è¡¨ç¤ºåŠŸèƒ½

ä»£ç å­—æ®µçš„å€¼èŒƒå›´åœ¨0\~0xBä¹‹é—´

åŠŸèƒ½å­—æ®µä»…ç”¨äºåŒºåˆ†ä¸€ç»„å…±äº«ä»£ç å­—æ®µçš„æŒ‡ä»¤é›†åˆçš„æŸä¸ªæŒ‡ä»¤ï¼Œå¦‚ä¸‹

![](image/image_r8TVEV9QPu.png)

å€¼å¾—æ³¨æ„çš„æ˜¯rrmovqä¸cmovXXå…·æœ‰åŒæ ·çš„æ ¼å¼ï¼Œå¯ä»¥è¢«è§†ä¸ºjmpç±»çš„cmovï¼Œå®ƒçš„åŠŸèƒ½å­—æ®µå€¼æ°å¥½ä¸º0

### *Register specifier*

![](image/image_aFpwq6i8Qs.png)

å¯„å­˜å™¨æŒ‡ç¤ºç¬¦çš„ç¼–ç æ˜¯ä»0x0\~0xEã€‚Y86-64å’ŒX86-64å¯„å­˜å™¨ç¼–å·æ˜¯åŒ¹é…çš„(0xFä¸º%r15)

**åœ¨Y86-64ä¸­çš„0xFè¡¨ç¤ºä¸è®¿é—®å¯„å­˜å™¨**ï¼Œå¦‚`irmovq`ã€`popq`ã€`pushq`è¿™äº›åªéœ€è¦ä¸€ä¸ªå¯„å­˜å™¨æ“ä½œæ•°çš„æŒ‡ä»¤ï¼Œå¦ä¸€ä¸ªå¯„å­˜å™¨æ“ä½œæ•°å­—æ®µçš„å€¼å³ä¸º0xF

### 8B Constant

8Bçš„å¸¸é‡å­—å¯ä»¥ä½œä¸ºirmovqä¸­çš„ç«‹å³æ•°ã€rmmovqå’Œmrmovqä¸­çš„å†…å­˜å¼•ç”¨çš„ä½ç§»ä»¥åŠåˆ†æ”¯å’Œè°ƒç”¨çš„ç›®çš„åœ°ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯Y86-64ä¸­çš„åˆ†æ”¯å’Œè°ƒç”¨ç›®çš„åœ°å€ä»¥ç»å¯¹åœ°å€ç»™å‡ºâ€”â€”X86-64ä¸­æ˜¯é‡‡ç”¨PCç›¸å¯¹å¯»å€ã€‚ä¸”ä¸X86-64ä¸€æ ·ï¼Œæ‰€æœ‰æ•´æ•°é‡‡ç”¨å°ç«¯ç¼–ç 

### ç¤ºä¾‹

ä¾‹å¦‚æŒ‡ä»¤â€œ`rmmovq %rsp,0x123456789abcd(%rdx)`â€çš„æœºå™¨ç¼–ç ä¸º"0x4042cdab896745230100"

> âœ¨*One important property of any instruction set is that the byte encodings must have a unique interpretation. An arbitrary sequence of bytes either encodes a unique instruction sequence or is not a legal byte sequence.*
>
> Y86-64å°±æ˜¯è¿™æ ·ï¼Œåªè¦çŸ¥é“æŒ‡ä»¤æŒ‡ç¤ºç¬¦è¿™ä¸€å­—èŠ‚æˆ‘ä»¬å°±èƒ½å†³å®šå…¶ä»–é™„åŠ å­—èŠ‚çš„é•¿åº¦å’Œå«ä¹‰ã€‚ä½†æ˜¯å¦‚æœä¸çŸ¥é“ä¸€æ®µä»£ç åºåˆ—çš„èµ·å§‹ä½ç½®ï¼Œæˆ‘ä»¬å°±ä¸èƒ½å‡†ç¡®åœ°ç¡®å®šæ€æ ·å°†åºåˆ—åˆ’åˆ†æˆå•ç‹¬çš„æŒ‡ä»¤

### RISC and CISC

![](image/image_AggxvIWsto.png)

è€ŒY86-64æŒ‡ä»¤é›†æ—¢æœ‰CISCæŒ‡ä»¤é›†çš„å±æ€§ä¹Ÿæœ‰RISCæŒ‡ä»¤é›†çš„å±æ€§ã€‚å’ŒCISCä¸€æ ·ï¼Œå®ƒæœ‰æ¡ä»¶ç ï¼Œé•¿åº¦å¯å˜çš„æŒ‡ä»¤ï¼Œå¹¶ç”¨æ ˆæ¥ä¿å­˜è¿”å›åœ°å€ã€‚å’ŒRISCä¸€æ ·çš„æ˜¯ï¼Œé‡‡ç”¨load-storeæœºåˆ¶å’Œè§„åˆ™ç¼–ç ï¼Œé€šè¿‡å¯„å­˜å™¨æ¥ä¼ å‚â€”â€”Y86-64å¯ä»¥çœ‹ä½œæ˜¯é‡‡ç”¨äº†CISC x86-64æŒ‡ä»¤é›†ï¼Œä½†åˆ©ç”¨RISCçš„ä¸€äº›è§„åˆ™è¿›è¡Œäº†ç®€åŒ–

RISCå’ŒCISCçš„å‘å±•è¶‹åŠ¿æ˜¯ç›¸ç»“åˆçš„ï¼Œè€Œä¸”å„åœ¨ä¸åŒçš„å¸‚åœºä¸Šè¡¨ç°å¾—å¾ˆå‡ºè‰²

## 4.1.4 *Y86-64 Exception*

åœ¨4.1.1[ğŸ–¼ï¸ å›¾ç‰‡](image/image_4SkZmBQ-pU.png "ğŸ–¼ï¸ å›¾ç‰‡")ä¸­è®²åˆ°ï¼Œç¨‹åºå‘˜çš„å¯è§çŠ¶æ€ä¸­åŒ…å«ä¸€ä¸ªStatçŠ¶æ€ç ä½ï¼Œå…¶å€¼å¦‚ä¸‹ï¼š

![](image/image_k0BhdwQC6k.png)

å€¼ä¸º1æ—¶ï¼Œè¡¨ç¤ºAOKï¼Œå³è¡¨ç¤ºç¨‹åºæ­£å¸¸æ‰§è¡Œ

å€¼ä¸º2æ—¶ï¼Œè¡¨ç¤ºHLTï¼Œæ˜¯ç”±æŒ‡ä»¤`halt`å¼•èµ·çš„ï¼Œè¡¨ç¤ºå¤„ç†å™¨æš‚åœæ‰§è¡ŒæŒ‡ä»¤

å€¼ä¸º3æ—¶ï¼Œè¡¨ç¤ºADRï¼Œå³å¤„ç†å™¨åœ¨è·å–æŒ‡ä»¤æˆ–è¯»å–æˆ–å†™å…¥æ•°æ®æ—¶å°è¯•è¯»å–æˆ–å†™å…¥æ— æ•ˆçš„å†…å­˜åœ°å€

æ ¹æ®å…·ä½“çš„å®ç°ç»†èŠ‚é™åˆ¶æœ€å¤§çš„åœ°å€èŒƒå›´ï¼Œè¶…å‡ºæ­¤èŒƒå›´çš„åœ°å€çš„è®¿é—®å‡ä¼šè§¦å‘ADRå¼‚å¸¸

å€¼ä¸º4æ—¶ï¼Œè¡¨ç¤ºINSï¼Œå³æ— æ•ˆçš„æŒ‡ä»¤

## 4.1.5\* Y86-64 Procedure\*

å¯¹äºä¸‹åˆ—Cå‡½æ•°ï¼Œè§‚å¯Ÿå®ƒçš„x86-64æ±‡ç¼–ä»£ç å’ŒY86-64æ±‡ç¼–ä»£ç ï¼š

![](image/image_Ea1Ri3E1Dv.png)

![](image/image_PeeyG6beE0.png)

å¯ä»¥çœ‹åˆ°ä»¥ä¸‹å‡ ç‚¹ä¸åŒï¼š

1.  Y86-64æ˜¯load-storeæ¶æ„ï¼Œæ‰€æœ‰çš„ç®—æœ¯è¿ç®—å‡æ˜¯å¯„å­˜å™¨å’Œå¯„å­˜å™¨ä¹‹é—´çš„ï¼Œä¸å­˜åœ¨å¯„å­˜å™¨å’Œç«‹å³æ•°è¿ç®—ï¼Œå› æ­¤éœ€è¦2-3è¡Œçš„æ±‡ç¼–ä»£ç `irmovq`ï¼›ä¹Ÿä¸å­˜åœ¨å­˜å‚¨å™¨æ“ä½œæ•°å’Œå¯„å­˜å™¨ä¹‹é—´çš„è¿ç®—ï¼Œå› æ­¤éœ€è¦ç¬¬8è¡Œçš„`mrmovq`

![](image/image_J1hOw87Rev.png)

å…¶ä¸­"`.`"å¼€å¤´çš„æ˜¯æ±‡ç¼–å™¨ä¼ªæŒ‡ä»¤ï¼Œå‘Šè¯‰æ±‡ç¼–å™¨è°ƒæ•´ç”Ÿæˆä»£ç çš„åœ°å€æˆ–æ’å…¥ä¸€äº›æ•°æ®å­—

`.pos 0`è¡¨ç¤ºæ±‡ç¼–å™¨åº”è¯¥ä»åœ°å€0å¼€å§‹ç”Ÿæˆä»£ç â€”â€”æ‰€æœ‰Y86-64æ±‡ç¼–ç¨‹åºå‡ä»¥è¯¥ä¼ªæŒ‡ä»¤å¼€å§‹

`.align 8`è¡¨ç¤ºæ±‡ç¼–å™¨æ’å…¥æ•°æ®çš„å¯¹é½åç§»é‡ä¸º8B

åœ¨å®éªŒçš„è¿‡ç¨‹ä¸­ä¼šç”¨åˆ°yaså’Œyis

![](image/image_IC1Ope1olB.png)

## 4.1.5\* Some Y86-64 Instruction Details\*

éœ€è¦æ³¨æ„ä¸¤ç§ç‰¹åˆ«çš„æŒ‡ä»¤çš„ç»„åˆ

1.  pushq %rspæ˜¯å­˜æ”¾åŸæ¥çš„%rspè¿˜æ˜¯å‡8ä¹‹åçš„%rsp

    ![](image/image__UGLrrMCT5.png)

    æ€»è¿”å›0è¯´æ˜ï¼Œ**push %rspä¿å­˜çš„æ˜¯åŸæ¥çš„%rspå³æœªå‡8çš„**
2.  popq %rspæ˜¯æ¢å¤æ ˆä¸­çš„å€¼è¿˜æ˜¯åŸæ¥çš„%rsp+8

    ![](image/image_18m-ElW_S9.png)

    è¿”å›çš„æ€»æ˜¯0xabcdï¼Œè¡¨æ˜**popq %rspå¾—åˆ°çš„æ˜¯æ ˆä¸­çš„å€¼**

# 4.2 *Logic Design and the Hardware Control Language HCL*

å¤§å¤šæ•°ç°ä»£çš„é€»è¾‘è®¾è®¡ç”µè·¯å°†é€»è¾‘1è®¾ç½®ä¸º1.0vçš„é«˜ç”µå¹³ï¼Œå°†0è®¾ç½®ä¸º0.0vçš„ä½ç”µå¹³ã€‚å®ç°æ•°å­—ç³»ç»Ÿéœ€è¦ä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼šç”¨äºè®¡ç®—ä½åŠŸèƒ½çš„ç»„åˆé€»è¾‘ç”µè·¯ã€ç”¨äºå­˜å‚¨ä½çš„å­˜å‚¨å…ƒä»¶ä»¥åŠç”¨äºè°ƒèŠ‚å­˜å‚¨å…ƒä»¶æ›´æ–°çš„æ—¶é’Ÿä¿¡å·ã€‚

HCLç¡¬ä»¶æ§åˆ¶è¯­è¨€æ˜¯ç”¨æ¥æè¿°ç¡¬ä»¶è®¾è®¡çš„æ§åˆ¶éƒ¨åˆ†ï¼Œåªè¡¨ç¤ºæœ‰é™çš„æ“ä½œé›†åˆã€‚ä½¿ç”¨å°†HCLç›´æ¥è½¬æ¢ä¸ºVerilogçš„å·¥å…·ï¼Œå°†è½¬æ¢åçš„ä»£ç ä¸åŸºæœ¬çš„ç¡¬ä»¶å•å…ƒçš„Verilogä»£ç ç»“åˆèµ·æ¥ï¼Œå°±èƒ½äº§ç”ŸHDLç¡¬ä»¶æè¿°è¯­è¨€ï¼Œä»è€Œåˆæˆèƒ½å¤Ÿå®é™…èƒ½å¤Ÿå·¥ä½œçš„å¾®å¤„ç†å™¨

## 4.2.1 Logic Gates

![](image/image__NqY0zAtDd.png)

é€»è¾‘é—¨æ˜¯æ•°å­—ç”µè·¯çš„åŸºæœ¬è®¡ç®—å…ƒä»¶ï¼Œé€»è¾‘é—¨çš„è¾“å‡ºæ˜¯å…¶è¾“å…¥ä½å€¼çš„å¸ƒå°”å‡½æ•°ï¼Œå¦‚ä¸ANDã€æˆ–ORã€éNOTã€‚ä¸Šå›¾å³ä¸ºé€»è¾‘é—¨éƒ¨ä»¶çš„ç¤ºæ„å›¾ä»¥åŠHCLæè¿°ã€‚

æ³¨æ„è¿™é‡Œä½¿ç”¨&&ã€||ã€!ä»£æ›¿Cä¸­çš„&ã€|ã€\~ã€‚å› ä¸ºé€»è¾‘é—¨æ˜¯å¯¹å•ä¸ªä½ï¼Œè€Œä¸æ˜¯æ•´ä¸ªå­—è¿›è¡Œè¿ç®—çš„ã€‚

> âœ¨é€»è¾‘é—¨æ€»æ˜¯å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œå½“è¾“å…¥æ”¹å˜æ—¶ï¼Œåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…ï¼Œè¾“å‡ºä¹Ÿä¼šéšä¹‹æ”¹å˜

## 4.2.2 *Combinational Circuits and HCL Boolean Expressions*

é€šè¿‡å°†å¤šä¸ªé€»è¾‘é—¨ç»„è£…æˆä¸€ä¸ªç½‘ç»œï¼Œå°±å¯ä»¥æ„å»ºç§°ä¸ºç»„åˆç”µè·¯çš„è®¡ç®—å—ã€‚ä½†æ˜¯ç½‘ç»œæ­å»ºçš„æ–¹å¼éœ€è¦å—åˆ°ä¸€å®šçš„é™åˆ¶ï¼š

1.  é€»è¾‘é—¨çš„è¾“å…¥å¿…é¡»æ˜¯â€œä¸€ä¸ªç³»ç»Ÿè¾“å…¥ï¼ˆç§°ä¸ºä¸»è¾“å…¥ï¼‰â€ã€â€œæŸä¸ªç›¸è¿æ¥çš„å­˜å‚¨å™¨å•å…ƒçš„è¾“å‡ºâ€ã€â€œæŸä¸ªé€»è¾‘é—¨çš„è¾“å‡ºâ€
2.  ä¸¤ä¸ªåŠå…¶ä»¥ä¸Šçš„é€»è¾‘é—¨çš„è¾“å‡ºä¸èƒ½è¿æ¥åœ¨ä¸€èµ·

    ä¸¤ä¸ªæˆ–ä»¥ä¸Šçš„é€»è¾‘é—¨å¯èƒ½å°†å¯¼çº¿é©±å‘ä¸åŒçš„ç”µå‹ï¼Œä»è€Œå¯¼è‡´æ— æ•ˆç”µå‹æˆ–è€…ç”µè·¯æ•…éšœ
3.  ç½‘ç»œå¿…é¡»æ˜¯æ— ç¯çš„

    å¦‚æœç½‘ç»œä¸­å­˜åœ¨ä¸€æ¡å›è·¯ï¼Œé‚£ä¹ˆä¼šå¼•èµ·æ‰€è¡¨ç¤ºçš„å‡½æ•°åŠŸèƒ½çš„æ­§ä¹‰

ä¸‹å›¾çš„é€»è¾‘ç”µè·¯å¯ä»¥åˆ¤æ–­ä¸¤ä¸ªä½æ˜¯å¦ç›¸ç­‰ï¼Œå…¶å¯¹åº”çš„HCLä¸º

![](image/image_-X_uX1_N-P.png)

```c
bool eq=(a&&b)||(!a&&!b)
```

> âœ¨HCLä½¿ç”¨Cé£æ ¼çš„è¯­æ³•ï¼Œé€šè¿‡â€œ=â€å°†ä¿¡å·åç§°ä¸è¡¨è¾¾å¼ç›¸å…³è”ã€‚ç„¶è€Œï¼Œä¸ C ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¹¶ä¸å°†å…¶è§†ä¸ºæ‰§è¡Œè®¡ç®—å¹¶å°†ç»“æœåˆ†é…åˆ°æŸä¸ªå†…å­˜ä½ç½®ã€‚ç›¸åï¼Œå®ƒåªæ˜¯ä¸€ç§ä¸ºè¡¨è¾¾å¼å‘½åçš„æ–¹æ³•

ä¸‹å›¾çš„é€»è¾‘ç”µè·¯å¯ä»¥å®ç°ä¸€ä½å¤šé€‰å™¨ï¼Œå…¶å¯¹åº”çš„HCLä¸º

![](image/image_V0H6IIEqTQ.png)

```c
bool out=(!s&&b)||(s&&a);
```

HCLè¡¨è¾¾å¼å’ŒCè¡¨è¾¾å¼æœ‰ç€å¾ˆæ˜æ˜¾çš„ç›¸ä¼¼ä¹‹å¤„

å®ƒä»¬éƒ½ä½¿ç”¨å¸ƒå°”è¿ç®—æ¥è®¡ç®—å…¶è¾“å…¥çš„å‡½æ•°

ä½†æ˜¯ä¹Ÿæœ‰ä¸€äº›å·®å¼‚ï¼š

1.  ç»„åˆé€»è¾‘ç”µè·¯HCLè¡¨è¾¾å¼å½“è¾“å…¥æ”¹å˜æ—¶ï¼Œè¾“å‡ºå³æ”¹å˜
    Cè¡¨è¾¾å¼åªæœ‰å½“ç¨‹åºæ‰§è¡Œåˆ°è¯¥å¤„æ—¶æ‰è¿›è¡Œè®¡ç®—è¾“å‡º
2.  Cçš„é€»è¾‘è¡¨è¾¾å¼å¯ä»¥è¡¨ç¤ºèŒƒå›´å†…çš„ä»»æ„æ•´æ•°â€”â€”å°†0è§†ä¸ºFalseï¼Œé0è§†ä¸ºTrueã€‚è€Œç»„åˆé€»è¾‘HCLåªæœ‰0å’Œ1ä¸¤ä¸ªä½å€¼
3.  å½“Cé€»è¾‘è¡¨è¾¾å¼ä¸­çš„ç¬¬ä¸€éƒ¨åˆ†å¯ä»¥è¢«è®¡ç®—æ—¶ï¼Œç¬¬äºŒéƒ¨åˆ†å³ä¸è¿›è¡Œæ‰§è¡Œã€‚è€Œç»„åˆé€»è¾‘HCLåªè¦è¾“å…¥æ”¹å˜ï¼Œè¾“å‡ºå°±ä¼šè¿›è¡Œæ”¹å˜ã€‚

    ä¾‹å¦‚$(a\&\&!a)\&\& func(b,c)$åœ¨Cä¸­å¹¶ä¸ä¼šè°ƒç”¨funcå‡½æ•°ï¼Œè€Œåœ¨HCLä¸­ï¼Œåªè¦a/b/cæœ‰æ”¹å˜å°±éƒ½ä¼šè®¡ç®—

## 4.2.3 *Word-Level Combinational Circuits and HCL Integer Expressions*

> *Combinational circuits that perform word-level computations are constructed using logic gates to compute the individual bits of the output word, based on the individual bits of the input words.*

![](image/image_E18F0t6sWW.png)

Figure4.12å±•ç¤ºäº†ä¸€ä¸ªç”¨äºåˆ¤æ–­ä¸¤ä¸ª64ä½å­—Aã€Bæ˜¯å¦ç›¸ç­‰çš„ç»„åˆé€»è¾‘ç”µè·¯

æ˜¯é€šè¿‡1ä½åˆ¤æ–­ç›¸ç­‰çš„é€»è¾‘ç”µè·¯æ¥åˆ¤æ–­64ä½å­—çš„æ¯ä¸ªä½æ˜¯å¦ç›¸ç­‰ï¼Œæœ€åå°†æ¯ä½çš„åˆ¤æ–­ç»“æœç›¸ä¸å¾—åˆ°æœ€ç»ˆçš„åˆ¤æ–­ç»“æœâ€”â€”ä¸º1è¡¨ç¤ºç›¸ç­‰ï¼Œä¸º0è¡¨ç¤ºä¸ç­‰

å…¶HCLå¦‚ä¸‹

```c
bool Eq=(A==B);
```

> âœ¨åœ¨ HCL ä¸­ï¼Œæˆ‘ä»¬å°†ä»»ä½•å­—çº§ä¿¡å·å£°æ˜ä¸º intï¼Œè€Œä¸æŒ‡å®šå­—å¤§å°
>
> åœ¨åŠŸèƒ½é½å…¨çš„HDLä¸­ï¼Œæ¯ä¸ªå­—éƒ½å¯ä»¥å£°æ˜ä¸ºå…·æœ‰ç‰¹å®šçš„ä½æ•°

![](image/image_DJd5Tw1LHI.png)

Figure4.13å±•ç¤ºäº†å­—çº§çš„å¤šè·¯é€‰æ‹©å™¨ï¼ŒåŒå­—çº§çš„æ¯”è¾ƒå™¨ä¸€æ ·ï¼Œæ˜¯å¯¹å­—çš„æ¯ä¸€ä½è¿è¡Œä¸€ä½å¤šè·¯é€‰æ‹©å™¨ï¼Œç„¶åæœ€åè¾“å‡ºç­‰åŒå­—å¤§å°çš„æ•°æ®

å…¶HCLå¦‚ä¸‹ï¼š

```c
int Out=[
  s:A;
  1:B;
]
```

> âœ¨å¤šè·¯é€‰æ‹©å™¨çš„HCLæè¿°ä½¿ç”¨caseè¡¨è¾¾å¼ï¼Œå…¶é€šç”¨çš„æ ¼å¼ä¸ºï¼š
>
> ![](image/image_ocoOMR2iu1.png)
>
> è¡¨è¾¾å¼åŒ…å«ç€ä¸€ç³»åˆ—çš„caseè¯­å¥ï¼Œæ¯ä¸€ä¸ªcase iåŒ…å«ç€ä¸€ä¸ªå¸ƒå°”è¡¨è¾¾å¼$select_i$å’Œå…¶å¯¹åº”çš„å€¼$expr_i$
>
> å’ŒCä¸­çš„switch-caseä¸åŒï¼Œä¸è¦æ±‚ä¸åŒçš„é€‰æ‹©è¡¨è¾¾å¼æ˜¯äº’æ–¥çš„ã€‚ä»é€»è¾‘ä¸Šè®²ï¼Œé€‰æ‹©è¡¨è¾¾å¼æŒ‰é¡ºåºæ±‚å€¼ï¼Œå¹¶é€‰æ‹©ç¬¬ä¸€ä¸ªäº§ç”Ÿ 1 çš„æƒ…å†µ[^æ³¨é‡Š2]ã€‚å¦‚Figure4.13çš„HCL
>
> $select_i$å¯ä»¥æ˜¯ä»»æ„çš„å¸ƒå°”è¡¨è¾¾å¼ä¹Ÿå¯ä»¥æ˜¯ä»»æ„çš„æ•´æ•°
>
> æ¯”å¦‚å››è·¯å¤šè·¯é€‰æ‹©å™¨çš„HCLä¸º
>
> ```c
> word Out4=[
>   !s1&&!s0:A;#00
>        !s1:B;#01 !S1çš„å¦ä¸€ç§æƒ…å†µå·²åœ¨ç¬¬ä¸€ä¸ªåˆ¤æ–­ï¼Œåˆ™ä¸æ»¡è¶³å³è¿›å…¥ç¬¬äºŒä¸ª
>        !s0:C;#10
>          1:D;
> ];
> ```
>
> æ¯”å¦‚ä¸‰è·¯æœ€å°çš„HCLä¸º
>
> ![](image/image_BWAVOhVdxM.png)

## 4.2.4 *Set Membership*

åœ¨å¤„ç†å™¨è®¾è®¡ä¸­ï¼Œå¾ˆå¤šæ—¶å€™éƒ½éœ€è¦å°†ä¸€ä¸ªä¿¡å·ä¸è®¸å¤šå¯èƒ½åŒ¹é…çš„ä¿¡å·ä½œæ¯”è¾ƒï¼Œä»¥æ­¤æ¥æ£€æµ‹æ­£åœ¨å¤„ç†çš„æŸä¸ªæŒ‡ä»¤ä»£ç æ˜¯å¦å±äºæŸä¸€ç±»æŒ‡ä»¤ä»£ç 

ä¾‹å¦‚ï¼Œç”Ÿæˆå››è·¯é€‰æ‹©å™¨çš„é€‰æ‹©ä¿¡å·s1ã€s0ï¼š

![](image/image_xlx91J3xmt.png)

```c
bool s1 = code == 2 || code == 3;
bool s0 = code == 1 || code == 3;
```

é‡‡ç”¨é›†åˆçš„é€šç”¨è¡¨è¾¾å½¢å¼ï¼š$iexpr \space in \left\{i \exp r_{1}, i \operatorname{expr}_{2}, \ldots, i e x p r_{k}\right\}$åˆ™å¯¹ä¸Šå¼å¯ç®€åŒ–ä¸ºï¼š

```c
bool s1 = code in { 2, 3 };
bool s0 = code in { 1, 3 };
```

## 4.2.5 *Memory and Clocking*

> *Combinational circuits, by their very nature, do not store any information. Instead, they simply react to the signals at their inputs, generating outputs equal to some function of the inputs.*\* To create **sequential circuitsâ€”that is, systems that have state and perform computations on that state**â€”we must introduce devices that store information represented as bits.\*\* Our storage devices are all controlled by a single clock, a periodic signal that determines when new values are to be loaded into the devices\*\*. We consider two classes of memory devices:\*

1.  æ—¶é’Ÿå¯„å­˜å™¨

    æ—¶é’Ÿå¯„å­˜å™¨ï¼ˆæˆ–ç®€ç§°å¯„å­˜å™¨ï¼‰å­˜å‚¨ä¸€ä¸ªä½æˆ–å­—ï¼Œé€šè¿‡æ—¶é’Ÿä¿¡å·æ§åˆ¶å¯„å­˜å™¨çš„è¾“å…¥å€¼çš„åŠ è½½
2.  éšæœºè®¿é—®å­˜å‚¨å™¨

    éšæœºå­˜å–å­˜å‚¨å™¨ï¼ˆæˆ–ç®€ç§°å­˜å‚¨å™¨ï¼‰å­˜å‚¨å¤šä¸ªå­—ï¼Œä½¿ç”¨åœ°å€æ¥é€‰æ‹©åº”è¯»å–æˆ–å†™å…¥å“ªä¸ªå­—

    éšæœºå­˜å‚¨å™¨çš„ç¤ºä¾‹åŒ…æ‹¬ï¼š
    1.  å¤„ç†å™¨çš„è™šæ‹Ÿå­˜å‚¨ç³»ç»Ÿ
    2.  å¯„å­˜å™¨æ–‡ä»¶ï¼šä½¿ç”¨å¯„å­˜å™¨æ ‡è¯†ç¬¦å……å½“åœ°å€

> âœ¨æ­£å¦‚æˆ‘ä»¬æ‰€çœ‹åˆ°çš„ï¼Œå½“è°ˆåˆ°ç¡¬ä»¶å’Œæœºå™¨è¯­è¨€ç¼–ç¨‹æ—¶ï¼Œâ€œå¯„å­˜å™¨â€ä¸€è¯çš„å«ä¹‰ç•¥æœ‰ä¸åŒ
>
> åœ¨ç¡¬ä»¶ä¸­ï¼šå¯„å­˜å™¨é€šè¿‡å…¶è¾“å…¥å’Œè¾“å‡ºçº¿ç›´æ¥è¿æ¥åˆ°ç”µè·¯çš„å…¶ä½™éƒ¨åˆ†
>
> åœ¨æœºå™¨è¯­è¨€ç¼–ç¨‹ä¸­ï¼šå¯„å­˜å™¨è¡¨ç¤ºCPUä¸­å¯å¯»å€å­—çš„ä¸€éƒ¨åˆ†é›†åˆï¼Œåœ°å€æ˜¯å¯„å­˜å™¨çš„ID
>
> å› æ­¤ä¸ºäº†é¿å…æ­§ä¹‰ï¼Œåˆ†åˆ«å°†è¿™ä¸¤ç§å¯„å­˜å™¨ç§°ä¸ºâ€œç¡¬ä»¶å¯„å­˜å™¨â€å’Œâ€œç¨‹åºå¯„å­˜å™¨â€

### ç¡¬ä»¶å¯„å­˜å™¨

![](image/image_8nO-WC4zCQ.png)

Figure4.16è¯¦ç»†ä»‹ç»äº†ç¡¬ä»¶å¯„å­˜å™¨ä»¥åŠå®ƒæ˜¯æ€ä¹ˆè¿›è¡Œå·¥ä½œçš„

1.  åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å¯„å­˜å™¨éƒ½ä¿æŒåœ¨ä¸€ä¸ªç¨³å®šçŠ¶æ€ï¼ˆå›¾ä¸­çš„xï¼‰ï¼Œäº§ç”Ÿçš„è¾“å‡ºç­‰äºå®ƒå½“å‰çŠ¶æ€
2.  åªè¦æ—¶é’Ÿä¿¡å·æ˜¯ä½ç”µå¹³çš„ï¼Œå¯„å­˜å™¨çš„è¾“å‡ºå°±ä¿æŒä¸å˜
3.  å½“æ—¶é’Ÿå˜æˆé«˜ç”µä½æ—¶ï¼Œé€šè¿‡ç»„åˆé€»è¾‘ä¼ é€’çš„è¾“å…¥ä¿¡å·yå°±åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œæˆä¸ºå¯„å­˜å™¨çš„å½“å‰ç¨³å®šçŠ¶æ€yç›´åˆ°ä¸‹ä¸€ä¸ªæ—¶é’Ÿä¸Šå‡æ²¿ï¼Œæ­¤å‰çš„ç¨³å®šæ€xæˆä¸ºå¯„å­˜å™¨çš„è¾“å‡º
4.  å¯„å­˜å™¨å¯ä»¥ä½œä¸ºç”µè·¯ä¸åŒéƒ¨åˆ†çš„ç»„åˆé€»è¾‘ä¹‹é—´çš„å±éšœâ€”â€”æ¯å½“æ¯ä¸ªæ—¶é’Ÿåˆ°è¾¾ä¸Šå‡æ²¿æ—¶ï¼Œå€¼æ‰ä¼šä»å¯„å­˜å™¨çš„è¾“å…¥ä¼ é€åˆ°è¾“å‡º

Y86-64å¤„ç†å™¨ä½¿ç”¨ç¡¬ä»¶å¯„å­˜å™¨å»å®ç°PCã€CCã€Stat

### ç¨‹åºå¯„å­˜å™¨

ä¸‹é¢çš„å›¾å±•ç¤ºäº†ä¸€ä¸ªå…¸å‹çš„å¯„å­˜å™¨æ–‡ä»¶ï¼š

![](image/image_yehYlLSqtX.png)

è¯¥å¯„å­˜å™¨å †æœ‰ä¸¤ä¸ªè¯»ç«¯å£ï¼Œåä¸º A å’Œ Bï¼Œä»¥åŠä¸€ä¸ªå†™ç«¯å£ï¼Œåä¸º Wã€‚è¿™ç§å¤šç«¯å£éšæœºå­˜å–å­˜å‚¨å™¨å…è®¸åŒæ—¶è¿›è¡Œå¤šä¸ªè¯»å’Œå†™æ“ä½œã€‚

å¯„å­˜å™¨å †ä¸æ˜¯ç»„åˆç”µè·¯ï¼Œå› ä¸ºå®ƒå…·æœ‰å†…éƒ¨å­˜å‚¨ã€‚ç„¶è€Œï¼Œåœ¨ä¹‹åçš„å®ç°ä¸­ï¼Œå¯ä»¥ä»å¯„å­˜å™¨æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œå°±å¥½åƒå®ƒæ˜¯ä¸€ä¸ªç»„åˆé€»è¾‘å—ï¼Œå…¶åœ°å€ä½œä¸ºè¾“å…¥ï¼Œæ•°æ®ä½œä¸ºè¾“å‡º

å¯„å­˜å™¨çš„è¯»ç«¯å£å¹¶ä¸éœ€è¦å—æ—¶é’Ÿä¿¡å·çš„æ§åˆ¶ï¼Œæ—¶é’Ÿä¿¡å·æ§åˆ¶çš„æ˜¯å¯„å­˜å™¨å†™â€”â€”åœ¨æ¯ä¸€æ¬¡ä¸Šå‡æ²¿å†™ç«¯å£çš„æ•°æ®valWå°±ä¼šå†™å…¥dstWåœ°å€æ‰€æ ‡è¯†çš„å¯„å­˜å™¨

> âœ¨å› ä¸ºå¯„å­˜å™¨å †æ—¢å¯ä»¥è¿›è¡Œè¯»ä¹Ÿå¯ä»¥è¿›è¡Œå†™ï¼Œé‚£ä¹ˆâ€œå½“åŒæ—¶å°è¯•å†™æˆ–è€…è¯»åŒä¸€ä¸ªå¯„å­˜å™¨æ—¶ä¼šå‡ºç°ä»€ä¹ˆå‘¢ï¼Ÿâ€ç­”æ¡ˆæ˜¯â€”â€”å¦‚æœå¯„å­˜å™¨å †ä¸­çš„æŸä¸ªå¯„å­˜å™¨åŒæ—¶è¢«è¯»å’Œå†™ï¼Œé‚£ä¹ˆéšç€æ—¶é’Ÿä¸Šå‡ï¼Œè¯»å‡ºæ¥çš„æ•°æ®æ˜¯è¢«æ–°å†™å…¥çš„æ•°æ®

### æ•°æ®å­˜å‚¨å™¨

ä¸ºäº†å­˜å‚¨ç¨‹åºæ•°æ®ï¼Œå¤„ç†å™¨å†…éƒ¨å­˜åœ¨ä¸€ä¸ªéšæœºè®¿é—®çš„å­˜å‚¨å™¨ï¼Œå…¶ç”µè·¯ç»“æ„å¦‚ä¸‹ï¼š

![](image/image_nL-d10gGYH.png)

è¯»ï¼šç»™å®šå†…å­˜å•å…ƒåœ°å€è‡³addresså¼•è„šï¼Œå¹¶è®¾ç½®writeå¼•è„šä¸ºä½ç”µå¹³ï¼Œé‚£ä¹ˆåœ¨å‡ ä¸ªå»¶è¿Ÿåï¼Œè¯¥å­˜å‚¨å•å…ƒçš„æ•°æ®å°±ä¼šåŠ è½½è‡³data\_outå¼•è„š

å†™ï¼šç»™å®šå°†è¿›è¡Œæ›´æ”¹çš„å†…å­˜å•å…ƒçš„åœ°å€è‡³addressï¼Œä»¥åŠæ–°æ•°æ®è‡³data\_inï¼Œå¹¶è®¾ç½®writeä¸ºé«˜ç”µå¹³ï¼Œé‚£ä¹ˆåœ¨æ—¶é’Ÿä¸Šå‡æ²¿ï¼Œå¦‚æœåœ°å€æœ‰æ•ˆçš„è¯ï¼Œå°±ä¼šå¯¹æŒ‡å®šå•å…ƒè¿›è¡Œæ›´æ–°

å¦‚æœç»™å®šçš„è¯»/å†™åœ°å€è¶…å‡ºäº†å¯å¯»å€çš„èŒƒå›´ï¼Œé‚£ä¹ˆä¼šè®¾ç½®error[^æ³¨é‡Š3]å¼•è„šä¸ºé«˜ç”µå¹³ï¼Œå¦åˆ™ä¸ºä½ç”µå¹³

### æŒ‡ä»¤å­˜å‚¨å™¨

ä¸ºäº†å­˜å‚¨ç¨‹åºæŒ‡ä»¤ï¼Œå¤„ç†å™¨å†…éƒ¨å­˜åœ¨ä¸€ä¸ªåªè¯»çš„å­˜å‚¨å™¨

> âœ¨åœ¨å¤§å¤šæ•°å®é™…ç³»ç»Ÿä¸­ï¼Œæ•°æ®å­˜å‚¨å™¨å’ŒæŒ‡ä»¤å­˜å‚¨å™¨è¢«åˆå¹¶æˆå…·æœ‰ä¸¤ä¸ªç«¯å£çš„å•ä¸ªå­˜å‚¨å™¨ï¼šä¸€ä¸ªç”¨äºè¯»å–æŒ‡ä»¤ï¼Œå¦ä¸€ä¸ªç”¨äºè¯»å–æˆ–å†™å…¥æ•°æ®

# 4.3 *Sequential Y86-64 Implementations*

Sequential Processorï¼ˆSEQï¼‰æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸéƒ½åšå®Œå½“å‰æŒ‡ä»¤æ‰€éœ€çš„å…¨éƒ¨æ“ä½œâ€”â€”æ—¶é’Ÿå‘¨æœŸé•¿åº¦ä¸ºæœ€å¤æ‚çš„æŒ‡ä»¤å®Œæˆæ‰€éœ€è¦çš„æ—¶é—´

## 4.3.1 *Organizing Processing into Stages*

### æŒ‡ä»¤æ‰§è¡Œé˜¶æ®µåºåˆ—

ä¸€èˆ¬æ¥è¯´ï¼Œå¤„ç†ä¸€æ¡æŒ‡ä»¤æ¶‰åŠè®¸å¤šæ“ä½œã€‚æˆ‘ä»¬æŒ‰ç…§ç‰¹å®šçš„é˜¶æ®µé¡ºåºç»„ç»‡å®ƒä»¬ï¼Œè¯•å›¾ä½¿æ‰€æœ‰æŒ‡ä»¤éµå¾ªç»Ÿä¸€çš„é¡ºåºï¼š

1.  å–æŒ‡
    > âœ¨å–æŒ‡é˜¶æ®µä¼šä»å†…å­˜ä¸­è¯»å–PCå€¼ä¸ºåœ°å€çš„å†…å­˜å•å…ƒå¤„çš„æŒ‡ä»¤ï¼›ä»æŒ‡ä»¤è¯´æ˜ç¬¦ä¸­æå–çš„ä¸¤éƒ¨åˆ†icodeã€ifunåˆ†åˆ«è¡¨ç¤ºæŒ‡ä»¤çš„ç±»å‹ä»¥åŠåšä»€ä¹ˆæ ·çš„è¿ç®—ã€‚æ­¤å¤–æŒ‡ä»¤ä¸­å¯èƒ½ä¼šæœ‰å¯„å­˜å™¨æ“ä½œæ•°ä½rAã€rBï¼Œä¹Ÿå¯èƒ½ä¼šæœ‰8å­—èŠ‚çš„å¸¸é‡valCã€‚å–æŒ‡é˜¶æ®µè¿˜éœ€è¦è®¡ç®—ä¸‹ä¸€æ¡é¡ºåºæ‰§è¡ŒæŒ‡ä»¤çš„åœ°å€â€”â€”å½“å‰åœ°å€+å½“å‰æŒ‡ä»¤é•¿åº¦
    1.  å–å‡ºicodeã€ifunc
    2.  å–å‡ºå¯èƒ½æœ‰çš„å¯„å­˜å™¨æŒ‡ç¤ºç¬¦rAã€rB
    3.  å–å‡ºå¯èƒ½æœ‰çš„8å­—èŠ‚ç«‹å³æ•°
    4.  è®¡ç®—é¡ºåºæ‰§è¡Œçš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€
2.  è¯‘ç 
    > âœ¨æ ¹æ®æŒ‡ä»¤çš„rAã€rBå­—æ®µï¼Œä»å¯„å­˜å™¨æ–‡ä»¶ä¸­å–å¾—å¯¹åº”çš„valAã€valBï¼›æ­¤å¤–è¿˜æœ‰äº›æŒ‡ä»¤æ˜¯è¯»å–%rspçš„
3.  æ‰§è¡Œ

    åœ¨æ‰§è¡Œé˜¶æ®µï¼Œç®—æœ¯/é€»è¾‘å•å…ƒï¼ˆALUï¼‰è¦ä¹ˆæ‰§è¡ŒæŒ‡ä»¤æŒ‡å®šçš„æ“ä½œï¼ˆæ ¹æ®ifunçš„å€¼ï¼‰[^æ³¨é‡Š4]ï¼Œè¦ä¹ˆè®¡ç®—å†…å­˜å¼•ç”¨çš„æœ‰æ•ˆåœ°å€ï¼Œè¦ä¹ˆé€’å¢æˆ–é€’å‡å †æ ˆæŒ‡é’ˆï¼Œè®¡ç®—ç»“æœä¸ºvalEï¼Œå¯èƒ½ä¼šæ ¹æ®ç»“æœä½è®¾ç½®æ¡ä»¶ç 

    å¯¹äºæ¡ä»¶ä¼ é€æŒ‡ä»¤ï¼Œè¯¥é˜¶æ®µå°†è¯„ä¼°æ¡ä»¶ä»£ç å’Œç§»åŠ¨æ¡ä»¶ï¼ˆç”± ifun ç»™å‡ºï¼‰ã€‚ç±»ä¼¼åœ°ï¼Œå¯¹äºè·³è½¬æŒ‡ä»¤ï¼Œå®ƒå†³å®šæ˜¯å¦åº”è¯¥é‡‡å–åˆ†æ”¯
4.  è®¿å­˜

    è®¿å­˜é˜¶æ®µå¯ä»¥å°†æ•°æ®å†™å…¥å­˜å‚¨å™¨ï¼Œä¹Ÿå¯ä»¥ä»å­˜å‚¨å™¨è¯»å–æ•°æ®ã€‚å°†è¯»å–çš„å€¼ç§°ä¸º valM
5.  å†™å›ï¼šæœ€å¤šå¯ä»¥å†™ä¸¤ä¸ªç»“æœåˆ°å¯„å­˜å™¨æ–‡ä»¶â€”â€”ç›®çš„å¯„å­˜å™¨+%rsp
6.  æ›´æ–°PCï¼šPCè¢«è®¾ç½®ä¸ºä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€

### è®¾è®¡åŸåˆ™

> \*The processor loops indefinitely, performing these stages. In our simplified implementation, the processor will stop when any exception occursâ€”that is, \*\*when it executes a halt or invalid instruction, or it attempts to read or write an invalid address. \**In a more complete design, the processor would enter an exception-handling mode and begin executing special code determined by the type of exception*

åœ¨è¿›è¡Œç¡¬ä»¶è®¾è®¡æ—¶ï¼Œä½¿ç”¨éå¸¸ç®€å•ä¸”ç»Ÿä¸€çš„ç»“æ„éå¸¸é‡è¦ï¼Œå› ä¸ºæˆ‘ä»¬å¸Œæœ›æœ€å¤§é™åº¦åœ°å‡å°‘ç¡¬ä»¶æ€»é‡ï¼Œå¹¶ä¸”æœ€ç»ˆå¿…é¡»å°†å…¶æ˜ å°„åˆ°é›†æˆç”µè·¯èŠ¯ç‰‡çš„äºŒç»´è¡¨é¢ä¸Šâ€”â€”ä¸€ä¸ªé™ä½ç¡¬ä»¶å¤æ‚åº¦çš„æ–¹æ³•æ˜¯**è®©ä¸åŒçš„æŒ‡ä»¤å°½å¯èƒ½å¤šçš„å¤ç”¨ç¡¬ä»¶**[^æ³¨é‡Š5]

è¿™ä¸ªç®€å•ä¸”ç»Ÿä¸€çš„ç»“æ„å³æ˜¯ä¸Šè¿°æå‡ºçš„6é˜¶æ®µçš„æŒ‡ä»¤æ‰§è¡Œé˜¶æ®µåºåˆ—ï¼Œæ¥ä¸‹æ¥è¦åšçš„å³æ˜¯**å°†Y86-64æŒ‡ä»¤é›†ä¸­çš„æ¯æ¡ä¸åŒçš„æŒ‡ä»¤æ‰€éœ€è¦çš„è®¡ç®—æ”¾å…¥è¿™ä¸ªé€šç”¨æ¡†æ¶**

### Y86-64æŒ‡ä»¤é›†é€šç”¨æ¡†æ¶

#### OPq rA,rB

1.  å–æŒ‡ï¼šå–icodeã€ifuncã€å¯èƒ½æœ‰çš„å¯„å­˜å™¨æŒ‡ç¤ºç¬¦ã€8å­—èŠ‚ç«‹å³æ•°å¹¶è®¡ç®—é¡ºåºæ‰§è¡Œçš„ä¸‹ä¸€æ¡PCåœ°å€
    $$
    icode:ifunc\leftarrow M_1[PC] \\
    rA:rB \leftarrow M1[PC+1] \\
    valP\leftarrow PC+2 
    $$
2.  è¯‘ç ï¼šå–å¯„å­˜å™¨æ“ä½œæ•°
    $$
    valA\leftarrow Reg[rA]\\
    valB\leftarrow Reg[rB] 
    $$
3.  æ‰§è¡Œï¼šæ ¹æ®ifuncè®¡ç®—ç»“æœ
    $$
    valE\leftarrow valB \space OP \space valA \\
    Set \space CC 
    $$
4.  è®¿å­˜

    OPqæŒ‡ä»¤ä¸éœ€è¦è®¿å­˜
5.  å†™å›
    $$
    Reg[rB]\leftarrow valE
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP
    $$

#### rrmovq rA,rB

1.  å–æŒ‡ï¼šå–icodeã€ifuncã€å¯èƒ½æœ‰çš„å¯„å­˜å™¨æŒ‡ç¤ºç¬¦ã€8å­—èŠ‚ç«‹å³æ•°å¹¶è®¡ç®—é¡ºåºæ‰§è¡Œçš„ä¸‹ä¸€æ¡PCåœ°å€
    $$
    icode:ifunc\leftarrow M_1[PC] \\
    rA:rB \leftarrow M1[PC+1] \\
    valP\leftarrow PC+2 
    $$
2.  è¯‘ç ï¼šå–å¯„å­˜å™¨æ“ä½œæ•°
    $$
    valA\leftarrow Reg[rA]
    $$
    åªéœ€è¦å–æ“ä½œæ•°rA
3.  æ‰§è¡Œï¼šæ ¹æ®ifuncè®¡ç®—ç»“æœ
    $$
    valE\leftarrow 0+valA 
    $$
    è¿™ä¸€æ­¥æ˜¯å¤šä½™çš„redudantï¼Œåªæ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªé€šç”¨çš„å¤„ç†æ–¹å¼
4.  è®¿å­˜

    OPqæŒ‡ä»¤ä¸éœ€è¦è®¿å­˜
5.  å†™å›
    $$
    Reg[rB]\leftarrow valE
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP
    $$

#### irmovq V,rB

1.  å–æŒ‡ï¼šå–icodeã€ifuncã€å¯èƒ½æœ‰çš„å¯„å­˜å™¨æŒ‡ç¤ºç¬¦ã€8å­—èŠ‚ç«‹å³æ•°å¹¶è®¡ç®—é¡ºåºæ‰§è¡Œçš„ä¸‹ä¸€æ¡PCåœ°å€
    $$
    icode:ifunc\leftarrow M_1[PC] \\
    rA:rB \leftarrow M1[PC+1] \space rAæ˜¯F\\
    valC\leftarrow M_8[PC+2]\\

    valP\leftarrow PC+10 
    $$
2.  è¯‘ç ï¼šå–å¯„å­˜å™¨æ“ä½œæ•°

    irmovqæŒ‡ä»¤ä¸éœ€è¦å–å¯„å­˜å™¨æ“ä½œæ•°
3.  æ‰§è¡Œï¼šæ ¹æ®ifuncè®¡ç®—ç»“æœ
    $$
    valE\leftarrow 0+valC
    $$
4.  è®¿å­˜

    OPqæŒ‡ä»¤ä¸éœ€è¦è®¿å­˜
5.  å†™å›
    $$
    Reg[rB]\leftarrow valE
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP
    $$

#### rmmovq rA,D(rB)

1.  å–æŒ‡
    $$
    icode,ifunc\leftarrow M_1[PC] \\
    rA,rB\leftarrow M_1[PC+1] \\
    valC\leftarrow M_8[PC+2] \\
    valP\leftarrow PC+10 
    $$
2.  è¯‘ç 
    $$
    valA\leftarrow Reg[rA]\\
    valB\leftarrow Reg[rB] 
    $$
3.  æ‰§è¡Œ
    $$
    valE=valB+valC
    $$
4.  è®¿å­˜
    $$
    Mem_8[valE]\leftarrow valA
     
    $$
5.  å†™å›

    æ— 
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP
    $$

#### mrmovq D(rB),rA

1.  å–æŒ‡
    $$
    icode,ifunc\leftarrow M_1[PC] \\
    rA,rB\leftarrow M_1[PC+1] \\
    valC\leftarrow M_8[PC+2] \\
    valP\leftarrow PC+10 
    $$
2.  è¯‘ç 
    $$
    valB\leftarrow Reg[rB] 
    $$
3.  æ‰§è¡Œ
    $$
    valE=valB+valC
    $$
4.  è®¿å­˜
    $$
    valM\leftarrow Mem_8[valE]
     
    $$
5.  å†™å›
    $$
    R[rA]\leftarrow valM
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP
    $$

#### pushq rA

1.  å–æŒ‡
    $$
    icode:ifunc \leftarrow M_1[PC] \\
    rA:rB\leftarrow M_1[PC+1]\\
    valP\leftarrow PC+2
     
    $$
2.  è¯‘ç 
    $$
    valA\leftarrow Reg[rA]\\
    valB\leftarrow Reg[\%rsp] 
    $$
3.  æ‰§è¡Œ
    $$
    valE=valB+(-8)
    $$
4.  è®¿å­˜
    $$
    Mem_8[valE]\leftarrow valA
    $$
5.  å†™å›
    $$
    Reg[\%rsp] \leftarrow valE \\
     
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP 
    $$

#### popq rA

1.  å–æŒ‡
    $$
    icode:ifunc \leftarrow M_1[PC] \\
    rA:rB\leftarrow M_1[PC+1]\\
    valP\leftarrow PC+2
     
    $$
2.  è¯‘ç 
    $$
    valA\leftarrow Reg[\%rsp]\\
    valB\leftarrow Reg[\%rsp] 
    $$
    è¿™é‡Œå–ä¸¤æ¬¡%rspçš„å€¼ä¹Ÿæ˜¯å¤šä½™çš„ï¼Œåªæ˜¯ä¸ºäº†è®©popqåç»­çš„å¤„ç†ä¸ä¹‹å‰æŒ‡ä»¤çš„å¤„ç†é€»è¾‘ç›¸ç±»ä¼¼
3.  æ‰§è¡Œ
    $$
    valE=valB+8
    $$
4.  è®¿å­˜
    $$
    valM\leftarrow Mem_8[valA]
    $$
5.  å†™å›
    $$
    Reg[\%rsp] \leftarrow valE \\

    Reg[rA]\leftarrow valM 
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP 
    $$

> âœ¨pushqå’Œpopqçš„å¤„ç†é€»è¾‘ä¹Ÿè¡¨æ˜äº†
>
> pushq %rspæ˜¯å­˜%rspçš„æ—§å€¼å…¥æ ˆã€popq %rspæ˜¯%rspä¸­çš„æ˜¯æ ˆä¸­çš„å€¼
>
> 4.1.5\* Some Y86-64 Instruction Details\*

#### jXX Dest

1.  å–æŒ‡
    $$
    icode:ifunc\leftarrow Mem_1[PC]\\
    valC\leftarrow Mem_8[PC+1]\\
    valP\leftarrow PC+9 
    $$
2.  è¯‘ç 

    `jXX Dest`æŒ‡ä»¤ä¸éœ€è¦è¯»å¯„å­˜å™¨ï¼Œå› æ­¤ä¸éœ€è¦è¯‘ç 
3.  æ‰§è¡Œ

    æœ‰æ¡ä»¶è·³è½¬æŒ‡ä»¤æ‰§è¡Œé˜¶æ®µéœ€è¦åˆ¤æ–­è·³è½¬æ¡ä»¶æ˜¯å¦æ»¡è¶³

    æ— æ¡ä»¶è·³è½¬çš„Cndå§‹ç»ˆä¸º1
    $$
    Cnd\leftarrow Cond(CC,ifunc)
    $$
4.  è®¿å­˜

    `JXX Dest`æŒ‡ä»¤ä¸éœ€è¦è®¿å­˜
5.  å†™å›

    `jXX Dest`æŒ‡ä»¤ä¸éœ€è¦å†™å¯„å­˜å™¨
6.  æ›´æ–°PC
    $$
    PC\leftarrow Cnd?valC:valP
    $$

#### call Dest

> âœ¨call DestæŒ‡ä»¤ç›¸å½“äº push ä¸‹ä¸€æ¡åœ°å€;j Dest

1.  å–æŒ‡
    $$
    icode:ifunc\leftarrow Mem_1[PC]\\
    valC\leftarrow Mem_8[PC+1]\\
    valP\leftarrow PC+9 
    $$
2.  è¯‘ç 

    callæŒ‡ä»¤éœ€è¦è°ƒç”¨æ ˆæ¥ä¿å­˜è¿”å›åœ°å€ï¼Œå› æ­¤éœ€è¦è¯»å–æ ˆé¡¶å¯„å­˜å™¨çš„å€¼
    $$
    valB\leftarrow R[\%rsp]
    $$
3.  æ‰§è¡Œ

    å¯¹æ ˆé¡¶å¯„å­˜å™¨çš„å€¼è¿›è¡Œå‡æ ˆ
    $$
    valE\leftarrow valB+(-8)
    $$
4.  è®¿å­˜

    å†™ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å…¥æ ˆ
    $$
    Mem_8[valE]\leftarrow valP
    $$
5.  å†™å›

    æ›´æ–°%rsp
    $$
    Reg[\%rsp]\leftarrow valE
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valC
     
    $$

#### ret

> âœ¨retæŒ‡ä»¤ç›¸å½“äº popq rA ;j rA

1.  å–æŒ‡
    $$
    icode:ifunc\leftarrow M_1[PC]\\
    valP\leftarrow PC+1 
    $$
2.  è¯‘ç 

    retæŒ‡ä»¤éœ€è¦popqï¼Œå› æ­¤éœ€è¦è¯»å–ä¸¤æ¬¡%rspçš„å€¼
    $$
    valA\leftarrow Reg[\%rsp]\\
    valB\leftarrow Reg[\%rsp] 
    $$
3.  æ‰§è¡Œ

    å¯¹æ ˆé¡¶å¯„å­˜å™¨æ“ä½œ
    $$
    valE=valB+8
    $$
4.  è®¿å­˜
    $$
    valM\leftarrow Mem_8[valA]
    $$
5.  å†™å›
    $$
    R[\%rsp]\leftarrow valE
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valM 
    $$

> âœ¨ä¸€èˆ¬éƒ½æ˜¯valBå‚ä¸ALUè¿ç®—ï¼ŒvalAä½œèµ‹å€¼æˆ–è€…å†…å­˜å¼•ç”¨

#### cmovq

rrmovq rA,rBæ˜¯cmovqçš„æ— æ¡ä»¶ç‰ˆæœ¬ï¼Œå¯ä»¥ä¿®æ”¹rrmovqçš„é€šç”¨æ ¼å¼å¦‚ä¸‹ï¼Œå³å¯å®ç°cmovqçš„æ‰§è¡Œæ ¼å¼ï¼š

1.  å–æŒ‡ï¼šå–icodeã€ifuncã€å¯èƒ½æœ‰çš„å¯„å­˜å™¨æŒ‡ç¤ºç¬¦ã€8å­—èŠ‚ç«‹å³æ•°å¹¶è®¡ç®—é¡ºåºæ‰§è¡Œçš„ä¸‹ä¸€æ¡PCåœ°å€
    $$
    icode:ifunc\leftarrow M_1[PC] \\
    rA:rB \leftarrow M1[PC+1] \\
    valP\leftarrow PC+2 
    $$
2.  è¯‘ç ï¼šå–å¯„å­˜å™¨æ“ä½œæ•°
    $$
    valA\leftarrow Reg[rA]\\
    valB\leftarrow Reg[rB] 
    $$
    åªéœ€è¦å–æ“ä½œæ•°rA
3.  æ‰§è¡Œï¼šæ ¹æ®ifuncè®¡ç®—ç»“æœ
    $$
    valE\leftarrow 0+valA \\
    Cnd\leftarrow Cond(CC,ifunc) 
    $$
    è¿™ä¸€æ­¥æ˜¯å¤šä½™çš„redudantï¼Œåªæ˜¯ä¸ºäº†å®ç°ä¸€ä¸ªé€šç”¨çš„å¤„ç†æ–¹å¼
4.  è®¿å­˜

    OPqæŒ‡ä»¤ä¸éœ€è¦è®¿å­˜
5.  å†™å›
    $$
    Reg[rB]\leftarrow Cnd?valE:valB
    $$
6.  æ›´æ–°PC
    $$
    PC\leftarrow valP
    $$

## 4.3.2 SEQ Hardware Structure

4.3.1ä¸­å·²ç»ä»‹ç»äº†Y86-64 SEQçš„æŒ‡ä»¤çš„é€šç”¨å¤„ç†ç»“æ„ï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡æ˜¯åˆ›å»ºç¡¬ä»¶è®¾è®¡æ¥å®ç°ç»“æ„ä¸­çš„6ä¸ªé˜¶æ®µï¼Œå¹¶å°†å®ƒä»¬è¿æ¥èµ·æ¥

### å„é˜¶æ®µå¯¹åº”çš„ç¡¬ä»¶å•å…ƒ

å„ä¸ªé˜¶æ®µæ‰€æ¶‰åŠåˆ°çš„ç¡¬ä»¶å•å…ƒä¸ºï¼š

1.  å–æŒ‡ï¼šç¨‹åºè®¡æ•°å™¨PCã€æŒ‡ä»¤å¯„å­˜å™¨insMemå’ŒPCå¢é‡å™¨
2.  è¯‘ç ï¼šä¸¤ä¸ªè¯»ç«¯å£ã€ä¸¤ä¸ªå†™ç«¯å£çš„å¯„å­˜å™¨æ–‡ä»¶
3.  æ‰§è¡Œï¼šç®—æœ¯é€»è¾‘å•å…ƒALUå’Œæ¡ä»¶ç å¯„å­˜å™¨CC

    ç®—æœ¯é€»è¾‘å•å…ƒçš„ä½œç”¨ï¼š
    1.  å¯¹æ“ä½œæ•°æ‰§è¡Œç®—æœ¯é€»è¾‘è¿ç®—
    2.  å¯¹æ ˆæŒ‡é’ˆ%rspè¿›è¡Œå¢å‡
    3.  åŠ 0å®ç°èµ‹å€¼mov
    4.  è®¡ç®—æœ‰æ•ˆåœ°å€
        æ¡ä»¶ç å¯„å­˜å™¨åªæœ‰3ä½
4.  è®¿å­˜ï¼šæ•°æ®å­˜å‚¨å™¨dataMem
5.  å†™å›ï¼šè¯‘ç é˜¶æ®µçš„å¯„å­˜å™¨æ–‡ä»¶ï¼ŒEç«¯å£å†™valEã€Mç«¯å£å†™valM
6.  æ›´æ–°PCï¼šæ ¹æ®valPã€valCã€valMæ›´æ–°

    valPæ˜¯é¡ºåºæ‰§è¡Œæˆ–è€…æ¡ä»¶è½¬ç§»ä¸æ»¡è¶³çš„æƒ…å†µ

    valCæ˜¯æ— æ¡ä»¶è·³è½¬ã€ä»¥åŠæ¡ä»¶è½¬ç§»æ»¡è¶³çš„æƒ…å†µ

    valMæ˜¯è¿”å›åœ°å€

å…¶å¯¹åº”çš„SEQæŠ½è±¡è§†å›¾å¦‚ä¸‹ï¼š

![](image/image_lcNtW7aTfd.png)

### ç¡¬ä»¶å›¾çš„ç”»å›¾æƒ¯ä¾‹

1.  é‡‡ç”¨è‡ªä¸‹è€Œä¸Šç”»å¤„ç†å™¨å’Œæµç¨‹çš„æ–¹æ³•

    è‡ªä¸‹è€Œä¸Šçš„ç”»æ³•æ˜¯ä¸ºäº†æŒ‡ä»¤ä»ä¸‹åˆ°ä¸ŠæµåŠ¨

    [ğŸ–¼ï¸ å›¾ç‰‡](image/image_vBjlSNM_F2.png "ğŸ–¼ï¸ å›¾ç‰‡")çš„ç¬¬äº”å‘¨æœŸçš„æ‰©å±•å›¾å³ç¬¦åˆè¿™ç§è‡ªä¸‹è€Œä¸Šçš„ç”»æ³•ï¼šå–æŒ‡åœ¨æœ€åº•éƒ¨ï¼Œå†™å›åœ¨é¡¶éƒ¨

    ä¸”ç”±äºæ­£å¸¸çš„ç¨‹åºæµç¨‹æ˜¯ä»æŒ‡ä»¤åºåˆ—çš„é¡¶éƒ¨åˆ°åº•éƒ¨ï¼Œå› æ­¤æˆ‘ä»¬é€šè¿‡è®©æµæ°´çº¿ä»åº•éƒ¨åˆ°é¡¶éƒ¨æ¥ä¿ç•™è¿™ç§é¡ºåº
2.  ç¡¬ä»¶å¯„å­˜å™¨ç”¨ç™½è‰²æ–¹æ¡†è¡¨ç¤ºâ€”â€”SEQä¸­å”¯ä¸€çš„ç¡¬ä»¶å¯„å­˜å™¨ä¸ºPC
3.  ç¡¬ä»¶å•å…ƒç”¨æµ…è“è‰²æ–¹æ¡†è¡¨ç¤ºâ€”â€”å¦‚å­˜å‚¨å™¨ã€ALUç­‰

    è¿™äº›ç¡¬ä»¶å•å…ƒè§†ä¸ºâ€œé»‘ç›’â€ï¼Œä¸ç”¨å…³å¿ƒå†…éƒ¨å®ç°ç»†èŠ‚
4.  æ§åˆ¶é€»è¾‘å—ç”¨ç°è‰²åœ†è§’çŸ©å½¢è¡¨ç¤º
5.  çº¿è·¯çš„åç§°åœ¨ç™½è‰²åœ†åœˆä¸­è¯´æ˜ï¼Œåªæ˜¯ä¸€ä¸ªè¯´æ˜æ ‡è¯†
6.  å®½åº¦ä¸ºå­—é•¿çš„æ•°æ®è¿æ¥ç”¨ä¸­ç­‰ç²—åº¦çš„çº¿è¡¨ç¤º
    å®½åº¦ä¸ºå­—èŠ‚æˆ–æ›´çª„çš„æ•°æ®è¿æ¥ç”¨ç»†çº¿è¡¨ç¤º
    å®½åº¦ä¸ºä½çš„æ•°æ®è¿æ¥ç”¨è™šçº¿è¡¨ç¤º

### SEQè¯¦ç»†ç¡¬ä»¶å›¾

![](image/image_b9UsDkjgiD.png)

## 4.3.3 SEQ Timing

åœ¨4.3.1ä¸­å¯¹å„ç±»å‹æŒ‡ä»¤çš„åˆ†æä¸­ï¼Œæ˜¯å°†å®ƒä»¬çœ‹æˆæ˜¯ç”¨ç¨‹åºç¬¦å·å†™çš„ï¼Œèµ‹å€¼æ˜¯ä»ä¸Šåˆ°ä¸‹é¡ºåºæ‰§è¡Œçš„ã€‚ç„¶åç¡¬ä»¶ç»“æ„çš„æ“ä½œè¿è¡Œæ ¹æœ¬å®Œå…¨ä¸åŒï¼Œä¸€ä¸ªæ—¶é’Ÿçš„å˜åŒ–ä¼šå¼•å‘ä¸€ä¸ªç»è¿‡ç»„åˆé€»è¾‘çš„æµï¼Œæ¥æ‰§è¡Œæ•´ä¸ªæŒ‡ä»¤ã€‚

SEQçš„å®ç°åŒ…æ‹¬ç»„åˆé€»è¾‘å’Œä¸¤ç§å­˜å‚¨å™¨è®¾å¤‡ï¼ˆå¦‚PCã€CCè¿™æ ·çš„æ—¶é’Ÿå¯„å­˜å™¨ï¼Œå¦‚å¯„å­˜å™¨æ–‡ä»¶ã€insMemã€dataMemè¿™æ ·çš„éšæœºè®¿é—®å­˜å‚¨å™¨ï¼‰

ç»„åˆé€»è¾‘ä»¥åŠéšæœºè®¿é—®å­˜å‚¨å™¨çš„è¯»å¹¶ä¸éœ€è¦æ—¶é’Ÿä¿¡å·çš„æ§åˆ¶â€”â€”åªè¦è¾“å…¥å˜åŒ–äº†ï¼Œå€¼å°±ä¼šé€šè¿‡é€»è¾‘é—¨ç½‘ç»œä¼ æ’­

è€ŒPCã€CCè¿™æ ·çš„æ—¶é’Ÿå¯„å­˜å™¨ï¼Œä»¥åŠéšæœºè®¿é—®å­˜å‚¨å™¨çš„å†™æ“ä½œåˆ™éœ€è¦é€šè¿‡ä¸€ä¸ªæ—¶é’Ÿä¿¡å·æ¥æ§åˆ¶

ä¸ºäº†ç¡®ä¿ç¡¬ä»¶ç»“æ„çš„æ“ä½œæŒ‰ç…§4.3.1ä¸­å„ç±»å‹æŒ‡ä»¤çš„é¡ºåºæ‰§è¡Œï¼Œéœ€è¦å¼•å…¥æ—¶é’Ÿæ§åˆ¶æœºåˆ¶ä»¥åŒæ­¥å¤„ç†å™¨å†…æ—¶é’Ÿå¯„å­˜å™¨å’Œå†™å†…å­˜çš„æ“ä½œæ—¶åºã€‚è¿™æ ·ï¼Œå°½ç®¡æ‰€æœ‰çŠ¶æ€çš„æ›´æ–°åœ¨æ—¶é’Ÿä¸Šå‡å¼€å§‹ä¸‹ä¸€ä¸ªå‘¨æœŸæ—¶å®é™…ä¸Šæ˜¯åŒæ—¶å‘ç”Ÿçš„ï¼Œä½†æˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿå®ç°ç±»ä¼¼äº4.3.1ä¸­æŒ‡ä»¤é¡ºåºæ‰§è¡Œçš„æ•ˆæœã€‚

> âœ¨ä¹‹æ‰€ä»¥å¼•å…¥æ—¶é’Ÿæ§åˆ¶æœºåˆ¶ä½¿å¾—ç¡¬ä»¶ç»“æ„æ“ä½œå’ŒæŒ‡ä»¤é€»è¾‘æ“ä½œæ•ˆæœä¸€è‡´çš„åŸå› æ˜¯ï¼šY86-64æœ¬è´¨ä¸Šçš„`ä»ä¸å›è¯»`åŸåˆ™ï¼Œå³å¤„ç†å™¨ä»æ¥ä¸éœ€è¦ä¸ºäº†å®Œæˆä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œè€Œå»è¯»ç”±è¯¥æ¡æŒ‡ä»¤æ›´æ–°äº†çš„çŠ¶æ€

> ä¹Ÿå› ä¸ºâ€œä»ä¸å›è¯»â€çš„åŸåˆ™ï¼Œ\*some instructions (the integer operations) set the condition codes, and some instructions (the conditional move and jump instructions) read these condition codes, but \**no instruction must both set and then read the condition codes*.

## 4.3.4 *SEQ Stage Implementations*

### å–æŒ‡é˜¶æ®µ

![](image/image_Hz55Ls0u23.png)

å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå–æŒ‡é˜¶æ®µåŒ…æ‹¬æŒ‡ä»¤å­˜å‚¨å™¨ã€åˆ†å‰²ä»¥åŠå¯¹é½å’ŒPCå¢é‡å™¨è¿™ä¸‰ç§ç»„åˆé€»è¾‘ç»„ä»¶ã€ä»¥åŠæ—¶é’Ÿå¯„å­˜å™¨PCå¯„å­˜å™¨å’Œä¸€äº›æ§åˆ¶é€»è¾‘

åœ¨å–æŒ‡é˜¶æ®µä¼šæ ¹æ®PCæŒ‡å®šçš„æŒ‡ä»¤å­˜å‚¨å™¨åœ°å€å¼€å§‹å–å‡º10ä¸ªå­—èŠ‚

å…¶ä¸­ç¬¬ä¸€ä¸ªå­—èŠ‚`Byte 0`è¢«Splitéƒ¨ä»¶åˆ†å‰²æˆä¸¤ä¸ª4ä½çš„æ§åˆ¶é€»è¾‘â€”â€”icodeå’Œifunã€‚å½“æŒ‡ä»¤åœ°å€æ— æ•ˆæ—¶ï¼Œå³å‡ºç°imem\_error[^æ³¨é‡Š6]ä¿¡å·æ—¶ï¼Œå½“å‰æŒ‡ä»¤çš„icodeå’Œifunä¸ºnopæŒ‡ä»¤çš„Byte 0ï¼›å¦åˆ™ä¸ºå†…å­˜ä¸­çš„Byte 0

å‰©ä½™çš„9ä¸ªå­—èŠ‚ä¼šç»è¿‡`Align`éƒ¨ä»¶çš„å¤„ç†ï¼Œå°†å…¶åˆ†å‰²æˆå¯„å­˜å™¨æŒ‡ç¤ºç¬¦å’Œå¸¸é‡å­—

å¦‚æœneed\_regidsæœ‰æ•ˆï¼Œåˆ™ä¼šè®¾ç½®Byte1ä¸ºå¯„å­˜å™¨æŒ‡ç¤ºç¬¦ï¼Œå¹¶å°†å…¶åˆ†å‰²æˆä¸¤ä¸ª4ä½çš„rAã€rBï¼›å¦‚æœneed\_regidsæ— æ•ˆï¼Œåˆ™ä¼šè®¾ç½®rAã€rBå‡ä¸º0xF

Alignéƒ¨ä»¶ä¼šæ ¹æ®need\_regidsçš„æœ‰æ•ˆä¸å¦ï¼Œè®¾ç½®valCä¸ºByte2\~Byte9æˆ–è€…Byte1\~Byte8

æ ¹æ®icodeçš„å€¼ï¼Œå¯ä»¥è®¡ç®—å‡ºä¸‰ä¸ª1ä½çš„æ§åˆ¶é€»è¾‘instr\_validã€need\_valCã€need\_regids

instr\_valid[^æ³¨é‡Š7]è¡¨ç¤ºå½“å‰æŒ‡ä»¤æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„Y86-64æŒ‡ä»¤é›†æŒ‡ä»¤

need\_valCè¡¨ç¤ºå½“å‰æŒ‡ä»¤ä¸­åŒ…å«ä¸€ä¸ªå¸¸é‡å­—Byte1\~Byte9æˆ–è€…Byte2\~Byte9

```c++
//éœ€è¦å¸¸æ•°å­—çš„æŒ‡ä»¤æœ‰irmovqã€rmmovqã€mrmovq
bool need_valC = icode in {IIRMOVQ,IRMMOVQ,IMRMOVQ,IJXX,ICALL};

```

need\_regidsè¡¨ç¤ºå½“å‰æŒ‡ä»¤ä¸­åŒ…å«å¯„å­˜å™¨æŒ‡ç¤ºç¬¦å­—èŠ‚Byte1

```c++
//éœ€è¦å¯„å­˜å™¨çš„æŒ‡ä»¤æœ‰opqã€rrmovqã€irmovqã€rmmovqã€mrmovqã€cmovXXã€pushqã€popq
bool need_regids = icode in { IRRMOVQ, IOPQ, IPUSHQ, IPOPQ, IIRMOVQ, IRMMOVQ, IMRMOVQ };

```

PCå¢é‡è®¡ç®—éƒ¨ä»¶ä¼šæ ¹æ®PCå€¼ä»¥åŠneed\_regidsã€need\_valCä¿¡å·æ¥äº§ç”ŸvalP

$$
valP=PC+1+need\_regids+need\_valC\times 8
$$

### è¯‘ç ã€å†™å›é˜¶æ®µ

![](image/image_Mw3rcItt0S.png)

è¯‘ç é˜¶æ®µå’Œå†™å›é˜¶æ®µå‡éœ€è¦ä½¿ç”¨å¯„å­˜å™¨æ–‡ä»¶ï¼Œå› æ­¤ä¸€èµ·è®¨è®º

å¯„å­˜å™¨æ–‡ä»¶å…±æœ‰8ä¸ªå¼•è„šï¼Œå¯åˆ†ä¸º4ç§ç«¯å£â€”â€”ä¸¤ä¸ªåŒæ—¶è¯»ä¸¤ä¸ªåŒæ—¶å†™ã€‚æ¯ç§ç«¯å£éƒ½ä¼šæœ‰æ•°æ®è¿æ¥å¼•è„šå’Œåœ°å€è¿æ¥å¼•è„šã€‚å…¶ä¸­åœ°å€è¿æ¥å¼•è„šå³ä¸ºå¯„å­˜å™¨çš„IDã€æ•°æ®è¿æ¥å¼•è„šä¸º64ä½æ•°æ®

ä¸¤ä¸ªè¯»ç«¯å£ï¼šAå’ŒBã€‚åœ°å€å¼•è„šæ˜¯srcAã€srcBï¼›è¾“å‡ºæ•°æ®å¼•è„šæ˜¯valAã€valB

ä¸¤ä¸ªå†™ç«¯å£ï¼šEå’ŒMã€‚Eç«¯å£æ˜¯ç”¨äºALUç»“æœçš„å†™ï¼ŒdstEä¸ºåœ°å€å¼•è„šï¼ŒvalEä¸ºè¾“å…¥æ•°æ®å¼•è„šï¼›Mç«¯å£æ˜¯ç”¨äºå­˜å‚¨å™¨ç»“æœçš„å†™ï¼ŒdstMä¸ºåœ°å€å¼•è„šï¼ŒvalMä¸ºè¾“å…¥æ•°æ®å¼•è„š

> 0xFè¡¨ç¤ºä¸éœ€è¦è®¿é—®å¯„å­˜å™¨

Figure4.28 [ğŸ–¼ï¸ å›¾ç‰‡](image/image_sqBmZz67FM.png "ğŸ–¼ï¸ å›¾ç‰‡")ä¸‹æ–¹çš„4ä¸ªæ§åˆ¶é€»è¾‘å—æ˜¯ç”¨æ¥æ ¹æ®rAã€rBå’Œicodeç”Ÿæˆ4ç§ç«¯å£çš„åœ°å€å¼•è„šçš„

```c++
//4ä½çš„æ•°æ®é‡ç§°ä¸ºword
word srcA={
  icode in {IRRMOVQ,IRMMOVQ,IOPQ,IPUSHQ} : rA;
  icode in {IRET,IPOPQ} : 0x4;//0x4ä¸º%rspçš„ç¼–å·
  1 : 0xF;  
};//åªæ˜¯éœ€è¦è¯»rAå¯„å­˜å™¨çš„æŒ‡ä»¤
word srcB={
  icode in {IRMMOVQ,IMRMOVQ,IOPQ} : rB;
  icode in {IPUSHQ,IPOPQ,ICALL,IRET} : 0x4;
  1 : 0xF;
};//åªæ˜¯éœ€è¦è¯»rBå¯„å­˜å™¨çš„æŒ‡ä»¤
word dstE={
  icode in {IRRMOVQ} && Cnd : rB;
  icode in {IOPQ,IIRMOVQ,IRRMOVQ} : rB;
  icode in {IPUSHQ,IPOPQ,ICALL,IRET} : 0x4;
  1 : 0xF;
};//å†™ALUç»“æœçš„æŒ‡ä»¤
word dstM={
  icode in {IMRMOVQ,IPOPQ} : rA;
  1 : 0xF;
};//å†™MEMç»“æœçš„æŒ‡ä»¤
```

### æ‰§è¡Œé˜¶æ®µ

![](image/image_lTe7q84RII.png)

Figure4.19å±•ç¤ºäº†æ‰§è¡Œé˜¶æ®µçš„æ§åˆ¶é€»è¾‘ã€‚è¿™ä¸€å•å…ƒä¼šåŸºäºalufunä¿¡å·å¯¹è¾“å…¥çš„aluAå’ŒaluBåšæŒ‡å®šçš„è¿ç®—

aluæ‰€åšçš„æ“ä½œéƒ½æ˜¯å°†aluBä½œä¸ºç¬¬ä¸€æ“ä½œæ•°ï¼ŒaluAä½œç¬¬äºŒæ“ä½œæ•°

```c++
word aluA={
  icode in {IOPQ,IRRMOVQ} : valA;
  icode in {IIRMOVQ,IRMMOVQ,IMRMOVQ} : valC;
  icode in {IPUSHQ,ICALL} : -8;
  icode in {IPOPQ,IRET} : 8;
};
word aluB={
  icode in {IOPQ,IRMMOVQ,IMRMOVQ,IPUSHQ,IPOPQ,ICALL,IRET} : valB;
  icode in {IRRMOVQ,IIRMOVQ} : 0;
};
```

ALUé™¤äº†IOPQå¯¹åº”çš„è¿ç®—ä»¥å¤–ï¼Œå…¶ä»–åŸºæœ¬æ‰§è¡Œçš„éƒ½æ˜¯åŠ æ³•ï¼Œå› æ­¤å¯ä»¥ç¼–ç alufunä¸º

```c++
word alufun={
  icode==IOPQ : ifun;
  1 : ADD;
};
```

æ‰§è¡Œé˜¶æ®µè¿˜éœ€è¦æ ¹æ®ALUçš„æ“ä½œç»“æœè®¾ç½®Condï¼Œåœ¨Y86-64ä¸­åªæœ‰opqæŒ‡ä»¤éœ€è¦è®¾ç½®Condï¼Œå› æ­¤å¯ä»¥å¾—åˆ°

```c++
bool set_cc= icode==IOPQ;
```

condè¿™ä¸ªç¡¬ä»¶å•å…ƒæ˜¯ä½¿ç”¨æ¡ä»¶ç CCå’ŒåŠŸèƒ½ç ifunä¸€èµ·å†³å®šæ˜¯å¦é‡‡ç”¨æ¡ä»¶åˆ†æ”¯æˆ–è€…æ•°æ®è½¬ç§»ã€‚condä¼šæ ¹æ®CCã€ifunçš„è¾“å…¥è¾“å‡ºä¸€ä¸ªä¸€ä½ä¿¡å·Condï¼Œå¹¶æ ¹æ®è¿™ä¸€ä¿¡å·è®¾ç½®æ¡ä»¶è½¬ç§»çš„dstEå’Œæ˜¯å¦åˆ†æ”¯çš„nextPC

### è®¿å­˜é˜¶æ®µ

![](image/image_DcttheZ3rc.png)

å¦‚Figure4.30æ‰€ç¤ºï¼Œè®¿å­˜é˜¶æ®µéœ€è¦å®Œæˆè¯»å–ç¨‹åºæ•°æ®ä»¥åŠå†™ç¨‹åºæ•°æ®çš„ä»»åŠ¡ã€‚æ§åˆ¶å—memAddrç”Ÿæˆè®¿é—®çš„å­˜å‚¨å™¨åœ°å€ï¼ŒmemDataç”Ÿæˆè®¿é—®çš„å­˜å‚¨å™¨æ•°æ®ï¼ŒmemReadåˆ™ç”Ÿæˆè¯»ä¿¡å·ï¼ŒmemWriteç”Ÿæˆå†™ä¿¡å·

```c++
word memAddr={
  icode in {IRMMOVQ,IMRMOVQ,IPUSHQ,ICALL} : valE;
  icode in {IPOPQ,IRET} : valA;
};

word memData={
  icode in {IRMMOVQ,IPUSHQ} : valA;
  icode == ICALL : valP;
};

bool memRead = icode in {IMRMOVQ,IPOPQ,IRET};
bool memWrite = icode in {IRMMOVQ,IPUSHQ,ICALL}

```

è®¿å­˜é˜¶æ®µè¿˜éœ€è¦æ ¹æ®icodeã€imem\_errorã€instr\_validå’Œdmem\_errorç”ŸæˆstatçŠ¶æ€ç 

### æ›´æ–°PCé˜¶æ®µ

![](image/image_vH9UEY9-U2.png)

æ–°PCçš„å€¼å¯ä»¥æ˜¯valCã€valMæˆ–è€…valPã€‚å…¶å¯¹åº”çš„HCLæè¿°å¦‚ä¸‹ï¼š

```c++
word new_pc={
  icode == IJXX && Cnd : valC;
  icode == ICALL : valC;
  icode == IRET : valM;
  1:valP;
};
```

> âœ¨SEQæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å®ƒååˆ†ç¼“æ…¢ã€‚æ—¶é’Ÿå¿…é¡»è¿è¡Œåœ°è¶³å¤Ÿæ…¢ï¼Œä»¥ä¾¿æ¯ä¸€ç§æŒ‡ä»¤çš„æ“ä½œéƒ½å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…æ‰§è¡Œå®Œæ¯•
>
> SEQçš„å®ç°æœºåˆ¶å¹¶æœªå……åˆ†åˆ©ç”¨æ¿è½½çš„ç¡¬ä»¶èµ„æºï¼Œå› ä¸ºæ¯ä¸€ä¸ªç¡¬ä»¶å•å…ƒåœ¨æ•´ä¸ªæ—¶é’Ÿå‘¨æœŸå†…åªæœ‰ä¸€å®šçš„æ¯”ä¾‹å¤„äºæ´»è·ƒæ€

# 4.4 *General Principles of Pipelining*

> *Some general properties and principles of pipelined systems*
>
> 1.  *In a pipelined system, the task to be performed is divided into a series of discrete stages.*
> 2.  *Must move at the same rate*
> 3.  \*A key feature of pipelining is that it increases the throughput of the systembut it may also slightly increase the latency \*
>
>     *throughput:* â€‹*the number of customers served per unit time*
>
>     *latency:* â€‹*the time required to service an individual customer*

## 4.4.1 *Computational Pipelines*

![](image/image_l5CTKojynZ.png)

åœ¨ç›®å‰çš„é€»è¾‘è®¾è®¡ä¸­ï¼Œè¡¡é‡ç”µè·¯å»¶è¿Ÿæ˜¯ä½¿ç”¨psæ•°é‡çº§ï¼Œå³$10^{-12} s$

åˆ™åœ¨Figure4.32çš„ç¤ºä¾‹ä¸­ï¼Œå‡è®¾ç»„åˆé€»è¾‘è®¡ç®—å—çš„å»¶è¿Ÿæ˜¯300psã€æ—¶é’Ÿå¯„å­˜å™¨çš„åŠ è½½å»¶è¿Ÿæ˜¯20psï¼Œåˆ™æ•´ä¸ªç³»ç»Ÿçš„latencyæ˜¯320psï¼Œthroughputæ˜¯3.12GIPS

![](image/image_28HnJemIp2.png)

å‡è®¾å¦‚Figure4.33æ‰€ç¤ºï¼Œå°†Figure4.32ä¸­çš„ç»„åˆé€»è¾‘åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µAã€Bå’ŒCï¼Œæ¯ä¸ªé˜¶æ®µè€—æ—¶100psã€‚å¹¶åœ¨é˜¶æ®µä¹‹é—´æ’å…¥æ—¶é’Ÿå¯„å­˜å™¨ä»¥å®ç°æµæ°´ã€‚è¿™æ ·åˆ™å½“è¯¥ç³»ç»Ÿå¤„äºç¨³å®šæ—¶ï¼Œæ¯ä¸ªæ—¶é’Ÿå‘¨æœŸæœ‰ä¸€æ¡æŒ‡ä»¤ç¦»å¼€ç³»ç»Ÿå¹¶æœ‰ä¸€æ¡æŒ‡ä»¤è¿›å…¥ç³»ç»Ÿã€‚å¯ä»¥è®¡ç®—å‡ºæ—¶é’Ÿå‘¨æœŸæ˜¯120psï¼Œlatencyæ˜¯360psï¼Œthroughputæ˜¯8.33GIPS

> âœ¨ååé‡çš„å¢åŠ ä½¿å¾—ç¡¬ä»¶çš„å¼€é”€å’Œå»¶è¿Ÿå¢åŠ [^æ³¨é‡Š8]

## 4.4.2 *A Detailed Look at Pipeline Operation*

![](image/image_iCfZwV0jmH.png)

åœ¨240psçš„æ—¶é’Ÿä¸Šå‡ä¹‹å‰ï¼Œç»„åˆé€»è¾‘çš„è¾“å‡ºå¹¶æ²¡æœ‰æ‰“å…¥åˆ°å¯„å­˜å™¨ä¸­ã€‚å› æ­¤ç»„åˆé€»è¾‘Bå’ŒReg1æ˜¯åœ¨è®¡ç®—I1çš„ï¼Œç»„åˆé€»è¾‘Aæ˜¯I2ï¼Œç»„åˆé€»è¾‘Cæ˜¯ä¸æ´»è·ƒçš„
åœ¨240psçš„æ—¶é’Ÿä¸Šå‡ä¹‹åï¼Œä¹‹å‰çš„ç»„åˆé€»è¾‘è¾“å‡ºå·²ç»æ‰“å…¥åˆ°äº†å¯„å­˜å™¨ä¸­ä½†æ˜¯è¿˜æ²¡æœ‰è¿‡20psï¼Œä»æ²¡æœ‰ä¼ è¾“åˆ°ç´§æ¥ç€å¯„å­˜å™¨çš„ç»„åˆé€»è¾‘å—ï¼Œå› æ­¤ç»„åˆé€»è¾‘Aã€Bã€Cå‡ç©ºï¼ŒReg2æ˜¯I1ï¼ŒReg1æ˜¯I2
åœ¨300psæ—¶ï¼Œä¸Šä¸€é˜¶æ®µçš„ç»„åˆé€»è¾‘è¾“å‡ºå·²ç»ä¼ æ’­å‡ºå¯„å­˜å™¨ï¼Œå› æ­¤Reg2å’Œç»„åˆé€»è¾‘Cæ˜¯I1ï¼›Reg1å’Œç»„åˆé€»è¾‘Bæ˜¯I2ï¼›ç»„åˆé€»è¾‘Aæ˜¯I3
åœ¨359psæ—¶ï¼Œç»„åˆé€»è¾‘çš„è®¡ç®—å·²å®Œæ¯•ï¼Œç­‰å¾…ä¼ æ’­åˆ°å¯„å­˜å™¨

## 4.4.3 *Limitations of Pipelining*

### *Nonuniform Partitioning*

åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯èƒ½ä¼šå‡ºç°å¦‚ä¸‹å›¾è¿™æ ·å­˜åœ¨ç€åˆ’åˆ†çš„ç»„åˆé€»è¾‘æ®µæ‰€éœ€è¦çš„æ—¶é—´æ˜¯ä¸ç­‰é•¿çš„ç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿçš„latencyæ˜¯510psï¼Œthroughputæ˜¯5.88GIPSâ€”â€”å› ä¸º**æ—¶é’Ÿå‘¨æœŸä¼šè®¾ç½®ä¸ºç“¶é¢ˆæ®µæ‰€éœ€è¦çš„æ—¶é—´**

![](image/image_MnZw-J8fdN.png)

å…¶æµæ°´çº¿æ—¶ç©ºå›¾å¦‚ä¸‹ï¼š

![](image/image_xX0UFWnwNW.png)

> ä¾‹é¢˜
>
> ![](image/image_GYoaR9dtoY.png)
>
> A. ABC å¯„å­˜å™¨ DEF æ—¶é’Ÿå‘¨æœŸæ˜¯190ps
> B. AB CD EF æ—¶é’Ÿå‘¨æœŸæ˜¯130ps
> C.A BC D E æ—¶é’Ÿå‘¨æœŸæ˜¯110ps
> D.A B C D EF æ—¶é’Ÿå‘¨æœŸæ˜¯100ps

### *Diminishing Returns of Deep Pipelining*

å› ä¸ºåœ¨å„ä¸ªç»„åˆé€»è¾‘å—ä¹‹é—´éœ€è¦æ’å…¥å¯„å­˜å™¨æ¥æ§åˆ¶ï¼Œæ‰€ä»¥å¦‚æœåˆ’åˆ†çš„æ®µå¤ªå¤šï¼Œé‚£ä¹ˆå°±ä¼šå¢åŠ å¤ªå¤šçš„é¢å¤–ç¡¬ä»¶æˆæœ¬ä»¥åŠå¯„å­˜å™¨å»¶è¿Ÿï¼Œä½¿å¾—latencyä¸­çš„å¯„å­˜å™¨å»¶è¿Ÿçš„æ¯”ä¾‹å‡é«˜ï¼Œä¸”å¯¹ååé‡çš„å¢åŠ çš„æ¯”ä¾‹ä¹Ÿä¸‹é™

> *Modern processors employ very deep pipelines (15 or more stages) in an attempt to maximize the processor clock rate. The processor architects divide the instruction execution into a large number of very simple steps so that each stage can have a very small delay.*

> ä¾‹é¢˜
>
> ![](image/image_drF1gSHGns.png)
>
> A.
>
> $$
> latency=\frac {300}{k} \times k +20 k=300+20k \\
> throughput=\frac{1000}{\frac{300}{k}+20}= \frac{1000k}{300+20k}
> $$
>
> B.kè¶‹äºæ— ç©·æ—¶ï¼Œthroughputä¸Šé™æ˜¯50GIPS

## 4.4.4 *Pipelining a System with Feedback*

è¿™é‡Œçš„åé¦ˆå›è·¯å³æ˜¯å¸¦æœ‰å†’é™©çš„æµæ°´çº¿ï¼ŒåŒ…æ‹¬æ•°æ®å†’é™©ã€æ§åˆ¶å†’é™©å’Œç»“æ„å†’é™©

# 4.5 *Pipelined Y86-64 Implementations*

## 4.5.1 SEQ+: Rearranging the Computation Stages

é¦–å…ˆä¸ºäº†å®ç°SEQå‘æµæ°´çº¿è®¾è®¡çš„è¿‡æ¸¡ï¼Œéœ€è¦é‡æ–°å®‰æ’SEQä¸­å…­ä¸ªé˜¶æ®µçš„é¡ºåºâ€”â€”å°†PCçš„æ›´æ–°è®¡ç®—æ”¾åœ¨å–æŒ‡é˜¶æ®µå‰ï¼Œä½¿å¾—æ›´æ–°PCåœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå¼€å§‹æ—¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯ç»“æŸæ—¶æ‰æ‰§è¡Œã€‚è¿™ç§ä¿®æ”¹åçš„è®¾è®¡å«åš`SEQ+`

æ”¾åœ¨æ—¶é’Ÿå‘¨æœŸç»“æŸæ—¶æ˜¯è®¡ç®—ä¸‹ä¸€æ¡æŒ‡ä»¤çš„PCï¼Œä½†æ”¾åœ¨æ—¶é’Ÿå‘¨æœŸå¼€å§‹æ—¶æ˜¯è®¡ç®—å½“å‰æŒ‡ä»¤çš„PC

PCæ›´æ–°çš„å…¬å¼æ˜¯

```c++
word new_pc={
  icode == IJXX && Cnd : valC;
  icode == ICALL : valC;
  icode == IRET : valM;
  1:valP;
};
```

å› æ­¤**æ”¾åœ¨æ—¶é’Ÿå‘¨æœŸå¼€å§‹æ—¶è®¡ç®—å½“å‰æŒ‡ä»¤çš„PCéœ€è¦ä¿å­˜ä¸Šä¸€æ¡æŒ‡ä»¤çš„çŠ¶æ€ç»“æœï¼š`icodeã€Cndã€valCã€valMã€valP`**ã€‚å…¶SEQã€SEQ+å¯¹åº”çš„é€»è¾‘å›¾å¦‚ä¸‹ï¼š

![](image/image_8IXuMmsmQF.png)

ä¸‹å›¾ç»™å‡ºäº†SEQ+ç¡¬ä»¶çš„ä¸€ä¸ªæ›´ä¸ºè¯¦ç»†çš„è¯´æ˜ï¼Œé™¤æ›´æ–°PCå¤–å®Œå…¨ä¸€æ ·â€”â€”PCé€»è¾‘ä»ä¸Šé¢ï¼ˆåœ¨æ—¶é’Ÿå‘¨æœŸç»“æŸæ—¶æ´»åŠ¨ï¼‰ç§»åˆ°äº†ä¸‹é¢ï¼ˆåœ¨æ—¶é’Ÿå‘¨æœŸå¼€å§‹æ—¶æ´»åŠ¨ï¼‰

![](image/image_Hte1G3yVIl.png)

> SEQ+ä¸­çš„PCï¼š
>
> *One curious feature of SEQ+ is that*-   there is no hardware register storing the program counter. Instead, the PC is computed dynamically based on some state information stored from the previous instruction.\* â€‹*This is a small illustration of the fact that **we can implement a processor in a way that differs from the conceptual model implied by the ISA, as long as the processor correctly executes arbitrary machinelanguage programs**. We need not encode the state in the form indicated by the programmer-visible state, as long as the processor can generate correct values for any part of the programmer-visible state (such as the program counter).*

## 4.5.2 Inserting Pipeline Registers

### PIPE-ç¡¬ä»¶ç»“æ„

è¿™ä¸€éƒ¨åˆ†æ˜¯åœ¨SEQ+çš„å„é˜¶æ®µä¹‹é—´æ’å…¥æµæ°´çº¿å¯„å­˜å™¨å¹¶ç¨å¾®é‡æ–°æ’åˆ—ä¿¡å·ï¼Œä»è€Œäº§ç”Ÿ`PIPE-`[^æ³¨é‡Š9]

PIPE-çš„ç¡¬ä»¶ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå›¾ä¸­çš„è“è‰²æ¡†ä¸ºæµæ°´çº¿å¯„å­˜å™¨ï¼Œæ¯ä¸ªå¯„å­˜å™¨åŒ…å«æ˜¾ç¤ºä¸ºç™½è‰²æ¡†çš„ä¸åŒå­—æ®µã€‚

![](image/image_Xyl-CLVhzZ.png)

ä¸‹é¢ä»‹ç»ä¸€ä¸‹æ‰€æ·»åŠ çš„æµæ°´çº¿å¯„å­˜å™¨ï¼Œé™¤æµæ°´çº¿å¯„å­˜å™¨å¤–å…¶ä½™çš„ç¡¬ä»¶å•å…ƒé›†åˆæ˜¯å‡ ä¹å’ŒSEQã€SEQ+ç›¸åŒçš„

Fï¼šæœ‰ä¸€ä¸ªä¿å­˜ç€PCçš„é¢„æµ‹å€¼çš„å­—æ®µ`predPC`

Dï¼šä½äºå–æŒ‡å’Œè¯‘ç é˜¶æ®µä¹‹é—´ã€‚ä¿å­˜æœ‰å…³æœ€è¿‘è·å–çš„æŒ‡ä»¤çš„ä¿¡æ¯`statã€icodeã€ifunã€rAã€rBã€valCã€valP`ï¼Œä»¥ä¾›è§£ç é˜¶æ®µå¤„ç†

Eï¼šä½äºè¯‘ç å’Œæ‰§è¡Œé˜¶æ®µä¹‹é—´ã€‚ä¿å­˜æœ‰å…³æœ€è¿‘è¯‘ç çš„æŒ‡ä»¤çš„ä¿¡æ¯`dstEã€dstMã€srcAã€srcB`ä»¥åŠä»å¯„å­˜å™¨æ–‡ä»¶å–å‡ºçš„å€¼`valAã€valB`ä»¥ä¾›æ‰§è¡Œé˜¶æ®µå¤„ç†

Mï¼šä½äºæ‰§è¡Œå’Œè®¿å­˜é˜¶æ®µä¹‹é—´ã€‚ä¿å­˜æœ‰å…³æœ€è¿‘æ‰§è¡Œçš„æŒ‡ä»¤çš„æ‰§è¡Œç»“æœ`valE`ä»¥ä¾›è®¿å­˜é˜¶æ®µå¤„ç†ï¼Œä¹Ÿä¿å­˜å…³äºåˆ†æ”¯æ¡ä»¶å’Œåˆ†æ”¯ç›®æ ‡çš„ä¿¡æ¯`Cond`ä»¥ä¾›æ¡ä»¶è·³è½¬å¤„ç†

Wï¼šä½äºè®¿å­˜é˜¶æ®µå’Œåé¦ˆè·¯å¾„ä¹‹é—´ï¼Œåé¦ˆè·¯å¾„å°†è®¡ç®—ç»“æœ`valE`å†™å…¥å¯„å­˜å™¨æ–‡ä»¶ï¼Œå¹¶åœ¨å®ŒæˆretæŒ‡ä»¤æ—¶å°†è¿”å›åœ°å€`valM`æä¾›ç»™PCé€‰æ‹©é€»è¾‘

### ä»£ç åˆ†æç¤ºä¾‹

```webassembly
irmovq $1,%rax # I1 
irmovq $2,%rbx # I2 
irmovq $3,%rcx # I3 
irmovq $4,%rdx # I4 
halt # I5
```

![](image/image_uf-ykL5ELc.png)

## 4.5.3 Rearranging and Relabeling Signals

> *Our sequential implementations*-   SEQ and SEQ+ only process one instruction at a time, and so there are unique values for signals such as valC, srcA, and valE\* \*.In our pipelined design, there will be**multiple versions of these values associated with the different instructions flowing through the system**. For example, in the detailed structure of PIPEâˆ’, there are four white boxes labeled â€œStatâ€ that hold the status codes for four different instructions (see Figure 4.41). We need to take great care to make sure we use the proper version of a signal, or else we could have serious errors, such as storing the result computed for one instruction at the destination register specified by another instruction.\*

å¯¹æµæ°´çº¿ä¸­çš„åŒç±»ä¿¡å·çš„ä¸åŒç‰ˆæœ¬çš„å‘½åæ–¹æ³•æ˜¯ï¼šå­˜å‚¨åœ¨æŸä¸ªæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„ä¿¡å·å¯ä»¥é€šè¿‡åœ¨è¿™ä¸ªä¿¡å·åç§°å‰åŠ ä¸Šå¤§å†™çš„æµæ°´çº¿å¯„å­˜å™¨çš„å‰ç¼€æ¥å”¯ä¸€æ ‡è¯†

æ­¤å¤–ä¹Ÿéœ€è¦å¼•ç”¨æŸäº›åœ¨ä¸€ä¸ªé˜¶æ®µå†…åˆšåˆšè¢«è®¡ç®—å‡ºæ¥çš„ä¿¡å·ï¼Œå‘½åæ–¹æ³•æ˜¯åœ¨ä¿¡å·åå‰åŠ ä¸Šå°å†™çš„é˜¶æ®µåçš„ç¬¬ä¸€ä¸ªå­—æ¯ä½œä¸ºå‰ç¼€

> âœ¨åŒºåˆ†è¿™ä¸¤ç§å‰ç¼€å‘½åæ³•
>
> ![](image/image_mXRzVFTmXT.png)

æ­¤å¤–PIPE-å’ŒSEQ+è™½ç„¶éƒ½åœ¨è¯‘ç é˜¶æ®µç”Ÿæˆäº†dstEã€dstMã€‚ä½†æ˜¯åœ¨SEQ+ä¸­dstEã€dstMæ˜¯ç›´æ¥é€åˆ°å¯„å­˜å™¨æ–‡ä»¶çš„ï¼Œå› ä¸ºå‘¨æœŸå†…æ‰§è¡Œçš„æŒ‡ä»¤æ˜¯ä¸å˜çš„ï¼›è€ŒPIPE-ä¸­è‹¥é‡‡å–SEQ+åŒæ ·çš„æ–¹æ³•ï¼Œåˆ™åœ¨å†™å›é˜¶æ®µæ—¶ï¼ŒiæŒ‡ä»¤çš„ç»“æœæ˜¯å†™åˆ°i+3æŒ‡ä»¤ä¸­çš„dstEã€dstMã€‚å› æ­¤dstEã€dstMéœ€è¦é€šè¿‡æµæ°´çº¿å¯„å­˜å™¨å‘WBé˜¶æ®µä¼ é€’

PIPE-ä¸­è¿˜åœ¨è¯‘ç é˜¶æ®µå¢åŠ äº†â€œSelect Aâ€æ§åˆ¶é€»è¾‘å—[^æ³¨é‡Š10]ï¼Œè¯¥å—ä»Dæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„valPå’Œå¯„å­˜å™¨æ–‡ä»¶Aç«¯å£è¯»å‡ºçš„æ•°æ®ä¸­é€‰æ‹©ä¸€ä¸ªé€å¾€Eæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„valA

åœ¨æ‰€æœ‰çš„æŒ‡ä»¤å·¾ï¼Œåªæœ‰cal1åœ¨è®¿å­˜é˜¶æ®µéœ€è¦va1Pçš„å€¼[^æ³¨é‡Š11]ã€‚åªæœ‰è·³è½¬æŒ‡ä»¤åœ¨æ‰§è¡Œé˜¶æ®µï¼ˆå½“ä¸éœ€è¦è¿›è¡Œè·³è½¬æ—¶ï¼‰éœ€è¦va1Pçš„å€¼[^æ³¨é‡Š12]ã€‚è€Œè¿™äº›æŒ‡ä»¤åˆéƒ½ä¸éœ€è¦ä»å¯„å­˜å™¨æ–‡ä»¶ä¸­è¯»å‡ºçš„å€¼ã€‚å› æ­¤æˆ‘ä»¬åˆå¹¶è¿™ä¸¤ä¸ªä¿¡å·ï¼Œå°†å®ƒä»¬ä½œä¸ºä¿¡å·valAæºå¸¦ç©¿è¿‡æµæ°´çº¿ï¼Œä»è€Œå¯ä»¥å‡å°‘æµæ°´çº¿å¯„å­˜å™¨çš„çŠ¶æ€æ•°é‡ã€‚è¿™æ ·åšå°±æ¶ˆé™¤äº†SEQå’ŒSEQ+ä¸­æ ‡å·ä¸ºâ€œDataâ€çš„å—ï¼Œè¿™ä¸ªå—å®Œæˆçš„æ˜¯ç±»ä¼¼çš„åŠŸèƒ½ã€‚åœ¨ç¡¬ä»¶è®¾è®¡ä¸­ï¼Œåƒè¿™æ ·ä»”ç»†ç¡®è®¤ä¿¡å·æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Œç„¶åé€šè¿‡åˆå¹¶ä¿¡å·æ¥è¯šå°‘å¯„å­˜å™¨çŠ¶æ€å’Œçº¿è·¯çš„æ•°é‡ï¼Œæ˜¯å¾ˆå¸¸è§çš„

## 4.5.4 Next PC Prediction

è¿™ä¸€èŠ‚å°†ä»‹ç»åœ¨PIPE-è®¾è®¡ä¸­è§£å†³æ§åˆ¶ä¾èµ–æ‰€é‡‡ç”¨çš„ä¸€äº›æ–¹æ³•

æµæ°´çš„ç†æƒ³ç›®æ ‡æ˜¯å®ç°throughputä¸ºæ¯ä¸ªå‘¨æœŸä¸€æ¡æŒ‡ä»¤ã€‚è¦å®ç°è¿™ä¸ªç›®æ ‡å¿…é¡»åœ¨å»é™¤å½“å‰æŒ‡ä»¤ä¹‹åé©¬ä¸Šç¡®å®šä¸‹ä¸€æ¡æŒ‡ä»¤çš„ä½ç½®ã€‚ä½†æ˜¯ç”±äºåˆ†æ”¯ã€è·³è½¬çš„å­˜åœ¨ä½¿å¾—è¦åˆ°å‡ ä¸ªå‘¨æœŸä¹‹åæ‰èƒ½ç¡®å®šä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€

é‡‡å–çš„è§£å†³æ–¹æ³•æ˜¯è¿›è¡Œåˆ†æ”¯é¢„æµ‹ï¼ŒçŒœæµ‹åˆ†æ”¯æ–¹å‘å¹¶æ ¹æ®çŒœæµ‹å¼€å§‹å–æŒ‡ã€‚ä½†æ˜¯æ— è®ºæ˜¯é¢„æµ‹åˆ†æ”¯æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œéƒ½å¿…é¡»ä»¥æŸç§æ–¹å¼å¤„ç†æˆ‘ä»¬çš„é¢„æµ‹ä¸æ­£ç¡®çš„æƒ…å†µ

å¯¹äºY86-64æ¥è¯´ï¼Œé™¤è·³è½¬å’ŒretæŒ‡ä»¤å¤–ï¼Œä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å‡æ˜¯valPï¼›å¯¹äºcallå’Œjmpæ¥è¯´ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€å‡æ˜¯valCï¼›å¯¹äºretæ¥è¯´æ˜¯valMï¼›å¯¹äºåˆ†æ”¯æŒ‡ä»¤æ¥è¯´ï¼Œé¢„æµ‹æˆåŠŸå³ä¸ºvalCå¦åˆ™æ˜¯valP

åœ¨æœ¬æ¬¡è®¾è®¡ä¸­ï¼Œä»…ä½¿ç”¨é¢„æµ‹åˆ†æ”¯æˆåŠŸè¿™ç§ç­–ç•¥ï¼Œå³é‡åˆ°åˆ†æ”¯æŒ‡ä»¤æ—¶é¢„æµ‹ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€æ˜¯valCã€‚å¯¹äºretæŒ‡ä»¤ï¼Œå› ä¸ºè¿”å›åœ°å€éœ€è¦åœ¨è®¿å­˜åæ‰å¯ä»¥å¾—åˆ°ï¼Œæ‰€é‡‡å–çš„æªæ–½æ˜¯æš‚åœå–æŒ‡ï¼Œç­‰åˆ°retæŒ‡ä»¤é€šè¿‡å†™å›é˜¶æ®µ

å¦‚Figure4.41[ğŸ–¼ï¸ å›¾ç‰‡](image/image_cFal17EdHE.png "ğŸ–¼ï¸ å›¾ç‰‡")æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°å–æŒ‡é˜¶æ®µæœ‰ä¸€ä¸ªâ€œPredict PCâ€æ§åˆ¶é€»è¾‘ï¼Œè¯¥æ§åˆ¶é€»è¾‘åœ¨valPå’ŒvalCä¸­äºŒé€‰ä¸€äº§ç”Ÿé¢„æµ‹å¾—åˆ°çš„PCï¼Œå­˜å‚¨åœ¨Få¯„å­˜å™¨çš„`predPC`å­—æ®µã€‚è€Œâ€œSelect PCâ€æ§åˆ¶é€»è¾‘åˆ™åœ¨`predPC`ã€æ²¡æœ‰é‡‡ç”¨åˆ†æ”¯çš„åˆ†æ”¯è·³è½¬æŒ‡ä»¤çš„`valPå³M_valA`ã€retæŒ‡ä»¤åˆ°å†™å›é˜¶æ®µæ—¶çš„`W_valM`

## 4.5.5 Pipeline Hazards

æ‰€é‡åˆ°çš„ä¾èµ–åŒ…æ‹¬ä¸¤ç§å½¢å¼ï¼š

1.  æ•°æ®ä¾èµ–ï¼šæŸæ¡æŒ‡ä»¤çš„è®¡ç®—ç»“æœè¢«åç»­æŒ‡ä»¤å½“ä½œæºæ•°æ®ä½¿ç”¨
2.  æ§åˆ¶ä¾èµ–ï¼šæŸæ¡æŒ‡ä»¤ç¡®å®šä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼Œä¾‹å¦‚callã€jumpã€retæŒ‡ä»¤

> **ä¾èµ–å¯èƒ½ä¼šå¯¼è‡´å†’é™©ï¼Œä½†å†’é™©ä¸€å®šæ˜¯**ä¾èµ–
>
> *When such dependencies have the potential to cause an erroneous computation by the pipeline, they are called hazards.*

å’Œä¾èµ–ä¸€æ ·ï¼Œé˜»å¡ä¹Ÿå¯ä»¥åˆ†ä¸ºæ•°æ®å†’é™©å’Œæ§åˆ¶å†’é™©

å› ä¸ºIDé˜¶æ®µå–å¯„å­˜å™¨æ•°ï¼Œä½†æ˜¯å¯¹å¯„å­˜å™¨ç»“æœçš„æ›´æ–°æ˜¯åœ¨WBé˜¶æ®µå®Œæˆä¹‹åï¼Œå› æ­¤å½“æŒ‡ä»¤çš„æ“ä½œæ•°ä¹‹ä¸€è¢«å‰é¢çš„ä¸‰ä¸ªæŒ‡ä»¤ä¸­çš„ä»»ä½•ä¸€ä¸ªæ›´æ–°æ—¶ï¼Œè¯¥æŒ‡ä»¤å¯èƒ½ä¼šå‡ºç°æ•°æ®å†’é™©

### Avoiding Data Hazards by Stalling

é¿å…æ•°æ®å†’é™©çš„ä¸€ä¸ªéå¸¸é€šç”¨çš„æŠ€å·§æ˜¯é˜»å¡â€”â€”å¤„ç†å™¨æŠ‘åˆ¶åœ¨æµæ°´çº¿ä¸­çš„ä¸€æ¡æˆ–å¤šæ¡æŒ‡ä»¤ç›´åˆ°å†’é™©çš„çŠ¶å†µä¸å†æˆç«‹ã€‚æ›´ä¸ºæ˜“æ‡‚çš„è¯´æ³•æ˜¯å¤„ç†å™¨å¯ä»¥åœ¨è¯‘ç é˜¶æ®µæŠ‘åˆ¶è¿™æ¡æŒ‡ä»¤ç›´åˆ°ç”Ÿæˆå…¶æºæ“ä½œæ•°çš„æŒ‡ä»¤å·²é€šè¿‡å†™å›é˜¶æ®µå°†ç»“æœå†™å›åˆ°å¯„å­˜å™¨æ–‡ä»¶ä¸­æ¥é¿å…æ•°æ®å†’é™©

> *Our processor can avoid data hazards by holding back an instruction in the decode stage until the instructions generating its source operands have passed through the write-back stage.*

å½“æŸæ¡æŒ‡ä»¤ç»è¿‡IDé˜¶æ®µï¼Œç”±æµæ°´çº¿æ§åˆ¶å•å…ƒæ£€æµ‹åˆ°è‡³å°‘æœ‰ä¸€æ¡åœ¨EXã€MEMã€WBé˜¶æ®µçš„æŒ‡ä»¤è¦æ›´æ–°è¯¥æ¡æŒ‡ä»¤çš„æºæ“ä½œæ•°ï¼Œé‚£ä¹ˆæµæ°´çº¿æ§åˆ¶å•å…ƒå°±ä¼šé˜»å¡è¯¥æ¡æŒ‡ä»¤åœ¨IDæ®µ1\~3ä¸ªå‘¨æœŸç›´åˆ°EXã€MEMã€WBé˜¶æ®µçš„æŒ‡ä»¤å·²ç»å°†ç»“æœå†™å›åˆ°å¯„å­˜å™¨æ–‡ä»¶ä¸­

è¦é˜»å¡IDé˜¶æ®µæŒ‡ä»¤ï¼Œé‚£ä¹ˆä¹Ÿå¿…é¡»é˜»å¡IFé˜¶æ®µçš„å–æŒ‡â€”â€”å¯ä»¥é€šè¿‡ä¿æŒPCå¯„å­˜å™¨ä¸ºå½“å‰è¦å–æŒ‡çš„æŒ‡ä»¤åœ°å€æ¥é‡å¤å–æŒ‡ç›´åˆ°é˜»å¡è§£é™¤

StallingæŠ€æœ¯æ˜¯å…è®¸ä¸€ç»„æŒ‡ä»¤é˜»å¡åœ¨å®ƒä»¬åœ¨æµæ°´çº¿çš„å½“å‰é˜¶æ®µï¼ˆ`IF/ID`ï¼‰ï¼Œç„¶åè®©`EXã€MEMã€WB`é˜¶æ®µçš„æŒ‡ä»¤æ­£å¸¸æ‰§è¡Œã€‚ä½¿ç”¨StallingæŠ€æœ¯æœ€åçš„æ—¶ç©ºå›¾æ˜¯å’Œæ’å…¥å¯¹åº”é˜»å¡å‘¨æœŸæ•°çš„`nopæŒ‡ä»¤`çš„æ—¶ç©ºå›¾æ˜¯ä¸€æ ·çš„ï¼Œå¦‚ä¸‹å›¾

![](image/image_NGp9unoEGp.png)

> âœ¨StallingæŠ€æœ¯æ¯”è¾ƒå®¹æ˜“å®ç°ï¼Œä½†æ˜¯å®ƒçš„æ€§èƒ½å¹¶ä¸æ˜¯å¾ˆå¥½ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œä¸€æ¡æŒ‡ä»¤æ›´æ–°å¯„å­˜å™¨ï¼Œè€Œç´§éšå…¶åçš„æŒ‡ä»¤ä½¿ç”¨åŒä¸€å¯„å­˜å™¨ã€‚è¿™å°†å¯¼è‡´æµæ°´çº¿åœé¡¿æœ€å¤šä¸‰ä¸ªå‘¨æœŸï¼Œä»è€Œæ˜¾ç€é™ä½æ€»ä½“ååé‡

### Avoiding Data Hazards by Forwarding

å½“å‘ç”Ÿæ•°æ®ä¾èµ–æ—¶ï¼Œé™¤äº†ä½¿ç”¨`Stalling`æŠ€æœ¯æš‚åœæµæ°´ä»¥å¤–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨`Forwarding`å‰é€’æŠ€æœ¯æ¥å°†è¦å†™åˆ°æŸæ¡å¯„å­˜å™¨ä¸­çš„ç»“æœç›´æ¥é€åˆ°éœ€è¦è¯¥å¯„å­˜å™¨çš„æŒ‡ä»¤çš„å–æ“ä½œæ•°IDé˜¶æ®µï¼Œå¦‚ä¸‹å›¾ï¼š

![](image/image_-SsAFITf_S.png)

ä½¿ç”¨å‰é€’æŠ€æœ¯å¯ä»¥ç›´æ¥å°†EXé˜¶æ®µäº§ç”Ÿçš„`e_valE`[^æ³¨é‡Š13]ã€MEMæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„`M_valE`ã€MEMé˜¶æ®µäº§ç”Ÿçš„`m_valM`å’ŒWBæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„`W_valE`å’Œ`W_valM`ä¼ é€’ç»™Eæµæ°´çº¿å¯„å­˜å™¨çš„valAæˆ–valB

è‡³äºIDé˜¶æ®µæ˜¯å¦‚ä½•ç¡®å®švalAã€valBæ˜¯é€‰æ‹©å¯„å­˜å™¨æ–‡ä»¶ä¸­çš„å€¼è¿˜æ˜¯Forwardçš„å€¼ï¼Œé‡‡ç”¨çš„æ–¹æ³•æ˜¯æ¯”è¾ƒsrcAã€srcBå’Œå„ä¸ªæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„dstEã€dstM

å…·ä½“ä½¿ç”¨ForwardæŠ€æœ¯è§£å†³æ•°æ®å†’é™©çš„å¤„ç†å™¨`PIPE`[^æ³¨é‡Š14]ç¡¬ä»¶ç»“æ„å›¾å¦‚ä¸‹ï¼š

![](image/image_iAYjnRwk9V.png)

### Load/Use Data Hazards

ä½†æ˜¯éœ€è¦æ³¨æ„ä¸€ä¸ªç‰¹æ®Šæƒ…å†µï¼š**ä»å†…å­˜ä¸­è¯»å‡ºçš„æ•°æ®æ˜¯éœ€è¦åœ¨MEMé˜¶æ®µæ‰äº§ç”Ÿçš„m\_valM**ã€‚å› æ­¤å¦‚æœæ˜¯ä¸¤æ¡ç´§é‚»çš„æŒ‡ä»¤iå’Œjä¸”iæ˜¯ä¸€ä¸ªloadæŒ‡ä»¤ï¼ŒjæŒ‡ä»¤éœ€è¦ç”¨åˆ°iæŒ‡ä»¤è¯»å‡ºçš„ç»“æœï¼Œé‚£ä¹ˆå°±å¿…é¡»ä½¿ç”¨`stalling+forward`ç»“åˆçš„æŠ€æœ¯æ¥æœ€å¤§åŒ–ååç‡ï¼Œå³æš‚åœIDé˜¶æ®µæŒ‡ä»¤jä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œè‡³æŒ‡ä»¤iå·²åœ¨MEMé˜¶æ®µæ—¶æ‰å°†m\_valMä¼ é€’åˆ°valAæˆ–valBï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚ç›¸é‚»2ã€3ä¸ªæŒ‡ä»¤çš„loadå°±å¹¶ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜

![](image/image_Jhse1xCpQj.png)

è¿™ç§`stalling+forward`ç»“åˆçš„æŠ€æœ¯ç§°ä¸ºâ€œ`load interlock`â€

### Avoiding Control Hazards

> *Control hazards arise when the processor cannot reliably determine the address of the next instruction based on the current instruction in the fetch stage*

æ­£å¦‚4.5.4 Next PC Predictionè®¨è®ºçš„ï¼Œåœ¨PIPEçš„è®¾è®¡ä¸­åªæœ‰retæŒ‡ä»¤å’Œé¢„æµ‹å¤±è´¥çš„jumpæŒ‡ä»¤æ‰ä¼šå¯¼è‡´æ§åˆ¶å†’é™©

1.  retæŒ‡ä»¤

    ![](image/image_HcyRBb6EIy.png)

    å½“IDé˜¶æ®µæ£€æµ‹åˆ°å½“å‰æŒ‡ä»¤æ˜¯ä¸€æ¡retæŒ‡ä»¤æ—¶ï¼Œå³é˜»å¡IFå–æŒ‡é˜¶æ®µã€‚ä¸€æ—¦retæŒ‡ä»¤åˆ°è¾¾WBé˜¶æ®µï¼Œå³å·²ç»é€šè¿‡MEMæ®µå¾—åˆ°äº†è¿”å›åœ°å€ï¼Œå³å¯ä»¥é€šè¿‡PCé€‰æ‹©å™¨æ¥ä»è¿”å›åœ°å€å¤„å–PCé‡æ–°å¼€å§‹æ‰§è¡Œ
2.  é¢„æµ‹å¤±è´¥çš„jumpæŒ‡ä»¤

    ![](image/image_n9AYhR0Bfc.png)

    è™½ç„¶æ˜¯æŒ‰ç…§é¢„æµ‹åˆ†æ”¯æˆåŠŸæ˜¯å–åˆ†æ”¯ç›®æ ‡å¤„çš„æŒ‡ä»¤ï¼Œä½†æ˜¯åœ¨å®é™…åˆ†æ”¯ç»“æœåœ¨EXEé˜¶æ®µå¾—åˆ°æ—¶ï¼Œåªå–å‡ºäº†ä¸¤æ¡åˆ†æ”¯ç›®æ ‡å¤„çš„æŒ‡ä»¤ä¸”å¹¶æœªå¯¹å¤„ç†å™¨çŠ¶æ€ï¼ˆCSRã€MEMã€REGï¼‰è¿›è¡Œä¿®æ”¹[^æ³¨é‡Š15]ï¼Œå› æ­¤åªéœ€è¦å–æ¶ˆ[^æ³¨é‡Š16]æ‰€å–å‡ºçš„ä¸¤æ¡åˆ†æ”¯ç›®æ ‡å¤„æŒ‡ä»¤ï¼Œé‡æ–°ä»åˆ†æ”¯æŒ‡ä»¤ä¹‹åå¼€å§‹å–æŒ‡

## 4.5.6 Exception Hanlling

#### Brief Introduction

å¤„ç†å™¨ä¸­çš„è®¸å¤šæ´»åŠ¨éƒ½å¯ä»¥å¯¼è‡´å¼‚å¸¸çš„æ§åˆ¶æµï¼Œä»è€Œç ´åæ­£å¸¸çš„ç¨‹åºæ‰§è¡Œé“¾

å¼‚å¸¸å¯ä»¥æ˜¯å†…éƒ¨çš„â€”â€”ç”±æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºæ‰€å¼•èµ·ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤–éƒ¨çš„â€”â€”ç”±ä¸€äº›é¢å¤–çš„ä¿¡å·å¼•èµ·

ä¸€èˆ¬å†…éƒ¨çš„ç§°ä¹‹ä¸ºå¼‚å¸¸ï¼Œå¤–éƒ¨çš„ç§°ä¹‹ä¸ºä¸­æ–­

å°†é€ æˆå¼‚å¸¸çš„æŒ‡ä»¤ç§°ä¸º**å¼‚å¸¸æŒ‡ä»¤**`Excepting instruction`

#### Exception in Y86-64

Y86-64æŒ‡ä»¤é›†æ¶æ„åªå®ç°äº†3ç§å†…éƒ¨å¼‚å¸¸ï¼š`haltæŒ‡ä»¤`ï¼›ä¸åˆæ³•çš„æŒ‡ä»¤[^æ³¨é‡Š17]ï¼›æ— æ•ˆçš„åœ°å€[^æ³¨é‡Š18]

åœ¨Y86-64ä¸­ï¼Œå½“é‡åˆ°å¼‚å¸¸æ—¶ï¼Œå¤„ç†å™¨æ‰€é‡‡ç”¨çš„åšæ³•æ˜¯æš‚åœå¤„ç†å™¨æ­£åœ¨æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œå¹¶æŒ‰ç…§[ğŸ–¼ï¸ å›¾ç‰‡](image/image_dJUDcQvruB.png "ğŸ–¼ï¸ å›¾ç‰‡")è®¾ç½®æ°å½“çš„çŠ¶æ€ç ã€‚ä½†æ˜¯åœ¨æ›´å®Œæ•´çš„å¤„ç†å™¨è®¾è®¡ä¸­ï¼Œå½“é‡åˆ°å¼‚å¸¸æ—¶é‡‡å–çš„æªæ–½æ˜¯æ‰§è¡Œé©»ç•™åœ¨æ“ä½œç³»ç»Ÿå†…æ ¸ä¸­çš„å¼‚å¸¸å¤„ç†ç¨‹åºï¼Œå¼‚å¸¸å¤„ç†ç¨‹åºå®Œæˆä»¥åå†å›åˆ°å¼‚å¸¸æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ç»§ç»­æ‰§è¡Œ

#### Exception handling in pipelined system

1.  å¯èƒ½åŒæ—¶æœ‰å¤šä¸ªæŒ‡ä»¤å¼•èµ·å¼‚å¸¸ï¼Œå¿…é¡»å†³å®šå¤„ç†å™¨ä¼˜å…ˆå“åº”å“ªæ¡æŒ‡ä»¤å¼•èµ·çš„å¼‚å¸¸

    ç”±äºæ˜¯é‡‡ç”¨æµæ°´çº¿æŠ€æœ¯ï¼Œå¾…æµæ°´çº¿ç¨³å®šåï¼ŒåŒä¸€æ—¶é’Ÿå‘¨æœŸå¯èƒ½ä¼šæœ‰å¤šæ¡æŒ‡ä»¤æ­£åœ¨è¿è¡Œï¼Œå› æ­¤å¯èƒ½ä¼šæœ‰å¤šæ¡æŒ‡ä»¤å¼•èµ·å¼‚å¸¸ã€‚egï¼šå–æŒ‡é˜¶æ®µå–å‡ºhaltæŒ‡ä»¤ï¼Œä½†è®¿å­˜é˜¶æ®µçš„æŒ‡ä»¤çš„è®¿å­˜åœ°å€æ˜¯è¶Šç•Œçš„

    å› æ­¤å¿…é¡»å†³å®šå“ªä¸€ä¸ªå¼‚å¸¸ä¼˜å…ˆå¾—åˆ°å¤„ç†å™¨å‘æ“ä½œç³»ç»Ÿæå‡ºå¼‚å¸¸å¤„ç†è¯·æ±‚

    åŸºæœ¬è§„åˆ™æ˜¯ï¼š**ä¼˜å…ˆå¤„ç†æµæ°´çº¿æ·±åº¦æœ€æ·±çš„æŒ‡ä»¤å¼•èµ·çš„å¼‚å¸¸**ã€‚ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œå…ˆå¤„ç†invalid addresså¼‚å¸¸
2.  é‡‡ç”¨åˆ†æ”¯é¢„æµ‹æŠ€æœ¯ä¸”æ€»é¢„æµ‹åˆ†æ”¯æˆåŠŸï¼Œåˆ™ä¼šæœ‰å¦‚æœåˆ†æ”¯ç›®çš„å¤„æŒ‡ä»¤å¼•èµ·å¼‚å¸¸ï¼Œä½†æ˜¯è‹¥åˆ†æ”¯é¢„æµ‹å¤±è´¥ï¼Œéœ€è¦ç»§ç»­æ‰§è¡Œåˆ†æ”¯æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆåˆ†æ”¯ç›®æ ‡åœ°å€å¤„æ‰€æ‰§è¡Œçš„æŒ‡ä»¤åº”è¯¥å–æ¶ˆï¼Œæ‰€é€ æˆçš„å¼‚å¸¸ä¹Ÿéœ€è¦é¿å…å‡ºç°

    ![](image/image_Kx2bbSPsqe.png)

    targetå¤„æ˜¯ä¸€ä¸ªinvalid instructionï¼Œä½†æ˜¯å®é™…ä¸Šjneå¹¶ä¸è·³è½¬ï¼Œå› æ­¤targetå¤„æŒ‡ä»¤å¹¶ä¸ä¼šæ‰§è¡Œï¼Œå› æ­¤éœ€è¦é¿å…å¼‚å¸¸çš„å‡ºç°
3.  ç”±äºæµæ°´çº¿å¤„ç†å™¨åœ¨ä¸åŒé˜¶æ®µæ›´æ–°ç³»ç»ŸçŠ¶æ€çš„ä¸åŒéƒ¨åˆ†ï¼Œæ‰€ä»¥å¼‚å¸¸æŒ‡ä»¤åé¢çš„æŒ‡ä»¤æœ‰å¯èƒ½åœ¨å¼‚å¸¸æŒ‡ä»¤å®Œæˆä¹‹å‰æ”¹å˜éƒ¨åˆ†çŠ¶æ€

    ![](image/image_ZAiZ5fNhXR.png)

    å‡è®¾ä¸å…è®¸ç¨‹åºè®¿é—®å¤§äº64ä½åœ°å€èŒƒå›´çš„é«˜ä½åœ°å€éƒ¨åˆ†å³$2^{32}-1\dots2^{64}-1$

    %rspä¼šç½®ä¸º0ï¼Œpushqä¿å­˜æ˜¯å°è¯•å»å†™-8å³0xfffffffffffffff8çš„å†…å­˜åœ°å€ï¼Œè¯¥åœ°å€æ˜¯ä¸å…è®¸è®¿é—®çš„ä¼šå¼•èµ·invalid addresså¼‚å¸¸ï¼›å¼‚å¸¸æ—¶çš„CCæ˜¯100ï¼Œä½†æ˜¯ç”±äºè®¿å­˜æ—¶æ˜¯åœ¨MEMæ®µï¼Œaddqå·²è¾¾EXEæ®µï¼Œä¼šæ›´æ”¹CCä¸º000ï¼Œå¯¼è‡´ç¨‹åºçŠ¶æ€å‘ç”Ÿæ”¹å˜

> âœ¨ä¸€èˆ¬æ¥è¯´ï¼Œé€šè¿‡å°†å¼‚å¸¸å¤„ç†é€»è¾‘åˆå¹¶åˆ°æµæ°´çº¿ç»“æ„ä¸­å°±å¯ä»¥æ­£ç¡®åœ°åœ¨å¤šä¸ªå¼‚å¸¸ä¸­åšå‡ºé€‰æ‹©[^æ³¨é‡Š19]ï¼Œä¹Ÿèƒ½å¤Ÿé¿å…å‡ºç°ç”±äºåˆ†æ”¯é¢„æµ‹é”™è¯¯å–å‡ºçš„æŒ‡ä»¤é€ æˆçš„å¼‚å¸¸ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆPIPE-å’ŒPIPEç»“æ„ä¸­çš„æµæ°´çº¿å¯„å­˜å™¨åŒ…å«çŠ¶æ€ç statå­—æ®µ
>
> å¦‚æœä¸€æ¡æŒ‡ä»¤åœ¨å…¶æ‰§è¡Œçš„è¿‡ç¨‹äºæŸä¸ªé˜¶æ®µäº§ç”Ÿäº†å¼‚å¸¸ï¼Œé‚£ä¹ˆå½“å‰æŒ‡ä»¤æ‰€è¦ä¼ é€’çš„ä¸‹ä¸€ä¸ªæµæ°´çº¿å¯„å­˜å™¨çš„statå°±è¢«è®¾ç½®ä¸ºæŒ‡ç¤ºå¼‚å¸¸çš„ç§ç±»
>
> statå’Œè¯¥æŒ‡ä»¤çš„å…¶ä»–ä¿¡æ¯ä¸€èµ·æ²¿ç€æµæ°´çº¿ä¼ æ’­ï¼Œç›´åˆ°å®ƒåˆ°è¾¾å†™å›é˜¶æ®µï¼Œæ­¤æ—¶æ‰§è¡Œå®Œæ¯•ï¼Œè½¬å»æš‚åœæˆ–è€…æ‰§è¡Œå¼‚å¸¸å¤„ç†ç¨‹åº
>
> è€Œä¸ºäº†é¿å…å¼‚å¸¸æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤æ›´æ–°ç¨‹åºå‘˜å¯è§çŠ¶æ€ï¼Œå½“MEMæˆ–WBé˜¶æ®µä¸­çš„æŒ‡ä»¤å¼•èµ·å¼‚å¸¸æ—¶ï¼Œæµæ°´çº¿æ§åˆ¶é€»è¾‘å¿…é¡»ç¦ç”¨æ¡ä»¶ä»£ç å¯„å­˜å™¨æˆ–æ•°æ®å­˜å‚¨å™¨çš„ä»»ä½•æ›´æ–°

> âœ¨å½“æµæ°´çº¿ä¸­æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªé˜¶æ®µå‡ºç°å¼‚å¸¸æ—¶ï¼Œå­˜å‚¨å¼‚å¸¸Statåˆ°æµæ°´çº¿å¯„å­˜å™¨ä¸­ã€‚ç›´åˆ°æœ‰å¼‚å¸¸æŒ‡ä»¤åˆ°è¾¾WBé˜¶æ®µæ—¶ï¼Œé™¤äº†ä¼šç¦æ­¢å¼‚å¸¸æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤å¯¹ç¨‹åºå‘˜å¯è§çŠ¶æ€çš„æ›´æ–°å¤–å¹¶ä¸ä¼šå†å¯¹æµæ°´çº¿ä¸­çš„æŒ‡ä»¤æœ‰ä»»ä½•å½±å“ã€‚å› æ­¤æŒ‡ä»¤åˆ°è¾¾å†™å›é˜¶æ®µçš„é¡ºåºä¸å®ƒä»¬åœ¨éæµæ°´çº¿åŒ–çš„å¤„ç†å™¨ä¸­æ‰§è¡Œçš„é¡ºåºç›¸åŒï¼Œä¹Ÿå› æ­¤ç¬¬ä¸€æ¡é‡åˆ°å¼‚å¸¸çš„æŒ‡ä»¤ä¼šç¬¬ä¸€ä¸ªåˆ°è¾¾å†™å›é˜¶æ®µ[^æ³¨é‡Š20]ï¼Œæ­¤æ—¶ç¨‹åºæ‰§è¡Œä¼šåœæ­¢ï¼Œæµæ°´çº¿å¯„å­˜å™¨Wä¸­çš„çŠ¶æ€ç ä¼šè¢«è®°å½•ä¸ºç¨‹åºçš„StatçŠ¶æ€ã€‚å¦‚æœå–å‡ºäº†æŸæ¡æŒ‡ä»¤ï¼Œè¿‡ååˆå–æ¶ˆäº†ï¼Œé‚£ä¹ˆæ‰€æœ‰å…³äºè¿™æ¡æŒ‡ä»¤çš„å¼‚å¸¸çŠ¶æ€ä¿¡æ¯ä¹Ÿéƒ½ä¼šè¢«å–æ¶ˆ[^æ³¨é‡Š21]ã€‚æ‰€æœ‰å¯¼è‡´å¼‚å¸¸çš„æŒ‡ä»¤åé¢çš„æŒ‡ä»¤éƒ½ä¸èƒ½æ”¹å˜ç¨‹åºå‘˜å¯è§çš„çŠ¶æ€[^æ³¨é‡Š22]

## 4.5.7 PIPE Stage Implementations

PIPEä¸­çš„è®¸å¤šé€»è¾‘å—çš„è®¾è®¡æ˜¯ç­‰åŒäºSEQå’ŒSEQ+çš„ï¼Œé™¤äº†**åœ¨ä¿¡å·ä¸Šé¢éœ€è¦åŠ ä¸Šå‰ç¼€**ï¼Œè¡¨ç¤ºä¿¡å·æ˜¯æ¥è‡ªæµæ°´çº¿å¯„å­˜å™¨â€œå¤§å†™Fã€Dã€Eã€Mã€Wâ€è¿˜æ˜¯æµæ°´çº¿é˜¶æ®µâ€œå°å†™fã€dã€eã€mã€wâ€ä¸­äº§ç”Ÿçš„

### PC Selection and Fetch Stage

![](image/image_sApn-zLaGA.png)

ä¸Šå›¾çš„Figure4.57å±•ç¤ºäº†PIPEå–æŒ‡é˜¶æ®µçš„è¯¦ç»†é€»è¾‘

**PIPEçš„å–æŒ‡é˜¶æ®µéœ€è¦åœ¨**\*\*`predPC`****ã€****`åˆ†æ”¯é¢„æµ‹å¤±è´¥çš„M_valA`****å’Œ****`retçš„W_valM`****ä¸­é€‰æ‹©äº§ç”Ÿå½“å‰çš„PCå€¼ï¼Œå¹¶åœ¨****`valP`****å’Œ****`valC`\*\***ä¸­é¢„æµ‹äº§ç”Ÿä¸‹ä¸€ä¸ªPC**

```c
word f_pc = [
  M_icode==IJXX &&!M_Cnd:M_valA; #åˆ†æ”¯é¢„æµ‹å¤±è´¥
  W_icode==IRET:W_valM; #retæŒ‡ä»¤
  1:F_preadPC
];
word f_predPc= [
  f_icode in {IJXX,ICALL}:f_valC; #å½“å‰æŒ‡ä»¤æ˜¯åˆ†æ”¯æŒ‡ä»¤æˆ–CallæŒ‡ä»¤
  1:f_valP;
];

```

æ­¤å¤–PIPEä¹Ÿéœ€è¦åƒSEQä¸€æ ·å®Œæˆå¯¹Need valCã€Need regidså’ŒInstr validä»¥åŠStatæ§åˆ¶é€»è¾‘çš„ç”Ÿæˆ

need\_valCå’Œneed\_regidsçš„é€»è¾‘åŒSEQã€åªéœ€è¦æ”¹å˜ä¿¡å·åå³å¯

Statçš„è®¡ç®—å¿…é¡»åˆ†æˆä¸¤éƒ¨ï¼šå¯¹haltã€æ— æ•ˆæŒ‡ä»¤ä»¥åŠæŒ‡ä»¤å–æŒ‡çš„å¼‚å¸¸æ£€æµ‹åœ¨IFé˜¶æ®µå³å¯å®Œæˆï¼›ä½†æ˜¯å¯¹è¯»å†™æ•°æ®åœ°å€çš„å¼‚å¸¸å¿…é¡»åœ¨EXEé˜¶æ®µæ‰å¯å®Œæˆ

```c
//need_valCè¡¨ç¤ºæœ‰8å­—èŠ‚å¸¸æ•°
bool f_need_valC = f_icode in {IIRMOVQ,IRMMOVQ,IMRMOVQ,IJXX,ICALL};

//need_regidsè¡¨ç¤ºæœ‰å¯„å­˜å™¨æŒ‡ç¤ºç¬¦å­—èŠ‚
bool f_need_regids = f_icode in { IRRMOVQ, IOPQ, IPUSHQ, IPOPQ, IIRMOVQ, IRMMOVQ, IMRMOVQ };

//f_instr_validè¡¨ç¤ºficodeæœ‰æ•ˆ
bool f_instr_valid = f_icode in {IOPQ,IRRMOVQ,IIRMOVQ,IRMMOVQ,IMRMOVQ,IJXX,ICALL,IRET,IPUSHQ,IPOPQ,IHALT};

//f_statåˆ†ä¸ºä¸¤é˜¶æ®µè®¡ç®—
bool f_imem_error=f_pc>å€¼;
word f_stat= [
  f_icode==IHALT:HLT;
  f_imem_error:ADR;
  !f_instr_valid:INS;
  1:AOK;
];//è¿˜æ— æ³•åˆ¤æ–­è®¿æ•°æ®åœ°å€æ˜¯å¦é”™è¯¯

//PC_increment
word f_valP= f_pc+1+f_need_regids+f_need_valC*8;
word f_valC= f_instr[f_pc+1+f_need_regids:f_pc+1+f_need_regids+8];
```

### Decode and Write-Back Stages

![](image/image_e-IRsK-MJL.png)

ä¸Šå›¾Figure4.58å±•ç¤ºäº†IDå’ŒWBé˜¶æ®µçš„è¯¦ç»†é€»è¾‘å›¾

dstEã€dstMã€srcAã€srcBçš„äº§ç”Ÿé€»è¾‘å’ŒSEQæ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œåªéœ€è¦ä¿¡å·å‰ç¼€å³å¯

```c
//4ä½çš„æ•°æ®é‡ç§°ä¸ºword
word d_srcA={
  D_icode in {IRRMOVQ,IRMMOVQ,IOPQ,IPUSHQ} : D_rA;
  D_icode in {IRET,IPOPQ} : 0x4;//0x4ä¸º%rspçš„ç¼–å·
  1 : 0xF;  
};//åªæ˜¯éœ€è¦è¯»rAå¯„å­˜å™¨çš„æŒ‡ä»¤
word d_srcB={
  D_icode in {IRMMOVQ,IMRMOVQ,IOPQ} : D_rB;
  D_icode in {IPUSHQ,IPOPQ,ICALL,IRET} : 0x4;
  1 : 0xF;
};//åªæ˜¯éœ€è¦è¯»rBå¯„å­˜å™¨çš„æŒ‡ä»¤
word d_dstE={
  D_icode in {IOPQ,IIRMOVQ,IRRMOVQ} : D_rB;
  D_icode in {IPUSHQ,IPOPQ,ICALL,IRET} : 0x4;
  1 : 0xF;
};//å†™ALUç»“æœçš„æŒ‡ä»¤
word d_dstM={
  D_icode in {IMRMOVQ,IPOPQ} : D_rA;
  1 : 0xF;
};//å†™MEMç»“æœçš„æŒ‡ä»¤
```

"Sel+Fwd A"æ§åˆ¶é€»è¾‘å……å½“ä¸¤ä¸ªä½œç”¨ï¼š

1.  åœ¨å¯„å­˜å™¨è¯»å‡ºçš„valAå’ŒPCå¢é‡valPä¸­é€‰æ‹©ä¸€ä¸ª

    åªæœ‰callæŒ‡ä»¤å’ŒjumpæŒ‡ä»¤éœ€è¦ä½¿ç”¨valPï¼Œå…¶ä½™çš„éƒ½æ˜¯ä½¿ç”¨æ“ä½œæ•°
2.  å‰é€’äº§ç”Ÿçš„æ“ä½œæ•°

    åé¦ˆå¾—åˆ°çš„å€¼åŒ…æ‹¬ï¼še\_valE,M\_valE,m\_valM,W\_valEå’ŒW\_valM

    éœ€è¦æ¯”è¾ƒd\_srcAå’Œd\_srcBå’Œe\_dstE[^æ³¨é‡Š23]ã€M\_dstEã€M\_dstMã€W\_dstEã€W\_dstM

    å‰é€’çš„ä¼˜å…ˆçº§æ˜¯ï¼šE>M>Wï¼ŒåŒä¸€é˜¶æ®µå†…çš„è®¿å­˜å’Œæ‰§è¡Œçš„ç»“æœé¡ºåºæ˜¯æ ¹æ®`popq %rsp`çš„ç»“æœï¼Œå®ƒçš„æœ€åç»“æœæ˜¯è®¿å­˜çš„ç»“æœã€‚å› æ­¤æ˜¯è®¿å­˜ä¼˜äºæ‰§è¡Œï¼›

```c
word d_valA = [
  D_icode in [ICALL,IJXX]:D_valP;
  d_srcA==e_dstE:e_valE;
  d_srcA==M_dstM:m_valM;
  d_srcA==M_dstE:M_valE;
  d_srcA==W_dstM:W_valM;
  d_srcA==W_dstE:W_valE;
  1:d_rvalA;
];
word d_valB = [
  d_srcB==e_dstE:e_valE;
  d_srcB==M_dstM:m_valM;
  d_srcB==M_dstE:M_valE;
  d_srcB==W_dstM:W_valM;
  d_srcB==W_dstE:W_valE;
  1:d_rvalB;
];
```

æ­¤å¤–ä¹‹å‰åœ¨4.5.6ä¸­æåˆ°å†™å›é˜¶æ®µéœ€è¦å°†Wæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„Statæ›´æ–°åˆ°ç¨‹åºçš„Statå¯„å­˜å™¨ä¸­ã€‚å› ä¸ºWBé˜¶æ®µçš„å†’æ³¡ä¹Ÿæ˜¯æ­£å¸¸æ“ä½œçš„ä¸€ç§ï¼Œå› æ­¤å…¶HCLå¦‚ä¸‹ï¼š

```c
word Stat=[
  W_stat==BUB:AOK;
  1:W_stat;
];
```

æœ€åéœ€è¦å®ä¾‹åŒ–å¯„å­˜å™¨æ–‡ä»¶

```c
regfile regfile_init(
  .clk(clk),
  .srcA(d_srcA),
  .srcB(d_srcB),
  .A(d_rvalA),
  .B(d_rvalB),
  .dstE(W_dstE),
  .dstM(W_dstM),
  .E(W_valE),
  .M(W_valM)
);
```

### Execute Stage

![](image/image_M7qTBR52tc.png)

ä¸Šå›¾Figure4.60å±•ç¤ºäº†PIPEæ‰§è¡Œé˜¶æ®µçš„å…·ä½“æµç¨‹

PIPEæ‰§è¡Œé˜¶æ®µçš„æ§åˆ¶é€»è¾‘å’ŒSEQå‡ ä¹ä¸€æ ·ï¼Œä¸åŒç‚¹åœ¨äºï¼š

1.  e\_valEå’Œe\_dstEéœ€è¦å‰é€’åˆ°IDé˜¶æ®µ
2.  setCCç»„åˆé€»è¾‘éœ€è¦ç»“åˆMEMã€WBæ®µæ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿæ¥å†³å®šæ˜¯å¦å¯¹CCè¿›è¡Œæ›´æ–°

    CCåªä¼šåœ¨EXEé˜¶æ®µè¿›è¡Œæ›´æ–°ï¼Œè€ŒEXEé˜¶æ®µæ‰§è¡Œçš„æŒ‡ä»¤ï¼ˆIDæ£€æµ‹åˆ°çš„å¼‚å¸¸æŒ‡ä»¤å¹¶ä¸ä¼šæ›´æ–°CCï¼‰å¹¶ä¸ä¼šå¼•å‘æ–°çš„å¼‚å¸¸ï¼Œå› æ­¤åªéœ€è¦åˆ¤æ–­MEM[^æ³¨é‡Š24]ã€WBé˜¶æ®µæ˜¯å¦æœ‰å¼‚å¸¸æŒ‡ä»¤ï¼Œä»è€Œåœæ­¢æ‰å¼‚å¸¸æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤å¯¹CCçš„æ›´æ–°

```c
e_aluA = [
  E_icode in {IOPQ,IRRMOVQ}:E_valA;
  E_icode in {IIRMOVQ,IRMMOVQ,IMRMOVQ}:E_valC;
  E_icode in {IPUSHQ,ICALL}:-8;
  E_icode in {IPOPQ,IRET}:8;
];

e_aluB = [
  E_icode in {IOPQ,IRMMOVQ,IMRMOVQ,IPUSHQ,ICALL,IPOPQ,IRET}:E_valB;
  E_icode in {IRRMOVQ,IIRMOVQ}:0;
];

e_alufun = [
  E_icode==IOPQ:E_ifunc;
  1:ADD;
];

e_dstE = [
  E_icode==IRRMOVQ&&~e_cnd:0xF;
  1:E_dstE;//irrmovqçš„Cndä¸€å®šä¸º1ï¼Œè€Œccmovçš„Cndéœ€è¦æ ¹æ®æ¡ä»¶åˆ¤æ–­
];

bool e_setCC= E_icode==IOPQ && !m_stat in {ADR,INS,HLT} && !W_stat in {ADR,INS,HLT};

//zf of sf
e_cc_enable = [
  e_setCC:æ ¹æ®e_aluEè®¾ç½®e_cc;
  1:ä¸æ›´æ–°CC;
];

e_cnd = [
  E_ifunc==0:1;
  E_ifunc==1&&((e_cc[2]^e_cc[1])||e_cc[0]);//<=
  E_ifunc==2&&e_cc[2]^e_cc[1];//<
  E_ifunc==3&&e_cc[2];//==
  E_ifunc==4&&!e_cc[2];//!=
  E_ifunc==5&&!(e_cc[2]^e_cc[1]); //>=
  E_ifunc==6&&!((e_cc[2]^e_cc[1])||e_cc[0]); //>
  1:0;
];

```

å®ä¾‹åŒ–ALU

```c
alu alu_init(
  .alua(e_aluA),
  .alub(e_aluB),
  .alufunc(e_alufunc),
  .cc(e_cc),
  .alures(e_valE)
);
```

### Memory Stage

![](image/image_80h4YqUg-M.png)

ä¸Šå›¾Figure4.61å±•ç¤ºäº†PIPEä¸­çš„è®¿å­˜é˜¶æ®µ

å’ŒSEQçš„MEMæ®µæ¯”è¾ƒï¼Œå¯ä»¥çœ‹åˆ°æ­£å¦‚ä¹‹å‰æ‰€è¿°çš„ä¸ºä»€ä¹ˆè¦åœ¨IDæ®µselAçš„åŸå› ï¼Œè¿™é‡Œä¸å†éœ€è¦ä¼ é€’æ›´å¤šçš„ä¿¡å·ä¹Ÿä¸éœ€è¦ä½¿ç”¨SEQä¸­çš„MEM.dataæ§åˆ¶é€»è¾‘[^æ³¨é‡Š25]

åœ¨MEMé˜¶æ®µï¼Œéœ€è¦æ ¹æ®icodeåˆ¤æ–­readè¿˜æ˜¯writeï¼›ä¹Ÿéœ€è¦å¯¹è®¿é—®å†…å­˜çš„åœ°å€è¿›è¡Œåˆ¤æ–­ä»è€Œå¯¹Statè¿›è¡Œæ›´æ–°

```c
m_read = M_icode in {IMRMOVQ,IPOPQ,IRET};

m_write = M_icode in {IRMMOVQ,IPUSHQ,ICALL}

m_stat = [
   dmem_error:ADR;
   1:M_stat;
];

```

### Pipeline Control Logic

**æµæ°´çº¿æ§åˆ¶é€»è¾‘å¿…é¡»å¤„ç†æ¥ä¸‹æ¥****å››ç§æ§åˆ¶æƒ…å†µ****ï¼Œè¿™å››ç§æƒ…å†µæ˜¯æµæ°´çº¿æœºåˆ¶ï¼ˆæ¯”å¦‚å‰é€’ã€åˆ†æ”¯é¢„æµ‹ï¼‰ä¸èƒ½å¤„ç†çš„**

1.  Load/use hazards

    å½“IDé˜¶æ®µæ£€æµ‹åˆ°å½“å‰æŒ‡ä»¤ä¸å…¶ä¸Šä¸€æ¡æŒ‡ä»¤å­˜åœ¨æ•°æ®ä¾èµ–[^æ³¨é‡Š26]ï¼Œä¸”ä¸Šä¸€æ¡æŒ‡ä»¤æ˜¯LoadæŒ‡ä»¤ï¼Œé‚£ä¹ˆæµæ°´çº¿å¿…é¡»æš‚åœä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸ
2.  Processing ret

    å½“IDé˜¶æ®µæ£€æµ‹åˆ°å½“å‰æŒ‡ä»¤æ˜¯retæŒ‡ä»¤ï¼Œåˆ™å¿…é¡»é˜»å¡æµæ°´çº¿åˆ°retè¾¾åˆ°WBé˜¶æ®µ
3.  Mispredicted branches

    å½“åˆ†æ”¯é€»è¾‘æ£€æµ‹åˆ°ä¸åº”è¿›è¡Œè·³è½¬æ—¶ï¼Œå¿…é¡»å–æ¶ˆåˆ†æ”¯ç›®æ ‡å¤„æ‰€å–å‡ºçš„ä¸¤æ¡æŒ‡ä»¤ï¼Œå¹¶ä¸”åº”å½“ä»è·³è½¬æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤å¼€å§‹å–æŒ‡
4.  Exception

    å½“ä¸€æ¡æŒ‡ä»¤å¯¼è‡´å¼‚å¸¸æ—¶ï¼Œç¦æ­¢å¼‚å¸¸æŒ‡ä»¤åç»­çš„æŒ‡ä»¤å¯¹ç¨‹åºå‘˜å¯è§çŠ¶æ€çš„æ›´æ–°ï¼Œå¹¶åœ¨å¼‚å¸¸æŒ‡ä»¤åˆ°è¾¾WBé˜¶æ®µååœæ­¢æµæ°´çº¿çš„æ‰§è¡Œ

#### Desired Handling for each of Special Control Cases

1.  Load/use hazards

    åªæœ‰mrmovqå’ŒpopqæŒ‡ä»¤éœ€è¦ä»MEMä¸­åŠ è½½æ•°æ®é€åˆ°å¯„å­˜å™¨ä¸­

    å› æ­¤å½“IDé˜¶æ®µæ£€æµ‹åˆ°d\_srcAã€d\_srcBä¸­æœ‰å’ŒE\_dstMç›¸ç­‰çš„æƒ…å†µä¸”E\_icodeæ˜¯IMRMOVQæˆ–è€…IPOPQï¼Œé‚£ä¹ˆå–æ“ä½œæ•°çš„æŒ‡ä»¤å°±éœ€è¦æš‚åœåœ¨IDé˜¶æ®µï¼Œæ‰§è¡Œé˜¶æ®µæ‰§è¡Œbubble

    æš‚åœæµæ°´çº¿çš„æ–¹æ³•æ˜¯ï¼šä¿æŒFå¯„å­˜å™¨å€¼å’ŒDå¯„å­˜å™¨å€¼å›ºå®šï¼Œä»è€Œä½¿å¾—æµæ°´çº¿é˜»å¡
    > *In summary, implementing this pipeline flow requires detecting the hazard condition, keeping pipeline registers F and D fixed, and injecting a bubble into the execute stage.*
2.  Processing ret

    å½“IDé˜¶æ®µæ£€æµ‹åˆ°å½“å‰æŒ‡ä»¤æ˜¯retæŒ‡ä»¤æ—¶ï¼Œæµæ°´çº¿ä¼šé˜»å¡ç›´åˆ°retæŒ‡ä»¤å·²å®Œæˆè®¿å­˜åˆ°è¾¾WBé˜¶æ®µ

    ![](image/image_56XVSWyHjU.png)

    ä¸Šå›¾Figure4.62æ˜¯æµæ°´çº¿æ§åˆ¶é€»è¾‘å¤„ç†retæŒ‡ä»¤çš„è¯¦ç»†è¿‡ç¨‹ã€‚å¯ä»¥çœ‹åˆ°æ²¡æœ‰æ–¹æ³•å»åœ¨å–æŒ‡é˜¶æ®µæ’å…¥bubbleã€‚è€ŒretæŒ‡ä»¤æ‰€é¢„æµ‹å¾—åˆ°çš„pred\_PCæ˜¯valPï¼Œå› æ­¤ä¼šåœ¨retæŒ‡ä»¤åç»­æŒ‡ä»¤è¿ç»­å–æŒ‡åŒä¸€æ¡æŒ‡ä»¤ï¼Œä½†æ˜¯ä¸ºäº†ä¸æ‰§è¡Œå®ƒä»¬ï¼Œä¼šåœ¨è¿™äº›æŒ‡ä»¤çš„IDé˜¶æ®µæ’å…¥bubble
3.  Mispredicted branches

    å½“è·³è½¬æŒ‡ä»¤åˆ°è¾¾æ‰§è¡Œé˜¶æ®µæ—¶ï¼Œå°†æ£€æµ‹åˆ°é”™è¯¯é¢„æµ‹ã€‚ç„¶åï¼Œæ§åˆ¶é€»è¾‘åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸå°†bubbleæ³¨å…¥åˆ°è§£ç å’Œæ‰§è¡Œé˜¶æ®µï¼Œå¯¼è‡´ä¸¤æ¡é”™è¯¯è·å–çš„æŒ‡ä»¤è¢«å–æ¶ˆã€‚åœ¨åŒä¸€å‘¨æœŸï¼Œæµæ°´çº¿å°†æ­£ç¡®çš„æŒ‡ä»¤è¯»å…¥å–æŒ‡é˜¶æ®µ
4.  Exception

    Y86-64æ¶æ„ä¸­å¯¹å¼‚å¸¸æŒ‡ä»¤çš„å¤„ç†éœ€ä¸ISAæœŸæœ›çš„è¡Œä¸ºä¿æŒä¸€è‡´â€”â€”å¼‚å¸¸æŒ‡ä»¤ä¹‹å‰çš„æŒ‡ä»¤éƒ½å¯å®Œæˆæ‰§è¡Œï¼Œä½†æ˜¯å¼‚å¸¸æŒ‡ä»¤ä¹‹åçš„æŒ‡ä»¤ä¸èƒ½ä¿®æ”¹ç¨‹åºçŠ¶æ€

    ä½†æ˜¯ç”±äºY86-64å¼‚å¸¸çš„ä¿®æ”¹æ˜¯åœ¨å–æŒ‡å’Œè®¿å­˜é˜¶æ®µï¼Œä»¥åŠç¨‹åºçš„çŠ¶æ€åœ¨æ‰§è¡Œé˜¶æ®µã€è®¿å­˜é˜¶æ®µå’Œå†™å›é˜¶æ®µå‡ä¼šæ›´æ–°ï¼Œå› æ­¤è¦ä¸ISAä¿æŒä¸€è‡´æ˜¯æ¯”è¾ƒéš¾çš„

    å’Œä¹‹å‰çš„æè¿°ç›¸ä¸€è‡´ï¼Œå½“å¼‚å¸¸å‘ç”Ÿæ—¶ï¼Œè®°å½•å¼‚å¸¸æŒ‡ä»¤çš„ä¿¡æ¯å¹¶ç»§ç»­æ‰§è¡Œå¼‚å¸¸æŒ‡ä»¤ï¼Œå°†statæŒ‰ç…§æµæ°´çº¿ä¼ é€’ã€‚å½“å¼‚å¸¸æŒ‡ä»¤åˆ°è¾¾MEMé˜¶æ®µæ—¶ï¼Œç¦æ­¢EXEé˜¶æ®µä¸­çš„æŒ‡ä»¤æ›´æ”¹CCï¼›å‘å†…å­˜é˜¶æ®µä¸­æ’äººæ°”æ³¡ï¼Œä»¥ç¦æ­¢å‘æ•°æ®å†…å­˜ä¸­å†™å…¥ï¼›å½“å†™å›é˜¶æ®µä¸­æœ‰å¼‚å¸¸æŒ‡ä»¤æ—¶ï¼Œæš‚åœå†™å›é˜¶æ®µï¼Œå› è€Œæš‚åœäº†æµæ°´çº¿â€”â€”å³Stall WB+Bubble MEM

    ![](image/image_EMACIMrNij.png)

#### Detecting Special Control Conditions

![](image/image_W4aIdOT44F.png)

ä¸Šå›¾Figure4.64æ€»ç»“äº†éœ€è¦è¿›è¡Œç‰¹æ®Šæµæ°´çº¿æ§åˆ¶çš„æƒ…å†µ

Load/use hazard

```c
bool isload_hazard=E_code in {IMRMOVQ,IPOPQ} && (d_srcA==E_dstM||d_srcB==E_dstM);

```

Processign ret

```c
bool isRet=IRET in {D_icode,E_icode,M_icode};
```

Mispredicted branch

```c
bool isMisp=E_icode==IJXX&&!e_cnd;
```

Exception

```c
m_stat in {ADR,HLT,INS}||W_stat in {ADR,HLT,INS};
```

è¿™äº›æ£€æµ‹çš„æ§åˆ¶å—å¿…é¡»åœ¨æ—¶é’Ÿå‘¨æœŸç»“æŸä¹‹å‰ç”Ÿæˆå…¶ç»“æœï¼Œä»¥ä¾¿åœ¨æ—¶é’Ÿä¸Šå‡æ—¶æ§åˆ¶æµæ°´çº¿å¯„å­˜å™¨çš„æ“ä½œä»¥å¼€å§‹ä¸‹ä¸€ä¸ªå‘¨æœŸ

### Pipeline Control Mechanisms

![](image/image_0Q27JVfEHn.png)

ä¸Šå›¾Figure4.65å±•ç¤ºäº†å®ç°æµæ°´çº¿æ§åˆ¶é€»è¾‘å»æŠ‘åˆ¶ä¸€ä¸ªæµæ°´çº¿å¯„å­˜å™¨ä¸­çš„æŒ‡ä»¤æˆ–è€…æ˜¯åœ¨æµæ°´çº¿ä¸­æ’å…¥bubbleçš„æœºåˆ¶

**æµæ°´çº¿å¯„å­˜å™¨æœ‰ä¸¤ä¸ªæ§åˆ¶å¼•è„šstallå’Œbubbleï¼Œå½“æ—¶é’Ÿä¸Šå‡æ²¿å‡ºç°æ—¶ï¼Œstallé«˜æœ‰æ•ˆæ—¶å¯„å­˜å™¨çš„è¾“å‡ºä¿æŒä¸å˜ï¼›** â€‹**bubbleé«˜æœ‰æ•ˆæ—¶å¯„å­˜å™¨è¾“å‡ºæ˜¯æŸç§å¤ä½é…ç½®ï¼Œç­‰åŒäºnop**[^æ³¨é‡Š27]

é‚£ä¹ˆå¯ä»¥æ€»ç»“å››ç§ç‰¹æ®Šæƒ…å†µä¸‹çš„æµæ°´çº¿å¯„å­˜å™¨æ˜¯normalã€stallè¿˜æ˜¯bubbleçš„æƒ…å†µå¦‚ä¸‹â€”â€”ä¸‹ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸçš„æƒ…å†µ

| Condition           | Pipeline register |        |        |        |        |
| ------------------- | ----------------- | ------ | ------ | ------ | ------ |
|                     | F                 | D      | E      | M      | W      |
| Load/use hazard     | Stall             | Stall  | Bubble | Normal | Normal |
| Processing ret      | Stall             | Bubble | Normal | Normal | Normal |
| Mispredicted branch | Normal            | Bubble | Bubble | Normal | Normal |

> *In terms of timing, the stall and bubble control signals for the pipeline registers are generated by blocks of combinational logic. These values must be valid as the clock rises, causing each of the pipeline registers to either load, stall, or bubble as the next clock cycle begins.*

### Combinations of Control Conditions

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œå…³äºç‰¹æ®Šæµæ°´çº¿æ§åˆ¶æ¡ä»¶çš„è®¨è®ºéƒ½æ˜¯å‡è®¾ä»»ä½•ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…è‡³å¤šåªå‘ç”Ÿä¸€ä¸ªç‰¹æ®Šæƒ…å†µã€‚ä½†æ˜¯åœ¨å®é™…ç³»ç»Ÿä¸­ä¹Ÿä¼šå­˜åœ¨å¤šä¸ªç‰¹æ®Šæ¡ä»¶åŒæ—¶å‡ºç°çš„çŠ¶å†µ

ä¸‹é¢æ¥å¯¹å¤šä¸ªæ¡ä»¶åŒæ—¶å‡ºç°çš„çŠ¶å†µè¿›è¡Œåˆ†æ

1.  å•ç‹¬è®¨è®ºException

    å› ä¸ºY86-64å¯¹å¼‚å¸¸çš„å¤„ç†è®¾è®¡å·²ç»è®¤çœŸçš„è€ƒè™‘äº†æµæ°´çº¿ä¸­çš„å…¶ä»–æŒ‡ä»¤[^æ³¨é‡Š28]ï¼Œå› æ­¤ä¸å¿…æ‹…å¿ƒæ¶‰åŠåˆ°Exceptionçš„ç»„åˆ
2.  å…¶ä»–ä¸‰ç§æ¡ä»¶çš„ç»„åˆåˆ†æ

    load/use hazardå¿…é¡»æ»¡è¶³EXEé˜¶æ®µæ˜¯loadï¼Œè€ŒIDé˜¶æ®µæ˜¯use
    mispredicted branchå¿…é¡»æ»¡è¶³EXEé˜¶æ®µæ˜¯jump
    retæŒ‡ä»¤å¯ä»¥åœ¨IDã€EXEã€MEMï¼Œåªä¸è¿‡åœ¨EXEã€MEMçš„è¯ï¼Œå‰é¢éœ€è¦æ˜¯bubble

    å› æ­¤è¿™ä¸‰ç§æƒ…å†µçš„æ»¡è¶³æ¡ä»¶åˆ†æå›¾å¦‚ä¸‹ï¼š

    ![](image/image_Rk-91t-BrB.png)

    å°±ç»„åˆæ¥è¯´ï¼Œåªå­˜åœ¨load/useå’Œretåœ¨IDé˜¶æ®µçš„ç»„åˆBï¼Œä»¥åŠMispredictedå’Œretåœ¨IDé˜¶æ®µçš„ç»„åˆAè¿™ä¸¤ç§æƒ…å†µ
    1.  ç»„åˆA

        ç»„åˆAçš„å®ç°å³EXEæ®µæ˜¯ä¸€ä¸ªé¢„æµ‹å¤±è´¥çš„jumpï¼ŒIDé˜¶æ®µæ˜¯åˆ†æ”¯ç›®æ ‡å¤„çš„retæŒ‡ä»¤ï¼Œå› ä¸ºåˆ†æ”¯é¢„æµ‹å¤±è´¥æ‰€ä»¥è¯¥retæŒ‡ä»¤åº”è¯¥è¢«å–æ¶ˆ

        ç»„åˆæœŸå¾…çš„è¡Œä¸ºæ˜¯ï¼š

        ![](image/image_56FJebgmtB.png)

        å³æŒ‰ç…§Mispredictedçš„é€»è¾‘æ¥å¤„ç†ç»„åˆAï¼Œåªä¸è¿‡é˜»å¡Fé˜¶æ®µçš„å–æŒ‡ï¼›è€Œä¸‹ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸçš„PCå¹¶ä¸ä¼šé€‰æ‹©Få¯„å­˜å™¨ä¸­çš„pred\_PCè€Œæ˜¯é€‰æ‹©M\_valPï¼Œå› æ­¤å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆé”™è¯¯çš„å½±å“
    2.  ç»„åˆB

        ç»„åˆBçš„å®ç°å³loadä¿®æ”¹äº†%rspå¯„å­˜å™¨ï¼Œè€ŒretæŒ‡ä»¤éœ€è¦%rspå¯„å­˜å™¨è¯»å–æ ˆä¸­çš„è¿”å›åœ°å€ï¼Œå› æ­¤éœ€è¦æŠ‘åˆ¶retæŒ‡ä»¤

        ç»„åˆçš„æœŸå¾…è¡Œä¸ºæ˜¯ï¼šç”¨stall>bubble>normal

        ![](image/image_n4MBM0_NHR.png)

        ä¹‹å‰çš„PIPEè®¾è®¡å¹¶ä¸èƒ½æ­£ç¡®å¤„ç†è¿™ç§ç»„åˆï¼Œå®ƒä¼šå°†Då¯„å­˜å™¨çš„stallå’Œbubbleå‡è®¾ç½®ä¸º1ï¼Œå› æ­¤éœ€è¦ä¿®æ”¹PIPEè¿™æ–¹é¢çš„è®¾è®¡å®ç°ç»„åˆBçš„å¤„ç†

### Control Logic Implementation

![](image/image_DXrQlHN-oS.png)

ä¸Šå›¾Figure4.68å±•ç¤ºäº†æµæ°´çº¿æ§åˆ¶é€»è¾‘çš„æ•´ä½“ç»“æ„ã€‚åŸºäºæ¥è‡ªæµæ°´çº¿å¯„å­˜å™¨å’Œæµæ°´æ®µçš„ä¿¡å·ï¼Œæµæ°´çº¿æ§åˆ¶é€»è¾‘å¯ä»¥äº§ç”Ÿå„ä¸ªæµæ°´çº¿å¯„å­˜å™¨çš„stallå’Œbubbleä¿¡å·ï¼Œä¹Ÿå¯ä»¥å†³å®šæ˜¯å¦CCåº”è¯¥è¢«æ›´æ–°

å¯ä»¥ç»“åˆç‰¹æ®Šæƒ…å†µçš„æ£€æµ‹æ¡ä»¶[ğŸ–¼ï¸ å›¾ç‰‡](image/image_YYV--IbCqX.png "ğŸ–¼ï¸ å›¾ç‰‡")ä»¥åŠæ‰§è¡Œçš„è¡Œä¸ºç®€å•è¡¨æ ¼æ¥äº§ç”Ÿæµæ°´çº¿æ§åˆ¶é€»è¾‘çš„HCLæè¿°

Få¯„å­˜å™¨åªéœ€è¦Stall

å½“å‡ºç°Load/use hazardã€retä»¥åŠMispredictionå’ŒIDé˜¶æ®µçš„retç»„åˆçš„æƒ…å†µéœ€è¦stall Få¯„å­˜å™¨

```c
bool F_stall= 
  E_icode in {IMRMOVQ,IPOPQ} && E_dstM in {d_srcA,d_srcB}||IRET in {D_icode,E_icode,M_icode};
 //Mispreditedå’ŒIDé˜¶æ®µçš„RETç»„åˆèµ·æ¥ï¼Œæ˜¯ç­‰ä»·äºIRET==D_icodeçš„

```

Då¯„å­˜å™¨æ—¢éœ€è¦Stallä¹Ÿéœ€è¦Bubble

Då¯„å­˜å™¨éœ€è¦Stallæ˜¯åœ¨Load/use hazardä»¥åŠLoad/use hazardå’Œretç»„åˆçš„æƒ…å†µï¼Œå³æ˜¯Load/use hazardçš„æƒ…å†µï¼›éœ€è¦Bubbleçš„æƒ…å†µæ˜¯retå’Œmispredictedä»¥åŠretå’Œmispredictedçš„ç»„åˆï¼Œæ³¨æ„iretæ˜¯ä¸å’Œloadç»“åˆçš„

```c
bool D_stall=  E_icode in {IMRMOVQ,IPOPQ} && E_dstM in {d_srcA,d_srcB};

bool D_bubble = IRET in {D_icode,E_icode,M_code} && !(E_icode in {IMRMOVQ,IPOPQ} && E_dstM in {d_srcA,d_srcB}) || (E_icode==IJXX&&!e_cnd);
```

Eå¯„å­˜å™¨éœ€è¦Bubble

Eå¯„å­˜å™¨éœ€è¦Bubbleæ˜¯åœ¨Load/use hazardã€Mispredictedä»¥åŠloadå’Œretçš„ç»„åˆä»¥åŠmispredictedå’Œretçš„ç»„åˆï¼Œå› æ­¤æœ€åå°±æ˜¯loadå’Œmispredictedä¸¤ç§æƒ…å†µ

```c
bool E_bubble = E_icode in {IMRMOVQ,IPOPQ} && E_dstM in {d_srcA,d_srcB}|| (E_icode==IJXX&&!e_cnd);
```

Må¯„å­˜å™¨éœ€è¦Bubble

åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸå‘è®¿å­˜é˜¶æ®µæ’å…¥æ°”æ³¡ï¼Œéœ€è¦æ£€æŸ¥å½“å‰å‘¨æœŸä¸­è®¿å­˜æˆ–è€…å†™å›é˜¶æ®µæ˜¯å¦æœ‰å¼‚å¸¸

```c
bool M_bubble = W_stat in {ADR,INS,HLT} || m_stat in {ADR,INS,HLT};
```

Wå¯„å­˜å™¨éœ€è¦Stall

Wå¯„å­˜å™¨éœ€è¦Stallæ˜¯åœ¨å¼‚å¸¸åˆ°è¾¾WBé˜¶æ®µä¸‹

```c
bool W_stall = W_stat in {ADR,INS,HLT};
```

> æµ‹è¯•æ‰€å®Œæˆçš„è®¾è®¡
>
> ä¸€äº›è®¾è®¡ä¸Šçš„æŒ‘æˆ˜æ˜¯å¯¹ä¸å¸¸è§çš„æŒ‡ä»¤(popq %rsp)æˆ–è€…ä¸å¸¸è§çš„æŒ‡ä»¤ç»„åˆ(mispredicted branch+ret)
>
> ![](image/image_Wj4_wr3Vch.png)

## 4.5.9 Performance Analysis

éœ€è¦æµæ°´çº¿æ§åˆ¶é€»è¾‘é‡‡å–ç‰¹æ®Šæ“ä½œçš„æ¡ä»¶éƒ½ä¼šå¯¼è‡´æµæ°´çº¿è¾¾ä¸åˆ°æ¯ä¸ªæ—¶é’Ÿå‘¨æœŸå‘å‡ºæ–°æŒ‡ä»¤çš„ç›®æ ‡ã€‚å¯ä»¥é€šè¿‡ç¡®å®šbubbleæ’å…¥æµæ°´çº¿çš„é¢‘ç‡æ¥è¡¡é‡è¿™ç§ä½æ•ˆç‡ï¼Œå› ä¸ºbubbleæ˜¯ä¼šå¯¼è‡´æµæ°´çº¿ç©ºé—²â€”â€”retæŒ‡ä»¤éœ€è¦ä¸‰ä¸ªbubbleã€Mispredictedéœ€è¦ä¸¤ä¸ªbubbleã€Load/use hazardéœ€è¦ä¸€ä¸ªbubbleã€‚

è‡³äºè¡¡é‡è¿™ç§ä½æ•ˆç‡å¯¹æ•´ä½“æ€§èƒ½çš„å½±å“å¯ä»¥é€šè¿‡è®¡ç®—PIPEæ‰§è¡Œçš„æ¯æ¡æŒ‡ä»¤æ‰€éœ€çš„å¹³å‡æ—¶é’Ÿå‘¨æœŸçš„ä¼°è®¡å€¼â€”â€”CPIï¼ŒCPIæ˜¯æµæ°´çº¿å¹³å‡ååé‡IPCçš„å€’æ•°

å¦‚æœæˆ‘ä»¬å¿½ç•¥å¼‚å¸¸å¸¦æ¥çš„æ€§èƒ½æŸå¤±ï¼ˆå¼‚å¸¸çš„å®šä¹‰è¡¨æ˜å®ƒæ˜¯å¾ˆå°‘å‡ºç°çš„ï¼‰ï¼Œå¦ä¸€ç§æ€è€ƒCPIçš„æ–¹æ³•æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬åœ¨å¤„ç†å™¨ä¸Šè¿è¡ŒæŸä¸ªåŸºå‡†ç¨‹åºï¼Œå¹¶è§‚å¯Ÿæ‰§è¡Œé˜¶æ®µçš„è¿è¡Œã€‚æ¯ä¸ªå‘¨æœŸï¼Œæ‰§è¡Œé˜¶æ®µè¦ä¹ˆä¼šå¤„ç†ä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åè¿™æ¡æŒ‡ä»¤ç»§ç»­é€šè¿‡å‰©ä¸‹çš„é˜¶æ®µï¼Œç›´åˆ°å®Œæˆï¼›è¦ä¹ˆä¼šå¤„ç†ä¸€ä¸ªç”±äºä¸‰ç§ç‰¹æ®Šæƒ…å†µä¹‹ä¸€è€Œæ’å…¥çš„æ°”æ³¡ã€‚å¦‚æœè¿™ä¸ªé˜¶æ®µä¸€å…±å¤„ç†äº†$C_i$æ¡æŒ‡ä»¤å’Œ$ C_b  $ä¸ªæ°”æ³¡ï¼Œé‚£ä¹ˆå¤„ç†å™¨æ€»å…±éœ€è¦å¤§çº¦$C_i+C_b$ä¸ªæ—¶é’Ÿå‘¨æœŸæ¥æ‰§è¡ŒCæ¡æŒ‡ä»¤ã€‚æˆ‘ä»¬è¯´â€œå¤§çº¦â€æ˜¯å› ä¸ºå¿½è·¯äº†å¯åŠ¨æŒ‡ä»¤é€šè¿‡æµæ°´çº¿çš„å‘¨æœŸã€‚äºæ˜¯ï¼Œå¯ä»¥ç”¨å¦‚ä¸‹æ–¹æ³•æ¥è®¡ç®—è¿™ä¸ªåŸºå‡†ç¨‹åºçš„CPIï¼š

$$
\mathrm{CPI}=\frac{C_{i}+C_{b}}{C_{i}}=1.0+\frac{C_{b}}{C_{i}}
$$

å¤„ç½šé¡¹$C_b/C_i$è¡¨ç¤ºä¸€æ¡æŒ‡ä»¤å¹³å‡è¦æ’å…¥å¤šå°‘ä¸ªæ°”æ³¡ï¼Œå› ä¸ºå‰©ä¸‹çš„ä¸‰ç§ç‰¹æ®Šæƒ…å†µå‡åªèƒ½ç”±ä¸‰ç§æŒ‡ä»¤ç±»å‹å¼•èµ·ï¼Œä»è€Œå¯¼è‡´æ°”æ³¡çš„æ’å…¥ï¼Œå› æ­¤å¯ä»¥å°†å¤„ç½šé¡¹åˆ†è§£æˆä¸‰ä¸ªéƒ¨åˆ†

$$
\mathrm{CPI}=1.0+l p+m p+r p
$$

lpè¡¨ç¤ºç”±äºLoad/use hazardé€ æˆæ’å…¥æ°”æ³¡çš„å¹³å‡æ•°$lp=\frac{load/use hazardçš„æŒ‡ä»¤æ•°}{æŒ‡ä»¤æ€»æ•°}$
mpè¡¨ç¤ºç”±äºmispredictedé€ æˆæ’å…¥æ°”æ³¡çš„å¹³å‡æ•°$\frac{MispredictedæŒ‡ä»¤æ•°}{æ€»æŒ‡ä»¤æ•°}$
retè¡¨ç¤ºç”±äºretæŒ‡ä»¤é€ æˆæ’å…¥æ°”æ³¡çš„å¹³å‡æ•°$ \frac{retæŒ‡ä»¤æ•°}{æ€»æŒ‡ä»¤æ•°}  $

ä¸ºäº†ä¼°è®¡æ¯ç§å¤„ç½šï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ç›¸å…³æŒ‡ä»¤ï¼ˆåŠ è½½ã€æ¡ä»¶è½¬ç§»å’Œè¿”å›ï¼‰çš„å‡ºç°é¢‘ç‡ï¼Œä»¥åŠå¯¹æ¯ç§æŒ‡ä»¤ç‰¹æ®Šæƒ…å†µå‡ºç°çš„é¢‘ç‡ã€‚å¯¹CPIçš„è®¡ç®—ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹é¢è¿™ç»„é¢‘ç‡ï¼š

-   loadæŒ‡ä»¤(mrmovqå’Œpopq)å æ‰€æœ‰æ‰§è¡ŒæŒ‡ä»¤çš„25%ï¼Œå…¶ä¸­20%ä¼šå¯¼è‡´Load/use hazard
-   æ¡ä»¶åˆ†æ”¯æŒ‡ä»¤å æ‰€æœ‰æ‰§è¡ŒæŒ‡ä»¤çš„20%ï¼Œå…¶ä¸­60%ä¼šåˆ†æ”¯è·³è½¬ï¼Œè€Œ40%ä¸ä¼šåˆ†æ”¯è·³è½¬
-   è¿”å›æŒ‡ä»¤å æ‰€æœ‰æ‰§è¡ŒæŒ‡ä»¤çš„2%ã€‚

å› æ­¤å¯ä»¥ä¼°ç®—å½“å‰CPIï¼š

$$
CPI=1.0+0.25\times0.20\times1+0.20\times0.40\times2+0.02\times3=1.27
$$

![](image/image_0dc0q7FNiD.png)

å› ä¸ºç”±äºMispredicted branchå¯¼è‡´çš„å¤„ç½šæ‰€å çš„æ¯”ä¾‹0.16/0.27è¾ƒå¤§ï¼Œå› æ­¤å¯ä»¥å¢åŠ å¯¹é¢„æµ‹åˆ†æ”¯çš„å¤„ç†ï¼Œæé«˜é¢„æµ‹çš„å‡†ç¡®ç‡ï¼Œé™ä½è¿™ä¸€é¡¹çš„å¤„ç½š

## 4.5.10 Unfinished Business

ç›®å‰è®¾è®¡çš„PIPEå·²å®ç°æŒ‡ä»¤æµæ°´çº¿ä»¥åŠç‰¹æ®Šæƒ…å†µçš„æ§åˆ¶ï¼Œä½†æ˜¯è¦è¾¾åˆ°ä¸€ä¸ªç°ä»£å®ç”¨çš„å¤„ç†å™¨ï¼Œè¿˜ç¼ºä¹ä¸€äº›ç‰¹å¾ï¼Œæ¯”å¦‚ä¸‹é¢æ‰€å™è¿°çš„å¤šå‘¨æœŸæŒ‡ä»¤å’Œä¸å­˜å‚¨ç³»ç»Ÿçš„æ¥å£

#### å¤šå‘¨æœŸæŒ‡ä»¤

#### ä¸å­˜å‚¨ç³»ç»Ÿçš„æ¥å£

[^æ³¨é‡Š1]: ä½¿ç”¨æ±‡ç¼–è¯­è¨€æˆ–è€…æœºå™¨è¯­è¨€ç¼–å†™ç¨‹åºçš„ç¨‹åºå‘˜

[^æ³¨é‡Š2]: å…è®¸éç‹¬å é€‰æ‹©è¡¨è¾¾å¼ä½¿ HCL ä»£ç æ›´å…·å¯è¯»æ€§ã€‚å®é™…çš„ç¡¬ä»¶å¤šè·¯å¤ç”¨å™¨å¿…é¡»å…·æœ‰äº’æ–¥çš„ä¿¡å·æ¥æ§åˆ¶å“ªä¸ªè¾“å…¥å­—åº”ä¼ é€’åˆ°è¾“å‡ºï¼Œå¦‚å›¾ 4.13 ä¸­çš„ä¿¡å· s å’Œ !sã€‚è¦å°† HCL æ¡ˆä¾‹è¡¨è¾¾å¼è½¬æ¢ä¸ºç¡¬ä»¶ï¼Œé€»è¾‘ç»¼åˆç¨‹åºéœ€è¦åˆ†æé€‰æ‹©è¡¨è¾¾å¼é›†ï¼Œå¹¶é€šè¿‡ç¡®ä¿ä»…é€‰æ‹©ç¬¬ä¸€ä¸ªåŒ¹é…æ¡ˆä¾‹æ¥è§£å†³ä»»ä½•å¯èƒ½çš„å†²çª

[^æ³¨é‡Š3]: ç»„åˆé€»è¾‘ç”Ÿæˆerror

[^æ³¨é‡Š4]: movç±»æŒ‡ä»¤çš„ä¸€ä¸ªæ“ä½œæ•°æ˜¯0

[^æ³¨é‡Š5]: æ¯”å¦‚ALUçš„å¤ç”¨

[^æ³¨é‡Š6]: å½“PCçš„å€¼è¶…å‡ºå†…å­˜å¯»å€èŒƒå›´

[^æ³¨é‡Š7]: instrå’Œimem\_errorå¯ä»¥ç”¨æ¥ç”Ÿæˆå­˜å‚¨å™¨ä¸­çš„StatçŠ¶æ€å­—

[^æ³¨é‡Š8]: å› ä¸ºåœ¨åˆ†å‰²çš„ç»„åˆé€»è¾‘å—ä¹‹é—´æ’å…¥äº†æ—¶é’Ÿå¯„å­˜å™¨

[^æ³¨é‡Š9]: "-"åæ˜ äº†è¿™ä¸€å®ç°çš„å¤„ç†å™¨æ€§èƒ½ç•¥ä½äºæœ€ç»ˆå®ç°çš„å¤„ç†å™¨æ€§èƒ½

[^æ³¨é‡Š10]: å¢åŠ çš„ç›®çš„æ˜¯ä¸ºäº†å‡å°‘Eå’ŒMæµæ°´çº¿å¯„å­˜å™¨ä¹‹é—´çš„ä¼ é€’å­—æ®µæ•°é‡

[^æ³¨é‡Š11]: å…¥æ ˆ

[^æ³¨é‡Š12]: å‘åä¼ é€’åˆ°å†™å›é˜¶æ®µvalP+0->valE

[^æ³¨é‡Š13]: The decode stage only needs to generate signals valA and valB by the end of the clock cycle so that pipeline register E can be loaded with the results from the decode stage as the clock rises to start the next cycle. The ALU output will be valid before this point.

[^æ³¨é‡Š14]: åœ¨PIPE-ä¸Šå¢åŠ äº†ä½¿ç”¨Forwardè§£å†³æ•°æ®å†’é™©

[^æ³¨é‡Š15]: å¹¶æœªè¿›å…¥EXEé˜¶æ®µ

[^æ³¨é‡Š16]: æœ‰æ—¶ä¹Ÿå«åšinstruction squashing

[^æ³¨é‡Š17]: icodeå’Œifuncçš„ç»„åˆæ˜¯æ— æ•ˆçš„

[^æ³¨é‡Š18]: å–æŒ‡æˆ–è€…è¯»å†™æ•°æ®çš„åœ°å€æ˜¯è¶Šç•Œçš„

[^æ³¨é‡Š19]: é€‰æµæ°´çº¿æœ€æ·±çš„å¼‚å¸¸æŒ‡ä»¤å¼•èµ·çš„å¼‚å¸¸

[^æ³¨é‡Š20]: è§£å†³subtlety1

[^æ³¨é‡Š21]: subtlety2

[^æ³¨é‡Š22]: subtlety3

[^æ³¨é‡Š23]: å› ä¸ºæ‰§è¡Œé˜¶æ®µè¦åˆ¤æ–­cmovæ˜¯å¦æˆç«‹ï¼Œéœ€è¦å†æ¬¡äº§ç”ŸdstEä¿¡å·

[^æ³¨é‡Š24]: MEMæ®µéœ€è¦æ ¹æ®è®¿æ•°æ®å†…å­˜åœ°å€é‡æ–°è®¡ç®—Statå› æ­¤æ˜¯m\_stat

[^æ³¨é‡Š25]: åœ¨valAå’ŒvalPä¸­äºŒé€‰ä¸€

[^æ³¨é‡Š26]: d\_srcAå’Œd\_srcBä¸E\_dstMæœ‰ç›¸ç­‰ï¼Œä¸”E\_icodeæ˜¯IMRMOVQï¼ŒIPOPQ

[^æ³¨é‡Š27]: For example, to inject a bubble into pipeline register D, we want the icode field to be set to the constant value INOP (Figure 4.26). To inject a bubble into pipeline register E, we want the icode field to be set to INOP and the dstE, dstM, srcA, and srcB fields to be set to the constant RNONE.

[^æ³¨é‡Š28]: å¼‚å¸¸æŒ‡ä»¤ä¹‹å‰çš„æ­£å¸¸æ‰§è¡Œï¼Œå¼‚å¸¸æŒ‡ä»¤ä¹‹åçš„ä¸èƒ½ä¿®æ”¹ç¨‹åºçŠ¶æ€
